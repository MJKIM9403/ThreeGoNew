<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Bootstrap icons-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
          type="text/css"/>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Noto+Sans+KR:wght@100;200;300;400;500;600;700;800;900&display=swap"
          rel="stylesheet">
    <!-- Core theme CSS (includes Bootstrap)-->

    <link href="../assets/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="../assets/css/style.css?after" rel="stylesheet"/>
    <link href="../assets/css/commonstyle.css?after" rel="stylesheet"/>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- bootstrap datepicker cdn -->
    <!-- datepicker 는 jquery 1.7.1 이상 bootstrap 2.0.4 이상 버전이 필요함 -->
    <!-- jQuery가 먼저 로드 된 후 datepicker가 로드 되어야함.-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/css/bootstrap-datepicker.min.css" integrity="sha512-34s5cpvaNG3BknEWSuOncX28vz97bRI59UnVtEEpFX536A7BtZSJHsDyFoCl8S7Dt2TPzcrCEoHBGeM4SUBDBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/js/bootstrap-datepicker.min.js" integrity="sha512-LsnSViqQyaXpD4mBBdRYeP6sRwJiJveh2ZIbW41EBrNmKxgr/LFZIiWT6yr+nycvhvauz8c2nYMhrP80YhG7Cw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/locales/bootstrap-datepicker.ko.min.js" integrity="sha512-L4qpL1ZotXZLLe8Oo0ZyHrj/SweV7CieswUODAAPN/tnqN3PA1P+4qPu5vIryNor6HQ5o22NujIcAZIfyVXwbQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <title>Title</title>



    <style>
        .map-result {
            z-index: 1000;
        }

        .container-fluid {
            --bs-gutter-x: 0 !important;
        }

        .outer {
            border-left: 2px solid #333;
        }

        .content {
            position: relative;
            margin: 0 0 20px 20px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            flex-direction: row;
            display: flex;
            justify-content: space-between;
        }

        .info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .title:before {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            background: #0d6efd;
            border-radius: 999px;
            left: -3.25rem;
            border: 3px solid #0d6efd;
        }

        .planContainer {
            padding: 20px 0 20px 20px;
        }

        div#day-btns {
            flex-direction: column;
            display: flex;
            width: 300px;
            gap: 10px;
        }
        div#list {
            flex-direction: row;
            display: flex;
            gap: 100px;
        }
        div#plan-list {
            width: 100%;
        }

        #open-share-btn {
            bottom: 5%;
            right: 5%;
        }

        #right-btn {
            position: absolute;
            right: 10px;
        }

        .delete-user-btn, .delete-list-btn {
            background: #808080;
            padding: 0;
            border: none;
            color: #fff;
        }
        .delete-user-btn:hover, .delete-list-btn:hover {
            background-color: #808080;
            color: #fff;
        }
        div#resultBox {
            flex-direction: row;
            display: flex;
            gap: 0.5rem;
        }
        .touritem-img {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
        }

        .grant {
            background: #808080;
            color: #fff;
            font-size: 13px;
        }
    </style>
</head>
<body>
<script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=aDVWgep9DE8rL7yokAybK6jrQIiAk9Ln9jI9CTyf"></script>
<script th:inline="javascript">
    // 로그인 된 나의 아이디
    var myId = [[${userId}]];

    // 플래너의 ID
    var plannerId = [[${plannerId}]];

    // 날짜
    var days = [[${daysBetween+1}]];

    // 인덱스
    var index;
    // 이전에 선택된 탭의 인덱스를 저장하는 변수
    var previousTabIndex = -1; // 초기값 설정, 아무런 탭도 선택되지 않았음을 나타냄

    // tmap api
    var map;

    // 마커
    var marker = [];

    // 찍은 모든 마커
    var viaMarkers = Array.from({length: days}, () => []);

    // 경유지만 넣는 배열
    var viaPoints = Array.from({length: days}, () => []);

    // 지도 범위 확대하기 위한 배열
    var Points = Array.from({length: days}, () => []);

    // 경유지 최적화 실행 시간
    var startTime = getRealTime();

    // 관광지들
    var places = Array.from({length: days}, () => []);

    // 내가 선택한 관광지
    var place;

    // 경로그림정보
    var drawInfoArr = Array.from({length: days}, () => []);
    var resultInfoArr = Array.from({length: days}, () => []);

    // 경로 출력 결과
    var resultText = Array.from({length: days}, () => []);

    // 앱키
    const appKey = "aDVWgep9DE8rL7yokAybK6jrQIiAk9Ln9jI9CTyf";

    // 검색창에 입력한 아이디
    let typedText = "";

    // 로드된 plannerId를 작성한 유저가 지금 로그인한 유저가 맞는지
    let isWriter = [[${exists}]];

    // 검색을 위한 변수
    var searchTimer;





    // 페이지 로드 시 실행되는 코드
    $(document).ready(function() {
        // 처음으로 첫 번째 날짜의 계획을 로드
        loadPlanForDay(1);

        // 날짜 버튼 클릭 시 실행되는 이벤트 핸들러
        $('.dayButton').click(function() {
            var day = $(this).attr('data-day');
            loadPlanForDay(day);
        });

        openModal();
        searchUser();
        share();
        deleteList();
        hideModal();
        deleteGuest();
    });

    // 공유하기 모달창 열기
    function openModal() {
        $('#open-share-btn').click(function () {
            if(isWriter == false){
                alert("플랜을 작성한 사람만 공유할 수 있습니다.")
            } else {
                $('#shareModal').modal('show');
            }
        })
    }

    function searchUser() {
        $('#searchInput').on('keyup', function () {
            typedText = $(this).val();
            if(typedText == "") {
                $('#searchResult').hide();
            }

            $('#searchResult').show();
            $('#typedText').show();
            $('#typedText').text(typedText);

            $.ajax({
                url: "/api/users/search?userId=" + typedText,
                type: "GET",
                success: function (result) {
                    console.log(result);

                    let button = "<button id='right-btn' class='btn btn-sm btn-outline-dark' ";
                    if (result.id == typedText) {
                        // 나 자신은 추가할 수 없다
                        if(result.id == myId) {
                            alert("본인은 추가할 수 없습니다.");
                            $('#right-btn').remove();
                        } else {
                            // 입력한 아이디가 내 아이디가 아니라면
                            // 이미 초대받은 게스트인지 확인
                            $.ajax({
                                url: `/api/checkInvitation/${plannerId}/${result.id}`,
                                type: "GET",
                                success: function (response) {
                                    if (!response.invited) { // 초대되지 않은 게스트일 경우에만 버튼 추가
                                        button += "onclick='printUser(\"" + result.id + "\")'>추가하기</button>";
                                        $('#searchResult').append(button);
                                    } else {
                                        alert("이미 초대된 게스트입니다.");
                                    }
                                },
                                error: function (xhr, status, error) {
                                    console.error("에러 발생:", error);
                                    $('#right-btn').remove();
                                }
                            });
                        }
                    }
                },
                error: function (xhr, status, error) {
                    if (xhr.status == 404) { // 서버에서 유저 정보가 없는 경우
                        $('#typedText').text("유저정보가 없습니다.");
                        $('#right-btn').remove();
                    } else { // 그 외의 서버 통신 오류
                        console.error("에러 발생:", error);
                        $('#typedText').text("서버와의 통신 중 문제가 발생했습니다.");
                        $('#right-btn').remove();
                    }
                }
            });
        });
    }

    function printUser(id) {
        let button = `<div>
                        <button class='btn btn-sm btn-dark user-btn' data-user-id='${id}'>${id}</button>
                        <button class='btn delete-list-btn'>
                            <i class='bi bi-x'></i>
                        </button>
                       </div>`;
        $('#resultBox').show();
        $('#resultBox').prepend(button);
    }

    function deleteList() {
        $('#resultBox').on('click', '.delete-list-btn', function() {
            $(this).closest('div').remove();
        });
    }

    function deleteGuest() {
        $('.delete-user-btn').on('click', function() {
            const guestId = this.previousElementSibling.getAttribute('data-user-id');
            if(confirm(`삭제하면 더 이상 일정을 공유할 수 없게 됩니다. 정말 ${guestId} 님을 초대받은 친구에서 삭제하시겠습니까?`)) {
                $.ajax({
                    url: `/api/removeGuest/${plannerId}/${guestId}`,
                    type: 'DELETE',
                    data: {
                        plannerId: plannerId,
                        guestId: guestId
                    },
                    success: function (response) {
                        alert(`초대받은 친구에서 ${guestId}님이 성공적으로 삭제되었습니다.`);
                        $('#shareModal').modal('hide');
                        location.reload(); // 페이지를 새로고침하여 변경사항 반영
                    },
                    error: function(xhr, status, error) {
                        alert("오류가 발생했습니다:" + error);
                    }
                })
            }
        })
    }


    function share() {
        $('#share-btn').on('click', function () {
            var plannerId = [[${plannerId}]]; // Planner ID를 설정합니다.
            var ownerId = [[${userId}]]; // Owner ID를 설정합니다.
            var userIds = [];
            $('#resultBox .user-btn').each(function() {
                userIds.push($(this).text()); // 버튼의 텍스트(ID)를 배열에 추가
            });

            var dataToSend = {
                plannerId: plannerId,
                ownerId: ownerId,
                sharedWithUserIds: userIds
            };

            // 각 사용자의 ID를 쉼표로 구분하여 출력
            var userIdsString = userIds.join("님, ");
            var confirmMessage = userIdsString + "님 에게 공유하시겠습니까?";

            // 확인 대화상자를 통해 공유를 확인한 후에만 나머지 코드를 실행
            if (confirm(confirmMessage)) {
                // AJAX를 사용하여 userIds를 서버로 POST 방식으로 전송
                $.ajax({
                    url: '/api/sharePlanner', // 요청을 보낼 서버의 URL 주소
                    type: 'POST', // HTTP 요청 방식 (GET, POST 등)
                    contentType: 'application/json', // 전송할 데이터의 MIME 타입
                    data: JSON.stringify(dataToSend), // 서버로 보낼 데이터. JSON 문자열로 변환.
                    success: function (response) { // 요청 성공 시 수행할 함수
                        alert('초대가 성공적으로 완료되었습니다.');
                        $('#shareModal').modal('hide');
                        location.reload();
                    },
                    error: function (xhr, status, error) { // 요청 실패 시 수행할 함수
                        alert('초대 과정에서 오류가 발생했습니다: ' + error);
                        // 실패 시 추가적인 로직 처리...
                    }
                });
            } else {
                alert('공유를 취소하였습니다.');
            }
        });
    }

    function hideModal() {
        $('#shareModal').on('hidden.bs.modal', function () {
            // 모달 내용 초기화
            $('#searchInput').val(''); // 검색창 초기화
            $('#typedText').text(''); // 검색 결과 초기화
            $('#searchResult').hide(); // 검색 결과 숨기기
            $('#resultBox').empty().hide(); // 선택된 유저 목록 초기화 및 숨기기
        });
        // $('#shareModal').modal('hide');
    };




    // 다른 유저에게 공유하기
    // function share(id) {
    //     const myId = [[${userId}]];
    //     if(id == myId) {
    //         alert('본인에게 공유할 수 없습니다. 다른 사람의 아이디를 입력하세요.');
    //     }
    //     if(confirm(id+'님에게 일정을 공유하시겠습니까?')) {
    //
    //     }
    // }

    // 특정 날짜의 계획을 로드하는 함수
    function loadPlanForDay(day) {
        var plannerId = $('.timeline').attr('data-pid');

        $.ajax({
            type: "POST",
            url: "/api/showplan",
            contentType: 'application/json; charset=UTF-8',
            data: JSON.stringify({
                "plannerId": plannerId,
                "day": day
            }),
            success: function(response) {
                // 응답으로 받은 계획을 표시
                displayPlan(response);
            },
            error: function(xhr, status, error) {
                console.error(error);
            }
        });
    }

    // 계획을 표시하는 함수
    function displayPlan(planList) {
        $('.plan').empty(); // 계획을 비우고 다시 채움
        let currentDay = 0; // 현재의 'day'를 추적

        $.each(planList, function(index, plan) {
            // 새로운 일차가 시작될 때만 일차 정보를 출력
            if (plan.day !== currentDay) {
                var dayTemplate = `<h4 class="mb-1">${plan.day}일차</h4>`;
                $('.plan').append(dayTemplate);
                currentDay = plan.day; // 일차 업데이트
            }

            // dtoList의 각 항목에 대한 정보 출력
            $.each(plan.dtoList, function(i, dto) {
                var template = `
                                <div class="timeline" data-pid="${plan.plannerId}">
                                    <div class="outer planContainer">
                                        <div>
                                            <a href="/info/content/${dto.contentid}" class="list-group-item list-group-item-action" aria-current="true">
                                                <div class="content">
                                                    <div class="info">
                                                        <h5 class="mb-1 title">${dto.title}</h5>
                                                        <p class="mb-1">${dto.address}</p>
                                                        <p class="mb-1">${dto.fullCategoryName}</p>
                                                        <input type="hidden" value="${dto.mapx}">
                                                        <input type="hidden" value="${dto.mapy}">
                                                    </div>
                                                    <div class="img">
                                                        <img class="touritem-img" src="${dto.firstimage}">
                                                    </div>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            `;
                $('.plan').append(template);


                place = {
                    title: dto.title,
                    contentid: dto.contentid,
                    mapx: dto.mapx,
                    mapy: dto.mapy
                }
                console.log(place);
                // place에 잘 담기는지 확인

                // 중복이 아닐 경우에만 관광지 목록에 내가 선택한 관광지를 추가한다.
                places[plan.day - 1].push(place);
                for(var i = 0; i<places[plan.day - 1].length; i++) {
                    addMarker(i+1, places[plan.day - 1][i])
                }
            });
        });
    }

    // 마커 추가하기 함수
    function addMarker(status, info) {
        // status 에 따라 아이콘 바꾸기
        imgUrl = `https://tmapapi.tmapmobility.com/upload/tmap/marker/pin_b_m_${status}.png`;

        // 관광지 목록에 추가한 대로 marker 생성
        marker = new Tmapv2.Marker({
            position: new Tmapv2.LatLng(info.mapy, info.mapx),
            icon: imgUrl,
            iconSize: new Tmapv2.Size(24, 38),
            map: map,
            title: info.title
        })
        viaMarkers[index].push(marker);

        // 마커 위치에 맞게 지도 줌
        Points[index].push(new Tmapv2.LatLng(info.mapy, info.mapx));
        console.log(Points[index]);
        PTbounds = new Tmapv2.LatLngBounds();
        if(Points[index]) {
            for(var i in Points[index]) {
                var linePt = new Tmapv2.LatLng(Points[index][i]._lat, Points[index][i]._lng);
                PTbounds.extend(linePt);
            }
            map.fitBounds(PTbounds);
        }



    }


    document.addEventListener("DOMContentLoaded", function () {
        // 각 탭 요소들을 선택
        var tabs = document.querySelectorAll('.dayButton');
        // 첫 번째 탭을 활성화하고 해당 내용을 보이도록 설정
        index = 0;

        // 각 탭에 대해 클릭 이벤트 리스너 추가
        tabs.forEach(function (tab, tabIndex) {
            tab.addEventListener('click', function () {
                // 현재 선택한 탭의 일련 번호를 가져옴
                var dayNumber = tab.innerText.split(' ')[1]; // 탭 텍스트에서 'Day'를 제외하고 숫자만 추출
                index = Number(dayNumber) - 1;

                // 다른 탭으로 이동할 경우
                if(previousTabIndex !== -1 && previousTabIndex !== index) {
                    viaMarkers[previousTabIndex].forEach(function(marker) {
                        marker.setMap(null); // TMap에서 이전 탭 마커 제거
                    });
                    viaMarkers[previousTabIndex] = []; // 등록된 마커 배열도 초기화
                    Points[previousTabIndex] = []; // 지도 확대를 위한 배열도 초기화
                    places[previousTabIndex] = []; // 장소 배열도 초기화
                    resultInfoArr[previousTabIndex].forEach(function(line) {
                        line.setMap(null); // TMap에서 이전 탭 경로 빨간 선 제거
                    })
                    // if(viaMarkers != null) {
                    //     for (var i=0; i<viaMarkers[index].length; i++) {
                    //     }
                    // }

                    $(".result").text(""); // 총 거리, 시간, 요금 결과 제거
                } else if (previousTabIndex === -1) {
                    // 첫 번째 탭에서 다른 탭으로 이동하는 경우
                    viaMarkers[0].forEach(function(marker) {
                        marker.setMap(null);
                    });
                    viaMarkers[0] = []; // 등록된 마커 배열도 초기화
                    places[0] = []; // 장소 배열도 초기화
                    Points[0] = []; // 지도 확대를 위한 배열도 초기화
                    if (resultInfoArr[0] && resultInfoArr[0].length > 0) {
                        resultInfoArr[0].forEach(function(line) {
                            line.setMap(null);
                        });
                    }
                }

                // // 선택한 인덱스 탭에 맞는 마커를 다시 로드
                // viaMarkers[index].forEach(function(marker) {
                //     marker.setMap(map);
                // });
                // // 선택한 인덱스 탭에 맞는 경로 빨간 선 표시를 다시 로드
                // resultInfoArr[index].forEach(function(line) {
                //     line.setMap(map);
                // })
                // 선택한 인덱스 탭에 맞는 총 거리, 시간, 요금 결과를 다시 로드
                $(".result").text(resultText[index]); // 총 거리, 시간, 요금 결과 제거

                // 모든 마커 로드를 완료한 후 이전 인덱스를 현재 인덱스로 바꾸기
                previousTabIndex = index;
            });
        });
    });


    // 현재 시간을 토대로 이동에 걸리는 시간을 구합니다.
    function getRealTime() {
        var date = new Date();
        var year = date.getFullYear();
        var month = ('0' + (date.getMonth() + 1)).slice(-2);
        var day = ('0' + (date.getDate())).slice(-2);
        var hour = ('0' + (date.getHours())).slice(-2);
        var minute = ('0' + (date.getMinutes())).slice(-2);

        var currentDate = year + month + day + hour + minute
        console.log(currentDate);
        return currentDate;
    }

    // tmap 실행
    $(document).ready(function() {
        initTmap();
    })

    function initTmap() {
        map = new Tmapv2.Map("map_div", {
            center: new Tmapv2.LatLng(36.4109466, 128.1590828),
            width: "100%",
            height: "400px",
            zoom: 8,
            zoomControl: true,
            scrollwheel: true
        });

        // 최적화 버튼을 누르면 ajax 실행
        $(".btn_optimize").click(function () {
            // 마커가 3곳 이상이 아니면 실행되지 않도록 막음
            if(viaMarkers[index].length < 3) {
                alert('경유지는 1개 이상이어야합니다.');
                return false;
            } else {
                var headers = {};
                headers["appKey"] = appKey;

                viaPoints[index] = []; // 이전 viaPoints[index] 배열을 날리고

                // 시작 장소와 종료 장소
                var start_Mapx = viaMarkers[index][0]._marker_data.options.position._lng;
                var start_Mapy = viaMarkers[index][0]._marker_data.options.position._lat;
                var end_Mapx = viaMarkers[index][viaMarkers[index].length-1]._marker_data.options.position._lng;
                var end_Mapy = viaMarkers[index][viaMarkers[index].length-1]._marker_data.options.position._lat;

                // 마커에 찍힌 경유지를 새로 받는다
                for(var i = 1; i<viaMarkers[index].length-1; i++) {
                    // 하나하나 선택한 경유지
                    var viaPoint = {};
                    viaPoint.viaPointId = i+"경유지";
                    viaPoint.viaPointName = viaMarkers[index][i]._marker_data.options.title;
                    viaPoint.viaX = viaMarkers[index][i]._marker_data.options.position._lng.toString();
                    viaPoint.viaY = viaMarkers[index][i]._marker_data.options.position._lat.toString();
                    console.log("viaPoint : " + viaPoint);

                    viaPoints[index].push(viaPoint); // 지금 담겨진 경로를 viaPoints[index] 에 담는다.
                }
                console.log(viaPoints[index]);


                $.ajax({
                    type: "POST",
                    headers: headers,
                    url: "https://apis.openapi.sk.com/tmap/routes/routeOptimization20?version=1&format=json",
                    async: false,
                    contentType: "application/json",
                    data: JSON.stringify({
                        "startName": "출발",
                        "startX": start_Mapx.toString(),
                        "startY": start_Mapy.toString(),
                        "startTime": startTime,
                        "endName": "도착",
                        "endX": end_Mapx.toString(),
                        "endY": end_Mapy.toString(),
                        "viaPoints": viaPoints[index],
                        "reqCoordType" : "WGS84GEO",
                        "resCoordType" : "EPSG3857"
                    }),
                    success:function(response){
                        var resultData = response.properties;
                        var resultFeatures = response.features;

                        // 결과 출력
                        var tDistance = "총 거리 : " + (resultData.totalDistance/1000).toFixed(1) + "km,  ";
                        var tTime = "총 시간 : " + (resultData.totalTime/60).toFixed(0) + "분,  ";
                        var tFare = "총 요금 : " + resultData.totalFare + "원";

                        resultText[index] = tDistance+tTime+tFare;
                        $(".result").text(resultText[index]);

                        // 기존 라인 초기화
                        if(resultInfoArr[index].length > 0){
                            for(var i in resultInfoArr[index]){
                                resultInfoArr[index][i].setMap(null);
                            }
                            resultInfoArr[index]=[];
                        }

                        for(var i in resultFeatures) {
                            var geometry = resultFeatures[i].geometry;
                            var polyline_ = Array.from({length: days}, () => []);

                            drawInfoArr[index] = [];

                            if(geometry.type == "LineString") {
                                for(var j in geometry.coordinates){
                                    // 경로들의 결과값(구간)들을 포인트 객체로 변환
                                    var latlng = new Tmapv2.Point(geometry.coordinates[j][0], geometry.coordinates[j][1]);
                                    // 포인트 객체를 받아 좌표값으로 변환
                                    var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(latlng);
                                    // 포인트객체의 정보로 좌표값 변환 객체로 저장
                                    var convertChange = new Tmapv2.LatLng(convertPoint._lat, convertPoint._lng);

                                    drawInfoArr[index].push(convertChange);
                                }

                                polyline_[index] = new Tmapv2.Polyline({
                                    path : drawInfoArr[index],
                                    strokeColor : "#FF0000",
                                    strokeWeight: 6,
                                    map : map
                                });
                                resultInfoArr[index].push(polyline_[index]);

                                // 경유지 최적화 결과 반경만큼 지도 레벨 조정
                                // var newData = geoData[0];
                                // PTbounds = new Tmapv2.LatLngBounds();
                                // for (var i = 0; i < newData.length; i++) {
                                //     var mData = newData[i];
                                //     var type = mData.geometry.type;
                                //     var pointType = mData.properties.pointType;
                                // }
                            }
                        }
                    },
                    error:function(request,status,error){
                        console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                    }
                });
            }
        })



        // 경로 보기 버튼을 누르면 ajax 실행
        $(".btn_route").click(function () {
            // 마커가 3곳 이상이 아니면 실행되지 않도록 막음
            if(viaMarkers[index].length < 3) {
                alert('경유지는 1개 이상이어야합니다.');
                return false;
            } else {
                var headers = {};
                headers["appKey"] = appKey;

                viaPoints[index] = []; // 이전 viaPoints[index] 배열을 날리고

                // 시작 장소와 종료 장소
                var start_Mapx = viaMarkers[index][0]._marker_data.options.position._lng;
                var start_Mapy = viaMarkers[index][0]._marker_data.options.position._lat;
                var end_Mapx = viaMarkers[index][viaMarkers[index].length-1]._marker_data.options.position._lng;
                var end_Mapy = viaMarkers[index][viaMarkers[index].length-1]._marker_data.options.position._lat;

                // 마커에 찍힌 경유지
                for(var i = 1; i<viaMarkers[index].length-1; i++) {
                    var viaPoint = {};
                    viaPoint.viaPointId = i+"경유지";
                    viaPoint.viaPointName = viaMarkers[index][i]._marker_data.options.title;
                    viaPoint.viaX = viaMarkers[index][i]._marker_data.options.position._lng.toString();
                    viaPoint.viaY = viaMarkers[index][i]._marker_data.options.position._lat.toString();
                    console.log(viaPoint);

                    viaPoints[index].push(viaPoint); // 지금 담겨진 경로를 viaPoints[index] 에 담는다.
                }
                console.log(viaPoints[index]);


                $.ajax({
                    type: "POST",
                    headers: headers,
                    url: "https://apis.openapi.sk.com/tmap/routes/routeSequential30?version=1&format=json",
                    async: false,
                    contentType: "application/json",
                    data: JSON.stringify({
                        "startName": "출발",
                        "startX": start_Mapx.toString(),
                        "startY": start_Mapy.toString(),
                        "startTime": startTime,
                        "endName": "도착",
                        "endX": end_Mapx.toString(),
                        "endY": end_Mapy.toString(),
                        "viaPoints": viaPoints[index]
                    }),
                    success:function(response){
                        var resultData = response.properties;
                        var resultFeatures = response.features;

                        // 결과 출력
                        var tDistance = "총 거리 : " + (resultData.totalDistance/1000).toFixed(1) + "km,  ";
                        var tTime = "총 시간 : " + (resultData.totalTime/60).toFixed(0) + "분,  ";
                        var tFare = "총 요금 : " + resultData.totalFare + "원";

                        resultText[index] = tDistance+tTime+tFare;
                        $(".result").text(resultText[index]);

                        // 기존 라인 초기화
                        if(resultInfoArr[index].length > 0){
                            for(var i in resultInfoArr[index]){
                                resultInfoArr[index][i].setMap(null);
                            }
                            resultInfoArr[index]=[];
                        }

                        for(var i in resultFeatures) {
                            var geometry = resultFeatures[i].geometry;
                            var polyline_;

                            drawInfoArr[index] = [];

                            if(geometry.type == "LineString") {
                                for(var j in geometry.coordinates){
                                    var point = new Tmapv2.LatLng(geometry.coordinates[j][1],geometry.coordinates[j][0]);

                                    drawInfoArr[index].push(point);
                                }

                                polyline_ = new Tmapv2.Polyline({
                                    path : drawInfoArr[index],
                                    strokeColor : "#FF0000",
                                    strokeWeight: 6,
                                    map : map
                                });
                                resultInfoArr[index].push(polyline_);


                                // 경유지 최적화 결과 반경만큼 지도 레벨 조정
                                // var newData = geoData[0];
                                // PTbounds = new Tmapv2.LatLngBounds();
                                // for (var i = 0; i < newData.length; i++) {
                                //     var mData = newData[i];
                                //     var type = mData.geometry.type;
                                //     var pointType = mData.properties.pointType;
                                // }
                            }
                        }
                    },
                    error:function(request,status,error){
                        console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                    }
                });
            }
        })



    }

</script>
<!-- Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" role="dialog" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog  modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">일정을 공유할 친구를 선택해주세요.</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                    <div style="height: 60px;" th:if="${guestList.size() > 0}">
                        <div id="guestList">
                            공유중인 친구
                        <th:block th:each="guest, idx : ${guestList}">
                            <button class="btn btn-sm btn-dark user-btn" th:data-user-id="${guest.id}" th:text="${guest.id}"></button>
                            <button class="btn delete-user-btn">
                                <i class="bi bi-x"></i>
                            </button>
                        </th:block>
                        </div>
                    </div>
                    <!--선택한 유저의 목록이 보일 창-->
                    <div style="height: 60px;">
                        <div id="resultBox" style="display: none;">
                        </div>
                    </div>
                    <!--검색창-->
                    <input id="searchInput" name="searchInput" type="text" class="form-control" placeholder="유저 아이디를 검색하세요.">
<!--                    <i class="bi bi-search"></i>-->
                    <!--유저의 검색결과가 보일 창-->
                    <div style="height: 60px;">
                        <div class="alert alert-success" id="searchResult" style="display: none;">
                            <span id="typedText"></span>
                        </div>
                    </div>

            </div>
            <div class="modal-footer">
                <button type="button" id="share-btn" class="btn btn-primary">초대하기</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>






<div class="d-flex flex-nowrap">
    <th:block th:replace="~{fragments/sidebar}"></th:block>
    <div class="container mt-5">
        <div class="d-flex flex-row gap-2">
            <th:block th:each="member, idx : ${teamList}">
                <div th:if="${member.teamLevel == 9}">
                    <a th:href="@{/mypage/{userId}(userId=${member.user.id})}">
                        <button class="btn btn-sm btn-dark user-btn" th:data-user-id="${member.user.id}" th:text="${member.user.id}"></button>
                        <div class="grant rounded-pill d-flex justify-content-center">host</div>
                    </a>
                </div>
                <div th:if="${member.teamLevel == 0}">
                    <a th:href="@{/mypage/{userId}(userId=${member.user.id})}">
                        <button class="btn btn-sm btn-dark user-btn" th:data-user-id="${member.user.id}" th:text="${member.user.id}"></button>
                        <div class="grant rounded-pill d-flex justify-content-center">guest</div>
                    </a>
                </div>
            </th:block>
        </div>

        <p class="team-list" th:title="${teamList}"></p>
        <div id="map" class="d-flex flex-column align-items-stretch default">
            <div class="map-result position-absolute">
                <p class="result"></p>
                <button class="btn btn-primary btn_route">경로 확인</button>
                <button class="btn btn-primary btn_optimize">동선 추천</button>
            </div>
            <div id="map_div">
            </div>
        </div>



        <div class="container-fluid">
            <div id="list">
                <div id="day-btns">
                    <th:block th:each="i : ${#numbers.sequence(0, daysBetween)}">
                        <button class="btn btn-dark dayButton active" th:data-day="${i + 1}" th:text="'Day ' + ${i + 1}">Day${i + 1}</button>
                    </th:block>
                </div>

                <div id="plan-list" class="plan">
                    <h4 class="mb-1">1일차</h4>
                    <div class="timeline" th:data-pid="${plannerId}">
                        <div class="outer planContainer">
                            <div>
                                <a href="" class="list-group-item list-group-item-action" aria-current="true">
                                    <div class="content">
                                        <div class="info">
                                            <h5 class="mb-1 title">관광지 이름</h5>
                                            <p class="mb-1">컨텐츠 아이디</p>
                                            <p class="mb-1">관광지 주소</p>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button type="button" id="open-share-btn" class="position-fixed rounded-pill btn btn-outline-primary">
            <i class="bi bi-share-fill"></i>
        </button>

    </div>




</div>

</div>
</body>
</html>