<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Bootstrap icons-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
          type="text/css"/>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Noto+Sans+KR:wght@100;200;300;400;500;600;700;800;900&display=swap"
          rel="stylesheet">
    <!-- Core theme CSS (includes Bootstrap)-->

    <link href="../assets/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="../assets/css/style.css?after" rel="stylesheet"/>
    <link href="../assets/css/commonstyle.css?after" rel="stylesheet"/>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- bootstrap datepicker cdn -->
    <!-- datepicker 는 jquery 1.7.1 이상 bootstrap 2.0.4 이상 버전이 필요함 -->
    <!-- jQuery가 먼저 로드 된 후 datepicker가 로드 되어야함.-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/material_blue.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ko.js"></script>
    <title>둘레둘레</title>



    <style>
        .map-result {
            z-index: 1000;
        }

        .container-fluid {
            --bs-gutter-x: 0 !important;
        }

        .outer {
            border-left: 2px solid #333;
        }

        .content {
            position: relative;
            margin: 0 0 20px 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            flex-direction: row;
            display: flex;
            justify-content: space-between;
        }

        .info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .title:before {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            background: #0d6efd;
            border-radius: 999px;
            left: -3.25rem;
            border: 3px solid #0d6efd;
        }

        .planContainer {
            padding: 20px 0 20px 20px;
        }

        div#day-btns {
            flex-direction: column;
            display: flex;
            width: 300px;
            gap: 10px;
        }
        div#list {
            flex-direction: row;
            display: flex;
            gap: 100px;
        }
        div#plan-list {
            width: 100%;
        }

        #open-etc-btn {
            bottom: 5%;
            right: 5%;
            z-index: 1000;
        }

        #right-btn {
            position: absolute;
            right: 10px;
        }

        .delete-user-btn, .delete-list-btn {
            background: #808080;
            padding: 0;
            border: none;
            color: #fff;
        }
        .delete-user-btn:hover, .delete-list-btn:hover {
            background-color: #808080;
            color: #fff;
        }
        div#resultBox {
            flex-direction: row;
            display: flex;
            gap: 0.5rem;
        }
        .touritem-img {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 0px 7px 7px 0px;
        }

        .grant {
            color: #fff;
            font-size: 13px;
            width: 100%;
        }

        .btn_route, .btn_optimize {
            padding: 5px 10px;
        }

        /**datepicker**/

        input.days {
            padding: 10px 15px !important;
            border: 1px solid lightgrey !important;
            border-radius: 10px;
            box-sizing: border-box;
            background-color: #fff !important;
            color: #2C3E50;
            font-size: 14px;
            letter-spacing: 1px;
            position: relative;
        }

        input:focus {
            -moz-box-shadow: none !important;
            -webkit-box-shadow: none !important;
            box-shadow: none !important;
            border: 1px solid #512DA8;
            outline-width: 0;
        }

        button:focus {
            -moz-box-shadow: none !important;
            -webkit-box-shadow: none !important;
            box-shadow: none !important;
            outline-width: 0;
        }

        .input-daterange {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
        }
        input[name="plannerName"] {
            width: 308px;
        }
        .team-profile-img {
            object-fit: cover;
            width: 50px !important;
            height: 50px !important;
        }
    </style>

</head>
<body>
<script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=aDVWgep9DE8rL7yokAybK6jrQIiAk9Ln9jI9CTyf"></script>
<script th:inline="javascript">
    // 로그인 된 나의 아이디
    let myId = [[${userId}]];

    // 플래너의 ID
    let plannerId = [[${plannerId}]];

    // 날짜
    let days = [[${daysBetween}]];

    // 인덱스
    let index;
    // 이전에 선택된 탭의 인덱스를 저장하는 변수
    let previousTabIndex = -1; // 초기값 설정, 아무런 탭도 선택되지 않았음을 나타냄

    // tmap api
    let map;

    // 마커
    let marker = [];

    // 찍은 모든 마커
    let viaMarkers = Array.from({length: days}, () => []);

    // 경유지만 넣는 배열
    let viaPoints = Array.from({length: days}, () => []);

    // 지도 줌
    let bounds;

    // 경유지 최적화 실행 시간
    let startTime = getRealTime();

    // 관광지들
    let places = Array.from({length: days}, () => []);

    // 내가 선택한 관광지
    let place;

    // 경로그림정보
    let drawInfoArr = Array.from({length: days}, () => []);
    let resultInfoArr = Array.from({length: days}, () => []);

    // 경로 출력 결과
    let resultText = Array.from({length: days}, () => []);

    // 앱키
    const appKey = "aDVWgep9DE8rL7yokAybK6jrQIiAk9Ln9jI9CTyf";

    // 검색창에 입력한 아이디
    let typedText = "";

    // 해당 플래너를 작성한 사람이 지금 로그인한 유저가 맞는지
    let isWriter = [[${isWriter}]];
    // 해당 플래너의 게스트가 지금 로그인한 유저가 맞는지
    let isGuest = [[${isGuest}]];

    // flatpickr 인스턴스
    let fp;

    let startDateString = [[${startDateString}]];
    let endDateString = [[${endDateString}]];

    /**
     * 자동 실행 함수
     */
    $(function () {
        initTmap();
        loadPlanForDay();
        openShareModal();
        deletePlanner();
        editPlanner();
        searchUser();
        share();
        deleteList();
        hideShareModal();
        deleteGuest();
        showPlannerInfo();
        showEditNameModal();
        hideEditNameModal();
        showEditDaysModal();
        hideEditDaysModal();
        loadDatePicker();
        editPlannerDays();
        editPlannerName();
    });

    /**
     * 뷰 관련
     */
    function showPlannerInfo() {
        let plannerName = [[${plannerName}]];
        let startDate = [[${startLocalDate}]];
        let endDate = [[${endLocalDate}]];
        let daysBetween = [[${daysBetween}]];

        $('.name').html(plannerName);
        var daysTemplate = `
                            <div class="start-end">${startDate} ~ ${endDate}</div>
                            <div class="days">(${daysBetween}일)</div>
                        `
        $('.planner-days').html(daysTemplate);
    }


    /**
     * 공유하기
     */
    // 공유하기 모달창 열기
    function openShareModal() {
        $('.share-planner-btn').click(function () {
            if (isWriter == false) {
                alert("공유 권한이 없습니다.");
            } else {
                $('#shareModal').modal('show');
            }
        })
    }

    // 유저 검색하기
    function searchUser() {
        $('#searchInput').on('keyup', function () {
            typedText = $(this).val();
            if (typedText == "") {
                $('#searchResult').hide();
            }

            $('#searchResult').show();
            $('#typedText').show();
            $('#typedText').text(typedText);

            $.ajax({
                url: "/api/users/search?userId=" + typedText,
                type: "GET",
                success: function (result) {
                    console.log(result);

                    let button = "<button id='right-btn' class='btn btn-sm btn-outline-dark'>추가하기</button>";
                    if (result.id == typedText) {
                        // 나 자신은 추가할 수 없다
                        if (result.id == myId) {
                            alert("본인은 추가할 수 없습니다.");
                            $('#right-btn').remove();
                        } else {
                            // 입력한 아이디가 내 아이디가 아니라면
                            // 이미 초대받은 게스트인지 확인
                            $.ajax({
                                url: `/api/checkInvitation/${plannerId}/${result.id}`,
                                type: "GET",
                                success: function (response) {
                                    if (!response.invited) { // 초대되지 않은 게스트일 경우에만 버튼 추가
                                        // 이미 목록에 추가된 사용자인지 확인
                                        if (!$(`#resultBox .user-btn[data-user-id='${result.id}']`).length) {
                                            $('#searchResult').append(button);
                                            // 한 번만 버튼을 누를 수 있도록 이벤트 핸들러를 한 번만 실행합니다.
                                            $('#right-btn').one('click', function () {
                                                printUser(result.id);
                                            });
                                        } else {
                                            alert("이미 추가된 사용자입니다.");
                                        }
                                    } else {
                                        alert("이미 초대된 게스트입니다.");
                                    }
                                },
                                error: function (xhr, status, error) {
                                    console.error("에러 발생:", error);
                                    $('#right-btn').remove();
                                }
                            });
                        }
                    }
                },
                error: function (xhr, status, error) {
                    if (xhr.status == 404) { // 서버에서 유저 정보가 없는 경우
                        $('#typedText').text("유저정보가 없습니다.");
                        $('#right-btn').remove();
                    } else { // 그 외의 서버 통신 오류
                        console.error("에러 발생:", error);
                        $('#typedText').text("서버와의 통신 중 문제가 발생했습니다.");
                        $('#right-btn').remove();
                    }
                }
            });
        });
    }

    // 선택한 유저 출력
    function printUser(id) {
        let button = `<div>
                        <button class='btn btn-sm btn-dark user-btn' data-user-id='${id}'>${id}</button>
                        <button class='btn delete-list-btn'>
                            <i class='bi bi-x'></i>
                        </button>
                       </div>`;
        $('#resultBox').show();
        $('#resultBox').prepend(button);
    }

    // 출력된 유저 목록에서 삭제
    function deleteList() {
        $('#resultBox').on('click', '.delete-list-btn', function () {
            $(this).closest('div').remove();
        });
    }

    // 특정 친구에게 공유 끊기
    function deleteGuest() {
        $('.delete-user-btn').on('click', function () {
            const guestId = this.previousElementSibling.getAttribute('data-user-id');
            if (confirm(`삭제하면 더 이상 일정을 공유할 수 없게 됩니다. 정말 ${guestId} 님을 초대받은 친구에서 삭제하시겠습니까?`)) {
                $.ajax({
                    url: `/api/removeGuest/${plannerId}/${guestId}`,
                    type: 'DELETE',
                    data: {
                        plannerId: plannerId,
                        guestId: guestId
                    },
                    success: function (response) {
                        alert(`초대받은 친구에서 ${guestId}님이 성공적으로 삭제되었습니다.`);
                        $('#shareModal').modal('hide');
                        location.reload(); // 페이지를 새로고침하여 변경사항 반영
                    },
                    error: function (xhr, status, error) {
                        alert("오류가 발생했습니다:" + error);
                    }
                })
            }
        })
    }

    // 공유하기
    function share() {
        $('#share-btn').on('click', function () {
            var plannerName = [[${plannerName}]];
            var plannerId = [[${plannerId}]]; // Planner ID를 설정합니다.
            var ownerId = [[${userId}]]; // Owner ID를 설정합니다.
            var userIds = [];
            $('#resultBox .user-btn').each(function () {
                userIds.push($(this).text()); // 버튼의 텍스트(ID)를 배열에 추가
            });

            var dataToSend = {
                plannerId: plannerId,
                ownerId: ownerId,
                sharedWithUserIds: userIds
            };

            // 각 사용자의 ID를 쉼표로 구분하여 출력
            var userIdsString = userIds.join("님, ");
            var confirmMessage = plannerName + "을 " + userIdsString + "님 에게 공유하시겠습니까?";

            // 사용자가 추가된 경우에만
            if (userIds.length > 0) {
                // 확인 대화상자를 통해 공유를 확인한 후에만 나머지 코드를 실행
                if (confirm(confirmMessage)) {
                    // AJAX를 사용하여 userIds를 서버로 POST 방식으로 전송
                    $.ajax({
                        url: '/api/sharePlanner',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(dataToSend),
                        success: function (response) {
                            alert('초대가 성공적으로 완료되었습니다.');
                            $('#shareModal').modal('hide');
                            location.reload();
                        },
                        error: function (xhr, status, error) {
                            alert('초대 과정에서 오류가 발생했습니다: ' + error);
                            // 실패 시 추가적인 로직 처리...
                        }
                    });
                } else {
                    alert('공유를 취소하였습니다.');
                }
            } else {
                alert('먼저 유저를 선택한 다음 공유해주세요.')
            }
        });
    }

    // 모달창 닫기
    function hideShareModal() {
        $('#shareModal').on('hidden.bs.modal', function () {
            // 모달 내용 초기화
            $('#searchInput').val(''); // 검색창 초기화
            $('#typedText').text(''); // 검색 결과 초기화
            $('#searchResult').hide(); // 검색 결과 숨기기
            $('#resultBox').empty().hide(); // 선택된 유저 목록 초기화 및 숨기기
        });
    }


    /**
     * 수정하기
     */
    // 이름 수정 모달
    function showEditNameModal() {
        $('.edit-name-btn').click(function () {
            if (isWriter == false) {
                alert("수정 권한이 없습니다.");
            } else {
                $('#nameEditModal').modal('show');
            }
        })
    }

    function hideEditNameModal() {
        let plannerName = [[${plannerName}]]
        $('#nameEditModal').on('hidden.bs.modal', function () {
            // 모달 내용 초기화
            $('input[name=plannerName]').val(plannerName);
        });
    }

    function editPlannerName() {
        $('#name-edit-confirm').click(function () {
            var editName = $('input[name=plannerName]').val();
            if(editName !== "") { // 공백이 아닌 경우
                if(editName.length > 20) { // 20자를 초과한다면
                    alert('제목은 20자를 초과할 수 없습니다.');
                    editName.focus();
                    editName.substring(0,20);
                } else if(confirm("입력하신 내용을 제목으로 수정하시겠습니까?")) { // 20자를 초과하지 않으면
                    $.ajax({
                        type: "PUT",
                        url: "/api/planner/" + plannerId  + "/name",
                        contentType: "application/json",
                        data: JSON.stringify({
                            plannerId: plannerId,
                            plannerName: editName
                        }),
                        success: function(response) {
                            $('#nameEditModal').modal('hide');
                            window.location.href = '/plan/show?p_id=' + plannerId;
                            alert('수정되었습니다.');
                        },
                        error:function (xhr, status, error) {
                            alert('실패');
                        }
                    });
                }
            } else { // 공백인 경우
                alert('여행제목은 비워둘 수 없습니다.');
            }
        });
    }

    function checkLength() {
        let plannerName = $('input[name="plannerName"]');
        if (plannerName.val().length > 20) {
            alert('20자 이내로 입력해주세요');
            plannerName.val(plannerName.val().substring(0, 20));
            plannerName.focus();
        }
    }


    // 날짜 datepicker 로드하기
    function loadDatePicker() {
        let daysBetween = [[${daysBetween}]];
        console.log("startDateString : " + startDateString);
        console.log("endDateString : " + endDateString);


        let startDate = new Date(startDateString);
        let endDate = new Date(endDateString);


        console.log("startDate : " + startDate);
        console.log("endDate : " + endDate);


        fp = flatpickr("#days", {
            mode: "range",
            inline: true,
            static: true,
            locale: "ko",
            defaultDate: [startDate, endDate],

            onChange: function(selectedDates, datestr, instance) {

                if (selectedDates.length === 1) { // 날짜를 하루만 선택했을 때
                    let newMaxDate = new Date(selectedDates[0]);
                    newMaxDate.setDate(selectedDates[0].getDate() + 9); // 시작 날짜에서 9일 후의 날짜 설정
                    let newMinDate = new Date(selectedDates[0]);
                    newMinDate.setDate(selectedDates[0].getDate() - 9); // 시작 날짜에서 9일 전의 날짜 설정

                    instance.set('maxDate', newMaxDate);
                    instance.set('minDate', newMinDate);
                } else {
                    instance.set('maxDate', null); // 종료 날짜 제한 없음
                    instance.set('minDate', null); // 시작 날짜 제한 없음
                }
            }
        });
    }

    function editPlannerDays() {
        $('#days-edit-confirm').click(function () {
            let dateStr = $('#days').val();
            if(dateStr === "") { // 비어있으면
                alert('날짜를 모두 입력해주세요.');
                return;
            }
            let startDate = new Date(dateStr.substr(0, 10));
            let endDate = (dateStr.length > 10) ? new Date(dateStr.substr(13, 10)) : startDate;
            console.log("startDate : " + startDate);
            console.log("endDate : " + endDate);

            // 두 날짜 간의 밀리초 차이 계산
            let timeDiff = endDate.getTime() - startDate.getTime();

            // 일(day) 단위로 변환
            let daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24)) + 1;
            console.log("daysDiff : " + daysDiff);
            console.log("days : " + days);

            function editPlannerDates(plannerId, startDate, endDate) {
                $.ajax({
                    url: '/api/planner/' + plannerId + '/dates',
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        plannerId: plannerId,
                        startDate: startDate,
                        endDate: endDate
                    }),
                    success: function(response) {
                        $('#daysEditModal').modal('hide');
                        window.location.href = '/plan/show?p_id=' + plannerId;
                        alert('수정되었습니다.');
                    }
                });
            }

            function confirmAndEdit(plannerId, startDate, endDate, confirmationMessage) {
                if (confirm(confirmationMessage)) {
                    editPlannerDates(plannerId, startDate, endDate);
                }
            }

            if (daysDiff < days) {
                confirmAndEdit(plannerId, startDate, endDate, '기존에 등록한 여행일수보다 작습니다. 여행일수를 초과한 일정들은 삭제됩니다. 그래도 여행날짜를 변경하시겠습니까?');
            } else if (daysDiff === days) {
                confirmAndEdit(plannerId, startDate, endDate, '선택한 날짜로 여행 일정을 수정하시겠습니까?');
            } else if (daysDiff > days) {
                confirmAndEdit(plannerId, startDate, endDate, '기존에 등록한 여행일수보다 많습니다. 선택한 날짜로 여행 일정을 수정하시겠습니까?');
            }
        });
    }




    // 날짜 수정 모달
    function showEditDaysModal() {
        $('.edit-days-btn').click(function () {
            if (isWriter == false) {
                alert("수정 권한이 없습니다.");
            } else {
                $('#daysEditModal').modal('show');
            }
        });
    }

    function hideEditDaysModal() {
        let startDate = new Date(startDateString);
        let endDate = new Date(endDateString);
        $('#daysEditModal').on('hidden.bs.modal', function () {
            // 모달 내용 초기화
            fp.setDate([startDate, endDate]); // 값 초기화
        });
    }

    // 플랜 수정 로드하기
    function editPlanner() {
        $('.edit-planner-btn').click(function () {
            if (isWriter == false) {
                alert('수정 권한이 없습니다.');
            } else {
                window.location.href = "/plan/edit?p_id=" + plannerId;
            }
        })
    }

    /**
     * 삭제하기
     */
    function deletePlanner() {
        $('.delete-planner-btn').click(function () {
            if(isWriter == true) {
                const deleteConfirm = "등록한 여행 일정을 정말로 삭제하시겠습니까? 삭제하면 복구할 수 없습니다.";
                if (confirm(deleteConfirm)) {
                    $.ajax({
                        url: `/api/planner/${plannerId}`,
                        type: 'DELETE',
                        data: {
                            plannerId: plannerId,
                        },
                        success: function () {
                            alert('삭제되었습니다.');
                            window.location.href = '/planner';
                        },
                        error: function (xhr, status, error) {
                            console.error(error);
                        }
                    });
                }
            } else if(isGuest == true){
                const deleteConfirm = "초대받은 여행에서 삭제하시겠습니까? 삭제하시면 더 이상 공유받을 수 없습니다.";
                let guestId = [[${userId}]];
                if(confirm(deleteConfirm)) {
                    $.ajax({
                        url: `/api/removeGuest/${plannerId}/${guestId}`,
                        type: 'DELETE',
                        data: {
                            plannerId: plannerId,
                            guestId: guestId
                        },
                        success: function (response) {
                            alert(`초대받은 여행에서 삭제되었습니다.`);
                            $('#shareModal').modal('hide');
                            window.location.href = '/planner';
                        },
                        error: function (xhr, status, error) {
                            alert("오류가 발생했습니다:" + error);
                        }
                    })
                }
            } else {
                alert('삭제 권한이 없습니다.');
            }
        })
    }

    /**
     * 저장된 여행 일정 불러오기
     */
    // 여행 일정 목록 불러오기
    function loadPlanForDay() {
        $.ajax({
            type: "GET",
            url: "/api/planner/" + plannerId,
            contentType: 'application/json; charset=UTF-8',
            data: {
                "plannerId": plannerId
            },
            success: function (response) {
                // 응답으로 받은 계획을 표시
                insertPlaces(response);
                addPrintDayList();
                // 모든 마커가 추가된 후에 fitBounds 호출
                fitBoundsToMarkers();
            },
            error: function (xhr, status, error) {
                console.error(error);
            }
        });
    }

    // 불러온 목록 보여주기
    function insertPlaces(planList) {
        let currentDay = 0; // 현재의 day를 추적

        $.each(planList, function (index, plan) {
            if (plan.day !== currentDay) {
                currentDay = plan.day; // 일자 업데이트
            }

            $.each(plan.dtoList, function (i, dto) {
                place = {
                    title: dto.title,
                    contentid: dto.contentid,
                    mapx: dto.mapx,
                    mapy: dto.mapy,
                    address: dto.address,
                    fullCategoryName: dto.fullCategoryName,
                    firstimage: dto.firstimage
                }
                places[plan.day - 1].push(place); // places 배열만 생성, viaMarkers 배열은 필요할때만 생성
            });
        });

        // 첫번째 탭의 마커는 미리 보이게 설정
        for (var i = 0; i < places[0].length; i++) {
            addMarker(i + 1, places[0][i], 0);
        }
        fitBoundsToMarkers();
    }


    // 계획을 표시하는 함수
    function addPrintDayList() {
        $('.plan').empty(); // 계획을 비우고 다시 채움

        var dayTemplate = `<h4 class="mb-4">${index + 1}일차</h4>`;
        $('.plan').append(dayTemplate);

        if(places[index].length > 0) { // 내용이 있으면 표시
            places[index].forEach(function (data) {
                var template = `
                                <div class="timeline">
                                    <div class="outer planContainer">
                                        <div>
                                            <a href="/info/content/${data.contentid}" class="list-group-item list-group-item-action" aria-current="true">
                                                <div class="content">
                                                    <div class="info p-3">
                                                        <h5 class="mb-1 title">${data.title}</h5>
                                                        <p class="mb-1">${data.address}</p>
                                                        <p class="mb-1">${data.fullCategoryName}</p>
                                                        <input type="hidden" value="${data.mapx}">
                                                        <input type="hidden" value="${data.mapy}">
                                                    </div>
                                                    <div class="img">
                                                        <img class="touritem-img" src="${data.firstimage}">
                                                    </div>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            `;
                $('.plan').append(template);
            })
        } else { // 내용이 없으면
            var template = `
                                <div>등록된 일정이 없습니다. 일정을 추가해주세요. </div>
                            `;
            $('.plan').append(template);
        }

    }

    /**
     * 마커
     */

    // 마커 추가하기 함수
    function addMarker(status, info) {

        // status 에 따라 아이콘 바꾸기
        imgUrl = `https://tmapapi.tmapmobility.com/upload/tmap/marker/pin_b_m_${status}.png`;

        // 관광지 목록에 추가한 대로 marker 생성
        marker = new Tmapv2.Marker({
            position: new Tmapv2.LatLng(info.mapy, info.mapx),
            icon: imgUrl,
            iconSize: new Tmapv2.Size(24, 38),
            map: map,
            title: info.title
        })
        viaMarkers[index].push(marker);
    }

    // 모든 마커가 추가된 후에 fitBounds 함수 호출
    function fitBoundsToMarkers() {
        if (viaMarkers[index].length > 0) {
            if (viaMarkers[index].length == 1) {
                map.setCenter(viaMarkers[index][0].getPosition());
                map.setZoom(10); // 마커가 하나 뿐이면 그것만 줌
            } else {
                var PTbounds = new Tmapv2.LatLngBounds();

                    if (viaMarkers[index].length > 0) {
                        for (var i = 0; i < viaMarkers[index].length; i++) {
                            var marker = viaMarkers[index][i];
                            PTbounds.extend(marker.getPosition());
                        }
                    }

                var paddingOptions = {
                    top: 40, // 상단 패딩
                    right: 40, // 우측 패딩
                    bottom: 40, // 하단 패딩
                    left: 40 // 좌측 패딩
                };
                map.fitBounds(PTbounds, paddingOptions);
            }
        }
    }

    /**
     * 탭 처리
     */
    document.addEventListener("DOMContentLoaded", function () {
        // 각 탭 요소들을 선택
        var tabs = document.querySelectorAll('.dayButton');
        // 첫 번째 탭을 활성화하고 해당 내용을 보이도록 설정
        tabs[0].classList.add('btn-primary');
        tabs[0].classList.remove('btn-secondary');
        index = 0;
        // 처음으로 첫 번째 날짜의 계획을 로드
        addPrintDayList();

        // 각 탭에 대해 클릭 이벤트 리스너 추가
        tabs.forEach(function (tab, tabIndex) {
            tab.addEventListener('click', function () {
                previousTabIndex = index;
                index = tabIndex; // 현재 선택한 탭의 인덱스

                // 모든 탭에서 'active' 클래스 제거
                tabs.forEach(function (otherTab) {
                    otherTab.classList.remove('btn-primary');
                    otherTab.classList.add('btn-secondary');
                });
                // 현재 클릭된 탭에만 'active' 클래스 추가
                tab.classList.add('btn-primary');
                tab.classList.remove('btn-secondary');


                // 다른 탭으로 이동할 경우
                if (previousTabIndex !== index) {
                    // 이전 탭에서 마커와 경로가 이미 있다면 제거
                    if (viaMarkers[previousTabIndex] && viaMarkers[previousTabIndex].length > 0) {
                        viaMarkers[previousTabIndex].forEach(function (marker) {
                            marker.setMap(null); // TMap에서 이전 탭 마커 제거
                        });
                        viaMarkers[previousTabIndex] = []; // 등록된 마커 배열도 초기화
                    }
                    if (resultInfoArr[previousTabIndex] && resultInfoArr[previousTabIndex].length > 0) {
                        resultInfoArr[previousTabIndex].forEach(function (line) {
                            line.setMap(null); // TMap에서 이전 탭 경로 빨간 선 제거
                        })
                        $(".result").text(""); // 총 거리, 시간, 요금 결과 제거
                    }

                    addPrintDayList();

                    // 마커 다시 찍기
                    for (var i = 0; i < places[index].length; i++) {
                        addMarker(i + 1, places[index][i])
                    }
                    // 지도를 해당 마커를 중심으로 기본 줌 레벨로 확대
                    fitBoundsToMarkers();

                    // 현재 선택한 탭에 맞는 경로 빨간 선 표시를 다시 로드
                    resultInfoArr[index].forEach(function (line) {
                        line.setMap(map);
                    })

                    // 현재 선택한 탭에 맞는 총 거리, 시간, 요금 결과를 다시 로드
                    $(".result").text(resultText[index]); // 총 거리, 시간, 요금 결과 제거


                    // 이전 탭의 인덱스를 업데이트
                    previousTabIndex = index;
                }
            });
        });
    });


    /**
     * tmap
     */
    // 현재 시간을 토대로 이동에 걸리는 시간을 구합니다.
    function getRealTime() {
        var date = new Date();
        var year = date.getFullYear();
        var month = ('0' + (date.getMonth() + 1)).slice(-2);
        var day = ('0' + (date.getDate())).slice(-2);
        var hour = ('0' + (date.getHours())).slice(-2);
        var minute = ('0' + (date.getMinutes())).slice(-2);

        var currentDate = year + month + day + hour + minute
        console.log(currentDate);
        return currentDate;
    }

    function initTmap() {
        map = new Tmapv2.Map("map_div", {
            center: new Tmapv2.LatLng(36.4109466, 128.1590828),
            width: "100%",
            height: "400px",
            zoom: 8,
            zoomControl: true,
            scrollwheel: true
        });

        // 최적화 버튼을 누르면 ajax 실행
        $(".btn_optimize").click(function () {
            // 마커가 3곳 이상이 아니면 실행되지 않도록 막음
            if (viaMarkers[index].length < 3) {
                alert('여행지를 3곳 이상 추가해주세요.');
                return false;
            } else {
                var headers = {};
                headers["appKey"] = appKey;

                viaPoints[index] = []; // 이전 viaPoints[index] 배열을 날리고

                // 시작 장소와 종료 장소
                var start_Mapx = viaMarkers[index][0]._marker_data.options.position._lng;
                var start_Mapy = viaMarkers[index][0]._marker_data.options.position._lat;
                var end_Mapx = viaMarkers[index][viaMarkers[index].length - 1]._marker_data.options.position._lng;
                var end_Mapy = viaMarkers[index][viaMarkers[index].length - 1]._marker_data.options.position._lat;

                // 마커에 찍힌 경유지를 새로 받는다
                for (var i = 1; i < viaMarkers[index].length - 1; i++) {
                    // 하나하나 선택한 경유지
                    var viaPoint = {};
                    viaPoint.viaPointId = i + "경유지";
                    viaPoint.viaPointName = viaMarkers[index][i]._marker_data.options.title;
                    viaPoint.viaX = viaMarkers[index][i]._marker_data.options.position._lng.toString();
                    viaPoint.viaY = viaMarkers[index][i]._marker_data.options.position._lat.toString();
                    console.log("viaPoint : " + viaPoint);

                    viaPoints[index].push(viaPoint); // 지금 담겨진 경로를 viaPoints[index] 에 담는다.
                }
                console.log(viaPoints[index]);


                $.ajax({
                    type: "POST",
                    headers: headers,
                    url: "https://apis.openapi.sk.com/tmap/routes/routeOptimization20?version=1&format=json",
                    async: false,
                    contentType: "application/json",
                    data: JSON.stringify({
                        "startName": "출발",
                        "startX": start_Mapx.toString(),
                        "startY": start_Mapy.toString(),
                        "startTime": startTime,
                        "endName": "도착",
                        "endX": end_Mapx.toString(),
                        "endY": end_Mapy.toString(),
                        "viaPoints": viaPoints[index],
                        "reqCoordType": "WGS84GEO",
                        "resCoordType": "EPSG3857"
                    }),
                    success: function (response) {
                        var resultData = response.properties;
                        var resultFeatures = response.features;

                        // 결과 출력
                        var tDistance = "총 거리 : " + (resultData.totalDistance / 1000).toFixed(1) + "km,  ";
                        var tTime = "총 시간 : " + (resultData.totalTime / 60).toFixed(0) + "분,  ";
                        var tFare = "총 요금 : " + resultData.totalFare + "원";

                        resultText[index] = tDistance + tTime + tFare;
                        $(".result").text(resultText[index]);

                        // 기존 라인 초기화
                        if (resultInfoArr[index].length > 0) {
                            for (var i in resultInfoArr[index]) {
                                resultInfoArr[index][i].setMap(null);
                            }
                            resultInfoArr[index] = [];
                        }

                        var PTbounds = new Tmapv2.LatLngBounds();
                        for (var i in resultFeatures) {
                            var geometry = resultFeatures[i].geometry;
                            var polyline_ = Array.from({length: days}, () => []);
                            drawInfoArr[index] = [];

                            if (geometry.type == "LineString") {
                                for (var j in geometry.coordinates) {
                                    // 경로들의 결과값(구간)들을 포인트 객체로 변환
                                    var latlng = new Tmapv2.Point(geometry.coordinates[j][0], geometry.coordinates[j][1]);
                                    // 포인트 객체를 받아 좌표값으로 변환
                                    var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(latlng);
                                    // 포인트객체의 정보로 좌표값 변환 객체로 저장
                                    var convertChange = new Tmapv2.LatLng(convertPoint._lat, convertPoint._lng);

                                    bounds = convertChange;
                                    drawInfoArr[index].push(convertChange);
                                    // 경유지 최적화 결과 반경만큼 지도 레벨 조정
                                    var linePt = new Tmapv2.LatLng(bounds._lat, bounds._lng);

                                    PTbounds.extend(linePt);
                                }

                                polyline_[index] = new Tmapv2.Polyline({
                                    path: drawInfoArr[index],
                                    strokeColor: "#FF0000",
                                    strokeWeight: 6,
                                    map: map
                                });
                                resultInfoArr[index].push(polyline_[index]);
                                var paddingOptions = {
                                    top: 40, // 상단 패딩
                                    right: 40, // 우측 패딩
                                    bottom: 40, // 하단 패딩
                                    left: 40 // 좌측 패딩
                                };
                                map.fitBounds(PTbounds, paddingOptions);
                            }
                        }
                    },
                    error: function (request, status, error) {
                        console.log("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                    }
                });
            }
        })


        // 경로 보기 버튼을 누르면 ajax 실행
        $(".btn_route").click(function () {
            // 마커가 3곳 이상이 아니면 실행되지 않도록 막음
            if (viaMarkers[index].length < 3) {
                alert('여행지를 3곳 이상 추가해주세요.');
                return false;
            } else {
                var headers = {};
                headers["appKey"] = appKey;

                viaPoints[index] = []; // 이전 viaPoints[index] 배열을 날리고

                // 시작 장소와 종료 장소
                var start_Mapx = viaMarkers[index][0]._marker_data.options.position._lng;
                var start_Mapy = viaMarkers[index][0]._marker_data.options.position._lat;
                var end_Mapx = viaMarkers[index][viaMarkers[index].length - 1]._marker_data.options.position._lng;
                var end_Mapy = viaMarkers[index][viaMarkers[index].length - 1]._marker_data.options.position._lat;

                // 마커에 찍힌 경유지
                for (var i = 1; i < viaMarkers[index].length - 1; i++) {
                    var viaPoint = {};
                    viaPoint.viaPointId = i + "경유지";
                    viaPoint.viaPointName = viaMarkers[index][i]._marker_data.options.title;
                    viaPoint.viaX = viaMarkers[index][i]._marker_data.options.position._lng.toString();
                    viaPoint.viaY = viaMarkers[index][i]._marker_data.options.position._lat.toString();
                    console.log(viaPoint);

                    viaPoints[index].push(viaPoint); // 지금 담겨진 경로를 viaPoints[index] 에 담는다.
                }
                console.log(viaPoints[index]);


                $.ajax({
                    type: "POST",
                    headers: headers,
                    url: "https://apis.openapi.sk.com/tmap/routes/routeSequential30?version=1&format=json",
                    async: false,
                    contentType: "application/json",
                    data: JSON.stringify({
                        "startName": "출발",
                        "startX": start_Mapx.toString(),
                        "startY": start_Mapy.toString(),
                        "startTime": startTime,
                        "endName": "도착",
                        "endX": end_Mapx.toString(),
                        "endY": end_Mapy.toString(),
                        "viaPoints": viaPoints[index]
                    }),
                    success: function (response) {
                        var resultData = response.properties;
                        var resultFeatures = response.features;

                        // 결과 출력
                        var tDistance = "총 거리 : " + (resultData.totalDistance / 1000).toFixed(1) + "km,  ";
                        var tTime = "총 시간 : " + (resultData.totalTime / 60).toFixed(0) + "분,  ";
                        var tFare = "총 요금 : " + resultData.totalFare + "원";

                        resultText[index] = tDistance + tTime + tFare;
                        $(".result").text(resultText[index]);

                        // 기존 라인 초기화
                        if (resultInfoArr[index].length > 0) {
                            for (var i in resultInfoArr[index]) {
                                resultInfoArr[index][i].setMap(null);
                            }
                            resultInfoArr[index] = [];
                        }

                        var PTbounds = new Tmapv2.LatLngBounds();
                        for (var i in resultFeatures) {
                            var geometry = resultFeatures[i].geometry;
                            var polyline_ = Array.from({length: days}, () => []);
                            drawInfoArr[index] = [];

                            // 지도 레벨과 경로를 함께 조정
                            if (geometry.type == "LineString") {
                                for (var j in geometry.coordinates) {
                                    var point = new Tmapv2.LatLng(geometry.coordinates[j][1], geometry.coordinates[j][0]);

                                    bounds = point;
                                    drawInfoArr[index].push(point);

                                    // 경유지 최적화 결과 반경만큼 지도 레벨 조정
                                    var linePt = new Tmapv2.LatLng(bounds._lat, bounds._lng);
                                    PTbounds.extend(linePt);
                                }

                                polyline_[index] = new Tmapv2.Polyline({
                                    path: drawInfoArr[index],
                                    strokeColor: "#FF0000",
                                    strokeWeight: 6,
                                    map: map
                                });
                                resultInfoArr[index].push(polyline_[index]);

                                var paddingOptions = {
                                    top: 40, // 상단 패딩
                                    right: 40, // 우측 패딩
                                    bottom: 40, // 하단 패딩
                                    left: 40 // 좌측 패딩
                                };
                                map.fitBounds(PTbounds, paddingOptions);
                            }
                        }
                    },
                    error: function (request, status, error) {
                        console.log("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                    }
                });
            }
        })
    }

</script>
<!-- 공유 모달 -->
<div class="modal fade" id="shareModal" tabindex="-1" role="dialog" aria-labelledby="shareModalLabel"
     aria-hidden="true">
    <div class="modal-dialog  modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">일정을 공유할 친구를 선택해주세요.</h5>
                <button type="button" class="btn btn-sm close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                    <div style="height: 60px;" th:if="${teamList.size() > 0}">
                        <div id="guestList">
                            공유중인 친구
                            <th:block th:each="member, idx : ${teamList}">
                                <th:block th:if="${member.teamLevel == 0}">
                                    <button class="btn btn-sm btn-dark user-btn" th:data-user-id="${member.user.id}" th:text="${member.user.id}"></button>
                                    <button class="btn delete-user-btn">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </th:block>
                            </th:block>
                        </div>
                    </div>
                    <!--선택한 유저의 목록이 보일 창-->
                    <div style="height: 60px;">
                        <div id="resultBox" style="display: none;">
                        </div>
                    </div>
                    <!--검색창-->
                    <input id="searchInput" name="searchInput" type="text" class="form-control" placeholder="유저 아이디를 검색하세요.">
<!--                    <i class="bi bi-search"></i>-->
                    <!--유저의 검색결과가 보일 창-->
                    <div style="height: 60px;">
                        <div class="alert alert-success d-flex align-items-center" id="searchResult" style="display: none;">
                            <span id="typedText"></span>
                        </div>
                    </div>

            </div>
            <div class="modal-footer">
                <button type="button" id="share-btn" class="btn btn-primary">초대하기</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 이름 수정 모달 -->
<div class="modal fade" id="nameEditModal" tabindex="-1" role="dialog" aria-labelledby="nameEditModalLabel"
     aria-hidden="true">
    <div class="modal-dialog  modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nameEditModalLabel">여행 일정의 제목을 수정하세요.</h5>
                <button class="btn btn-sm close" type="button" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input id="plannerName" name="plannerName" type="text" class="form-control" oninput="checkLength()" th:placeholder="${plannerName}" th:value="${plannerName}">
            </div>
            <div class="modal-footer">
                <button type="button" id="name-edit-confirm" class="btn btn-primary">수정</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>


<!-- 날짜 수정 모달 -->
<div class="modal fade" id="daysEditModal" tabindex="-1" role="dialog" aria-labelledby="daysEditModalLabel"
     aria-hidden="true">
    <div class="modal-dialog  modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="daysEditModalLabel">여행 일정의 날짜를 수정하세요.</h5>
                <button type="button" class="btn btn-sm close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="flex-sm-row flex-column d-flex justify-content-center">
                    <div class="col-sm-9 col-12 px-0 mb-2">
                        <div class="input-daterange">
                            <input id="days" name="days" type="date" class="form-control" th:placeholder="${startDateString} + ' ~ ' + ${endDateString}">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="days-edit-confirm" class="btn btn-primary">수정</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<div class="d-flex flex-nowrap">
    <th:block th:replace="~{fragments/sidebar}"></th:block>
    <div class="container mt-5">
        <div class="d-flex flex-row gap-4">
            <th:block th:each="member, idx : ${teamList}">
                <div th:if="${member.teamLevel == 9}">
                    <a th:href="@{/mypage/{userId}(userId=${member.user.id})}" class="d-flex flex-column align-items-center gap-1">
                        <img th:src="${member.user.profileImg}" th:data-user-id="${member.user.id}" alt="프로필 이미지" class="team-profile-img rounded-circle">
                        <span class="user-btn" th:data-user-id="${member.user.id}" th:text="${member.user.id}"></span>
                        <div class="grant bg-dark rounded-pill d-flex justify-content-center">host</div>
                    </a>
                </div>
                <div th:if="${member.teamLevel == 0}">
                    <a th:href="@{/mypage/{userId}(userId=${member.user.id})}"  class="d-flex flex-column align-items-center gap-1">
                        <img th:src="${member.user.profileImg}" th:data-user-id="${member.user.id}" alt="프로필 이미지" class="team-profile-img rounded-circle">
                        <span class="user-btn" th:data-user-id="${member.user.id}" th:text="${member.user.id}"></span>
                        <div class="grant bg-secondary rounded-pill d-flex justify-content-center">guest</div>
                    </a>
                </div>
            </th:block>
        </div>

        <!--공유중인 유저들 표시-->
        <p class="team-list" th:if="${teamList.size() > 0}" th:title="${teamList}"></p>

        <!--플래너 이름과 플래너 날짜 표시-->
        <div class="info-header">
            <div class="planner-name d-flex flex-row align-items-center">
                <h4 class="name mb-0"></h4>
                <button class="btn btn-sm edit-name-btn ms-3 btn-outline-secondary">
                    <i class="bi bi-pencil-square"></i>
                </button>
            </div>

            <div class="planner-date d-flex flex-row align-items-center">
                <div class="planner-days d-flex flex-row gap-3">
                    <div class="start-end"></div>
                    <div class="days"></div>
                </div>
                <button class="btn btn-sm edit-days-btn ms-3 btn-outline-secondary">
                    <i class="bi bi-pencil-square"></i>
                </button>
            </div>
        </div>

        <!--지도-->
        <div id="map" class="d-flex flex-column align-items-stretch default pt-4">
            <div class="map-result position-absolute">
                <button class="btn btn-primary btn_route">경로 확인</button>
                <button class="btn btn-primary btn_optimize">동선 추천</button>
                <p class="result"></p>
            </div>
            <div id="map_div">
            </div>
        </div>


        <!--세부 플랜 표시-->
        <div class="container-fluid mt-3">
            <div id="list">
                <div id="day-btns">
                    <th:block th:each="i : ${#numbers.sequence(1, daysBetween)}">
                        <button class="btn btn-secondary dayButton" th:data-day="${i}" th:text="'Day ' + ${i}">Day${i}</button>
                    </th:block>
                </div>

                <div id="plan-list" class="plan">
                    <h4 class="mb-1">1일차</h4>
                    <div class="timeline" th:data-pid="${plannerId}">
                        <div class="outer planContainer">
                            <div>
                                <a href="" class="list-group-item list-group-item-action" aria-current="true">
                                    <div class="content">
                                        <div class="info">
                                            <h5 class="mb-1 title">관광지 이름</h5>
                                            <p class="mb-1">컨텐츠 아이디</p>
                                            <p class="mb-1">관광지 주소</p>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="btn-group">
            <button type="button" id="open-etc-btn" class="position-fixed rounded-pill btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item edit-planner-btn">수정</a></li>
                <li><a class="dropdown-item delete-planner-btn">삭제</a></li>
                <li><a class="dropdown-item share-planner-btn">공유</a></li>
            </ul>
        </div>
    </div>
</div>
</body>
</html>