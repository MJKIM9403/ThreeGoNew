<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Bootstrap icons-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
          type="text/css"/>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Noto+Sans+KR:wght@100;200;300;400;500;600;700;800;900&display=swap"
          rel="stylesheet">
    <!-- Core theme CSS (includes Bootstrap)-->

    <link href="../assets/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="../assets/css/style.css?after" rel="stylesheet"/>
    <link href="../assets/css/commonstyle.css?after" rel="stylesheet"/>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- bootstrap datepicker cdn -->
    <!-- datepicker 는 jquery 1.7.1 이상 bootstrap 2.0.4 이상 버전이 필요함 -->
    <!-- jQuery가 먼저 로드 된 후 datepicker가 로드 되어야함.-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/css/bootstrap-datepicker.min.css" integrity="sha512-34s5cpvaNG3BknEWSuOncX28vz97bRI59UnVtEEpFX536A7BtZSJHsDyFoCl8S7Dt2TPzcrCEoHBGeM4SUBDBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/js/bootstrap-datepicker.min.js" integrity="sha512-LsnSViqQyaXpD4mBBdRYeP6sRwJiJveh2ZIbW41EBrNmKxgr/LFZIiWT6yr+nycvhvauz8c2nYMhrP80YhG7Cw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/locales/bootstrap-datepicker.ko.min.js" integrity="sha512-L4qpL1ZotXZLLe8Oo0ZyHrj/SweV7CieswUODAAPN/tnqN3PA1P+4qPu5vIryNor6HQ5o22NujIcAZIfyVXwbQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <title>Title</title>
</head>
<body>
<script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=aDVWgep9DE8rL7yokAybK6jrQIiAk9Ln9jI9CTyf"></script>
<script th:inline="javascript">
    // 날짜
    var days = [[${daysBetween}]];

    // 인덱스
    var index;
    // 이전에 선택된 탭의 인덱스를 저장하는 변수
    var previousTabIndex = -1; // 초기값 설정, 아무런 탭도 선택되지 않았음을 나타냄

    // tmap api
    var map;

    // 마커
    var marker = [];

    // 찍은 모든 마커
    var viaMarkers = Array.from({length: days}, () => []);

    // 경유지만 넣는 배열
    var viaPoints = Array.from({length: days}, () => []);

    // 경유지 최적화 실행 시간
    var startTime = getRealTime();

    // 관광지들
    var places = Array.from({length: days}, () => []);

    // 내가 선택한 관광지
    var place;

    // 경로그림정보
    var drawInfoArr = Array.from({length: days}, () => []);
    var resultInfoArr = Array.from({length: days}, () => []);

    // 경로 출력 결과
    var resultText = Array.from({length: days}, () => []);

    // 앱키
    const appKey = "aDVWgep9DE8rL7yokAybK6jrQIiAk9Ln9jI9CTyf";

    // 페이지 로드 시 실행되는 코드
    $(document).ready(function() {
        // 처음으로 첫 번째 날짜의 계획을 로드
        loadPlanForDay(1);

        // 날짜 버튼 클릭 시 실행되는 이벤트 핸들러
        $('.dayButton').click(function() {
            var day = $(this).attr('data-day');
            loadPlanForDay(day);
        });
    });

    // 특정 날짜의 계획을 로드하는 함수
    function loadPlanForDay(day) {
        var plannerId = $('.timeline').attr('data-pid');

        $.ajax({
            type: "POST",
            url: "/api/showplan",
            contentType: 'application/json; charset=UTF-8',
            data: JSON.stringify({
                "plannerId": plannerId,
                "day": day
            }),
            success: function(response) {
                // 응답으로 받은 계획을 표시
                displayPlan(response);
            },
            error: function(xhr, status, error) {
                console.error(error);
            }
        });
    }

    // 계획을 표시하는 함수
    function displayPlan(planList) {
        $('.plan').empty(); // 계획을 비우고 다시 채움

        // 첫 번째 계획의 일차 정보를 저장
        var firstDay = planList.length > 0 ? planList[0].day : '';

        // 첫 번째 계획의 일차 정보만 출력
        var dayTemplate = `<p>${firstDay}일차</p>`;
        $('.plan').append(dayTemplate);

        $.each(planList, function(index, plan) {
            var template = `
            <div class="timeline" data-pid="${plan.plannerId}">
                <div class="outer planContainer">
                    <div>
                        <a href="" class="list-group-item list-group-item-action" aria-current="true">
                            <div class="content">
                                <div class="info">
                                    <h5 class="mb-1 title">${plan.title}</h5>
                                    <p class="mb-1">${plan.contentId}</p>
                                    <p class="mb-1">${plan.address}</p>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        `;
            $('.plan').append(template);
        });
    }



    // 현재 시간을 토대로 이동에 걸리는 시간을 구합니다.
    function getRealTime() {
        var date = new Date();
        var year = date.getFullYear();
        var month = ('0' + (date.getMonth() + 1)).slice(-2);
        var day = ('0' + (date.getDate())).slice(-2);
        var hour = ('0' + (date.getHours())).slice(-2);
        var minute = ('0' + (date.getMinutes())).slice(-2);

        var currentDate = year + month + day + hour + minute
        console.log(currentDate);
        return currentDate;
    }

    // tmap 실행
    $(document).ready(function() {
        initTmap();
    })

    function initTmap() {
        map = new Tmapv2.Map("map_div", {
            center: new Tmapv2.LatLng(36.4109466, 128.1590828),
            width: "100%",
            height: "400px",
            zoom: 8,
            zoomControl: true,
            scrollwheel: true
        });

        // 최적화 버튼을 누르면 ajax 실행
        $(".btn_optimize").click(function () {
            // 마커가 3곳 이상이 아니면 실행되지 않도록 막음
            if(viaMarkers[index].length < 3) {
                alert('경유지는 1개 이상이어야합니다.');
                return false;
            } else {
                var headers = {};
                headers["appKey"] = appKey;

                viaPoints[index] = []; // 이전 viaPoints[index] 배열을 날리고

                // 시작 장소와 종료 장소
                var start_Mapx = viaMarkers[index][0]._marker_data.options.position._lng;
                var start_Mapy = viaMarkers[index][0]._marker_data.options.position._lat;
                var end_Mapx = viaMarkers[index][viaMarkers[index].length-1]._marker_data.options.position._lng;
                var end_Mapy = viaMarkers[index][viaMarkers[index].length-1]._marker_data.options.position._lat;

                // 마커에 찍힌 경유지를 새로 받는다
                for(var i = 1; i<viaMarkers[index].length-1; i++) {
                    // 하나하나 선택한 경유지
                    var viaPoint = {};
                    viaPoint.viaPointId = i+"경유지";
                    viaPoint.viaPointName = viaMarkers[index][i]._marker_data.options.title;
                    viaPoint.viaX = viaMarkers[index][i]._marker_data.options.position._lng.toString();
                    viaPoint.viaY = viaMarkers[index][i]._marker_data.options.position._lat.toString();
                    console.log("viaPoint : " + viaPoint);

                    viaPoints[index].push(viaPoint); // 지금 담겨진 경로를 viaPoints[index] 에 담는다.
                }
                console.log(viaPoints[index]);


                $.ajax({
                    type: "POST",
                    headers: headers,
                    url: "https://apis.openapi.sk.com/tmap/routes/routeOptimization20?version=1&format=json",
                    async: false,
                    contentType: "application/json",
                    data: JSON.stringify({
                        "startName": "출발",
                        "startX": start_Mapx.toString(),
                        "startY": start_Mapy.toString(),
                        "startTime": startTime,
                        "endName": "도착",
                        "endX": end_Mapx.toString(),
                        "endY": end_Mapy.toString(),
                        "viaPoints": viaPoints[index],
                        "reqCoordType" : "WGS84GEO",
                        "resCoordType" : "EPSG3857"
                    }),
                    success:function(response){
                        var resultData = response.properties;
                        var resultFeatures = response.features;

                        // 결과 출력
                        var tDistance = "총 거리 : " + (resultData.totalDistance/1000).toFixed(1) + "km,  ";
                        var tTime = "총 시간 : " + (resultData.totalTime/60).toFixed(0) + "분,  ";
                        var tFare = "총 요금 : " + resultData.totalFare + "원";

                        resultText[index] = tDistance+tTime+tFare;
                        $(".result").text(resultText[index]);

                        // 기존 라인 초기화
                        if(resultInfoArr[index].length > 0){
                            for(var i in resultInfoArr[index]){
                                resultInfoArr[index][i].setMap(null);
                            }
                            resultInfoArr[index]=[];
                        }

                        for(var i in resultFeatures) {
                            var geometry = resultFeatures[i].geometry;
                            var polyline_ = Array.from({length: days}, () => []);

                            drawInfoArr[index] = [];

                            if(geometry.type == "LineString") {
                                for(var j in geometry.coordinates){
                                    // 경로들의 결과값(구간)들을 포인트 객체로 변환
                                    var latlng = new Tmapv2.Point(geometry.coordinates[j][0], geometry.coordinates[j][1]);
                                    // 포인트 객체를 받아 좌표값으로 변환
                                    var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(latlng);
                                    // 포인트객체의 정보로 좌표값 변환 객체로 저장
                                    var convertChange = new Tmapv2.LatLng(convertPoint._lat, convertPoint._lng);

                                    drawInfoArr[index].push(convertChange);
                                }

                                polyline_[index] = new Tmapv2.Polyline({
                                    path : drawInfoArr[index],
                                    strokeColor : "#FF0000",
                                    strokeWeight: 6,
                                    map : map
                                });
                                resultInfoArr[index].push(polyline_[index]);

                                // 경유지 최적화 결과 반경만큼 지도 레벨 조정
                                // var newData = geoData[0];
                                // PTbounds = new Tmapv2.LatLngBounds();
                                // for (var i = 0; i < newData.length; i++) {
                                //     var mData = newData[i];
                                //     var type = mData.geometry.type;
                                //     var pointType = mData.properties.pointType;
                                // }
                            }
                        }
                    },
                    error:function(request,status,error){
                        console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                    }
                });
            }
        })



        // 경로 보기 버튼을 누르면 ajax 실행
        $(".btn_route").click(function () {
            // 마커가 3곳 이상이 아니면 실행되지 않도록 막음
            if(viaMarkers[index].length < 3) {
                alert('경유지는 1개 이상이어야합니다.');
                return false;
            } else {
                var headers = {};
                headers["appKey"] = appKey;

                viaPoints[index] = []; // 이전 viaPoints[index] 배열을 날리고

                // 시작 장소와 종료 장소
                var start_Mapx = viaMarkers[index][0]._marker_data.options.position._lng;
                var start_Mapy = viaMarkers[index][0]._marker_data.options.position._lat;
                var end_Mapx = viaMarkers[index][viaMarkers[index].length-1]._marker_data.options.position._lng;
                var end_Mapy = viaMarkers[index][viaMarkers[index].length-1]._marker_data.options.position._lat;

                // 마커에 찍힌 경유지
                for(var i = 1; i<viaMarkers[index].length-1; i++) {
                    var viaPoint = {};
                    viaPoint.viaPointId = i+"경유지";
                    viaPoint.viaPointName = viaMarkers[index][i]._marker_data.options.title;
                    viaPoint.viaX = viaMarkers[index][i]._marker_data.options.position._lng.toString();
                    viaPoint.viaY = viaMarkers[index][i]._marker_data.options.position._lat.toString();
                    console.log(viaPoint);

                    viaPoints[index].push(viaPoint); // 지금 담겨진 경로를 viaPoints[index] 에 담는다.
                }
                console.log(viaPoints[index]);


                $.ajax({
                    type: "POST",
                    headers: headers,
                    url: "https://apis.openapi.sk.com/tmap/routes/routeSequential30?version=1&format=json",
                    async: false,
                    contentType: "application/json",
                    data: JSON.stringify({
                        "startName": "출발",
                        "startX": start_Mapx.toString(),
                        "startY": start_Mapy.toString(),
                        "startTime": startTime,
                        "endName": "도착",
                        "endX": end_Mapx.toString(),
                        "endY": end_Mapy.toString(),
                        "viaPoints": viaPoints[index]
                    }),
                    success:function(response){
                        var resultData = response.properties;
                        var resultFeatures = response.features;

                        // 결과 출력
                        var tDistance = "총 거리 : " + (resultData.totalDistance/1000).toFixed(1) + "km,  ";
                        var tTime = "총 시간 : " + (resultData.totalTime/60).toFixed(0) + "분,  ";
                        var tFare = "총 요금 : " + resultData.totalFare + "원";

                        resultText[index] = tDistance+tTime+tFare;
                        $(".result").text(resultText[index]);

                        // 기존 라인 초기화
                        if(resultInfoArr[index].length > 0){
                            for(var i in resultInfoArr[index]){
                                resultInfoArr[index][i].setMap(null);
                            }
                            resultInfoArr[index]=[];
                        }

                        for(var i in resultFeatures) {
                            var geometry = resultFeatures[i].geometry;
                            var polyline_;

                            drawInfoArr[index] = [];

                            if(geometry.type == "LineString") {
                                for(var j in geometry.coordinates){
                                    var point = new Tmapv2.LatLng(geometry.coordinates[j][1],geometry.coordinates[j][0]);

                                    drawInfoArr[index].push(point);
                                }

                                polyline_ = new Tmapv2.Polyline({
                                    path : drawInfoArr[index],
                                    strokeColor : "#FF0000",
                                    strokeWeight: 6,
                                    map : map
                                });
                                resultInfoArr[index].push(polyline_);


                                // 경유지 최적화 결과 반경만큼 지도 레벨 조정
                                // var newData = geoData[0];
                                // PTbounds = new Tmapv2.LatLngBounds();
                                // for (var i = 0; i < newData.length; i++) {
                                //     var mData = newData[i];
                                //     var type = mData.geometry.type;
                                //     var pointType = mData.properties.pointType;
                                // }
                            }
                        }
                    },
                    error:function(request,status,error){
                        console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                    }
                });
            }
        })


        // 전체 관광지 삭제하기 버튼을 누르면 모든 마커를 삭제
        $(".btn_delete").click(function () {
            deleteMarkers();
            if(resultInfoArr[index].length > 0){
                for(var i in resultInfoArr[index]){
                    resultInfoArr[index][i].setMap(null);
                }
                resultInfoArr[index]=[];
            }
        })
    }

</script>
<style>
.outer {
    border-left: 2px solid #333;
}

.content {
    position: relative;
    margin: 0 0 20px 20px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.info {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.title:before {
    content: "";
    position: absolute;
    width: 20px;
    height: 20px;
    background: #0d6efd;
    border-radius: 999px;
    left: -3.2rem;
    border: 3px solid #0d6efd;
}

.planContainer {
    padding: 20px;
}
</style>






<div class="d-flex flex-nowrap">
    <th:block th:replace="~{fragments/sidebar}"></th:block>
    <div class="container mt-5">
        <div id="map" class="d-flex flex-column align-items-stretch default">
            <div class="map-result position-absolute">
                <p class="result"></p>
                <button class="btn btn-primary btn_route">경로 확인</button>
                <button class="btn btn-primary btn_optimize">동선 추천</button>
            </div>
            <div id="map_div">
            </div>
        </div>



        <div class="container-fluid">
            <div id="dayButtons">
                <th:block th:each="i : ${#numbers.sequence(1, maxDay)}">
                    <button class="dayButton" th:data-day="${i}" th:text="'Day' + ${i}">Day${i}</button>
                </th:block>
            </div>

            <div class="plan">
            <p th:text="${day} + '일차'"></p>
            <div class="timeline" th:data-pid="${plannerId}">
                <div class="outer planContainer">
                    <div>
                        <a href="" class="list-group-item list-group-item-action" aria-current="true">
                            <div class="content">
                                <div class="info">
                                    <h5 class="mb-1 title">관광지 이름</h5>
                                    <p class="mb-1">컨텐츠 아이디</p>
                                    <p class="mb-1">관광지 주소</p>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>

<!--        <div class="container-fluid">-->
<!--            <div id="dayButtons">-->
<!--                <th:block th:each="plan : ${planDayList.keySet()}">-->
<!--                    <button class="dayButton" th:data-day="${day}" th:text="${day}"></button>-->
<!--                </th:block>-->
<!--            </div>-->

<!--            <div id="plansContainer">-->
<!--                <div class="timeline" th:each="dayPlansEntry : ${planDayList}">-->
<!--                    <div class="outer planContainer" th:data-day="${dayPlansEntry.key}">-->
<!--                        <p th:text="${dayPlansEntry.key}"></p>-->
<!--                        <div th:each="plan : ${dayPlansEntry.value}">-->
<!--                            <a th:href="@{/info/content/{contentid}(contentid=${plan.tourItem.contentid})}" class="list-group-item list-group-item-action" aria-current="true">-->
<!--                                <div class="content">-->
<!--                                    <div class="info">-->
<!--                                        <h5 class="mb-1 title" th:text="${plan.tourItem.title}"></h5>-->
<!--                                        <p class="mb-1" th:text="${plan.tourItem.contentid}"></p>-->
<!--                                        <p class="mb-1" th:text="${plan.tourItem.addr1}"></p>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </a>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->


    </div>

</div>
</body>
</html>