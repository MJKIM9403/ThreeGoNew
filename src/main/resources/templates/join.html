<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">


<!-- 코드언어 표시 == 웹 표준지침 준수 -->
<head>
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Bootstrap icons-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
          type="text/css"/>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Noto+Sans+KR:wght@100;200;300;400;500;600;700;800;900&display=swap"
          rel="stylesheet">
    <!-- jquery-->
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="assets/css/style.css?after" rel="stylesheet"/>
    <link href="assets/css/commonstyle.css?after" rel="stylesheet"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>회원가입</title>

</head>

<style>

    .container {
        padding-left: 0;
    }

    .body-form {
        background-image: url('/assets/img/mainimg/gangwon.jpg');
        background-size: cover;
        background-repeat: no-repeat;
        max-height: max-content;
    }

    .body-form::before {
        position: absolute;
        content: "";
        top: 0px;
        left: 0px;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.1);
    }

    .joindiv {
        margin-top: 2em;
        padding-left: 5em;
        padding-right: 5em;
        padding-top: 3em;
        padding-bottom: 3em;
        border-radius: 30px;
        background-color: #ffffff;
        background-color: rgba(255, 255, 255, 0.9);
        width: 50%;
    }

</style>
<body class="body-form">

<div class="d-flex flex-nowrap">
    <!--    <th:block th:replace="~{fragments/sidebar}"></th:block>-->

    <div class="w3-content w3-container w3-margin-top container position-relative pb-5 " style="margin: 0 auto;">


        <!--    &lt;!&ndash;허전해서 이미지&ndash;&gt;-->
        <!--        <div class="w3-content w3-container container position-relative pb-5 headerImg"-->
        <!--             style="background-image: url('/assets/img/mainimg/daejeon2.jpg');-->
        <!--         background-size: cover;-->
        <!--         height: 15em;-->
        <!--         margin-bottom: 3em;">-->
        <!--        </div>-->


        <div id="wrap" class="container position-relative pb-5 joindiv ">
            <form th:action="@{/api/users/register}" th:method="post" onsubmit="return false" name="joinForm"
                  enctype="application/json">

                <!-- 회원가입 타이틀부분 -->
                <div id="header">
                    <h1 class="text-center">
                        <!--<span><img alt="프로젝트 메인 제목" src="#"></span>-->
                        회원가입 정보 입력
                    </h1>
                    <p class="text-center">회원가입에 필요한 정보를 기입해주세요.</p>
                </div>

                <div id="container">
                    <div class="row_group">
                        <div class="userInput mb-5">
                            <h4 class="list">아이디</h4>
                            <div class="input-group">
                                <!-- 아이디 입력 -->
                                <input type="text" name="id" class="form-control form-control-sm" maxlength="20"
                                       placeholder="아이디를 입력하세요."/>
                                <!--아이디 중복확인-->
                                <input type="button" value="중복 확인" class="btn btn-primary btn-sm" id="idCheckBtn">

                                <!--                        중복확인?-->
                                <div id="idAvailable" class="valid-feedback" style="display: none;"></div>
                                <div id="idNotAvailable" class="invalid-feedback" style="display: none;"></div>


                            </div>
                        </div>

                        <div class="userInput mb-5">
                            <!-- 비밀번호 입력 -->
                            <div class="pw_box">
                                <h4 class="list">비밀번호</h4>
                                <div class="pw_info">※알파벳 대문자, 소문자, 숫자와 특수문자[!@#$%^*+=-]를<br> 모두 포함하는 8~15자리로 작성하여 주십시오.
                                </div>
                            </div>
                            <input type="password" name="pw" id="pw" class="form-control form-control-sm" maxlength="20"
                                   placeholder="비밀번호를 입력하세요.">
                        </div>

                        <!-- 비밀번호 재확인 입력 -->
                        <div class="userInput mb-5">
                            <h4 class="list">비밀번호 재확인</h4>
                            <input type="password" name="pwconfirm" id="pwconfirm" class="form-control form-control-sm"
                                   maxlength="20" placeholder="입력한 비밀번호를 확인해주세요.">
                        </div>

                        <!-- 성명 입력 -->
                        <div class="userInput mb-5">
                            <h4 class="list">성명</h4>
                            <input type="text" name="name" id="name" class="form-control form-control-sm" maxlength="20"
                                   placeholder="이름을 입력해주세요.">
                        </div>

                        <!-- 이메일 입력 -->
                        <div class="userInput mb-5">
                            <h4 class="list">이메일</h4>
                            <div class="input-group">
                                <input type="email" name="email" id="emailCheck" class="form-control form-control-sm"
                                       placeholder="이메일을 입력해주세요.">
                                <!--이메일 인증-->
                                <input type="button" value="인증하기" class="btn btn-primary btn-sm" id="emailCheckBtn">

                                <div id="emailAvailable" class="valid-feedback" style="display: none;"></div>
                                <div id="emailNotAvailable" class="invalid-feedback" style="display: none;"></div>

                            </div>

                        </div>
                        <!--                            버튼-->
                        <div class="col text-center mb-5">
                            <button type="button" value="취소" id="cancelBtn" class="btn btn-secondary"
                                    onClick="location.href='/review'">취소
                            </button>

                            <input type="submit" value="가입" id="joinBtn" class="btn btn-primary btn-md">
                        </div>

                    </div>
                </div>
            </form>
        </div>


        <!--footer-->
        <!--        <th:block th:replace="~{fragments/footer}"></th:block>-->
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            let emailCheck = false;
            let idCheck = false;

            document.getElementById('joinBtn').addEventListener('click', function (event) {
                // 간단한 유효성 검사
                let reg_pw = /^(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^*+=-])(?=.*[0-9]).{8,15}$/;
                let id = document.getElementsByName('id')[0].value;
                let pw = document.getElementsByName('pw')[0].value;
                let pwconfirm = document.getElementsByName('pwconfirm')[0].value;
                let name = document.getElementsByName('name')[0].value;
                let email = document.getElementsByName('email')[0].value;

                if (id === "") {
                    alert('아이디를 입력해주십시오.');
                    event.preventDefault(); // 폼 제출 막기
                    document.getElementsByName('id')[0].focus();
                    return false;
                } else if (pw === "") {
                    alert('비밀번호를 입력해주십시오.');
                    event.preventDefault(); // 폼 제출 막기
                    document.getElementsByName('pw')[0].focus();
                    return false;
                } else if (pwconfirm === "") {
                    alert('비밀번호 재확인을 입력해주십시오.');
                    event.preventDefault(); // 폼 제출 막기
                    document.getElementsByName('pwconfirm')[0].focus();
                    return false;
                } else if (name === "") {
                    alert('성명을 입력해주십시오.');
                    event.preventDefault(); // 폼 제출 막기
                    document.getElementsByName('name')[0].focus();
                    return false;
                } else if (email === "") {
                    alert('이메일을 입력해주십시오.');
                    event.preventDefault(); // 폼 제출 막기
                    document.getElementsByName('email')[0].focus();
                    return false;
                } else if (!idCheck) {
                    alert('아이디 중복을 확인하여 주십시오.');
                    event.preventDefault(); // 폼 제출 막기
                    document.getElementsByName('id')[0].focus();
                    return false;
                } else if (!reg_pw.test(pw)) {
                    alert('비밀번호 양식을 다시 확인하여 주십시오.');
                    event.preventDefault(); // 폼 제출 막기
                    console.log(event.target);
                    document.getElementsByName('pw')[0].focus();
                    return false;
                } else if (pw !== pwconfirm) {
                    alert('비밀번호와 비밀번호 재입력 값이 같아야 합니다.');
                    event.preventDefault(); // 폼 제출 막기
                    document.getElementsByName('pwconfirm')[0].focus();
                    return false;
                } else if (!emailCheck) {
                    alert('이메일을 인증하여 주십시오.');
                    event.preventDefault(); // 폼 제출 막기
                    document.getElementsByName('email')[0].focus();
                    return false;
                }

                // 데이터를 JSON 형식으로 구성
                let userData = {
                    id: id,
                    pw: pw,
                    name: name,
                    email: email
                };

                // 서버로 데이터 전송
                $.ajax({
                    url: '/api/users/register',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(userData),
                    success: function (response) {
                        // Ajax 요청 성공 시 처리
                        alert(response); // "가입을 환영합니다: 사용자ID"가 표시됩니다.

                        // 페이지 이동
                        window.location.href = '/review'; // 원하는 페이지 URL로 수정하세요.
                    },
                    error: function (error) {
                        // Ajax 요청 실패 시 처리
                        console.error(error);
                    }
                });
            });


            // TODO : 이메일 체크
            //

            //원본
            document.getElementById('emailCheckBtn').addEventListener('click', function () {
                let regExp = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/i;
                let testEmails = document.getElementsByName('email')[0].value;

                if (!regExp.test(testEmails)) {
                    emailCheck = false;
                    alert('이메일 형식이 올바르지 않습니다.');
                } else {
                    emailCheck = true;
                    alert('적절한 이메일 주소 입니다.');
                }
            });


            document.getElementById('idCheckBtn').addEventListener('click', function () {
                console.log('Button clicked');
                let enteredId = document.getElementsByName('id')[0].value;
                // 빈 칸인 경우 처리
                if (enteredId === "") {
                    alert('아이디를 입력해주세요.');
                    return;
                }
                $.ajax({
                    url: '/checkDuplicateId',
                    type: 'GET',
                    dataType: 'text',
                    data: {
                        userId: enteredId
                    },
                    success: function (result) {
                        // 메시지 초기화
                        $('#idAvailable').hide().text('');
                        $('#idNotAvailable').hide().text('');

                        // 아이디 입력 필드를 읽기 전용으로 변경
                        console.log(result);
                        let duplicate = result == "true" ? true : false
                        if (duplicate) {
                            // 중복된 아이디가 존재할 경우
                            $('#idNotAvailable').show().text('이미 사용 중인 아이디입니다.');
                            console.log("중복: " + duplicate);
                            idCheck = false;
                        } else {
                            // 사용 가능한 아이디일 경우
                            $('#idAvailable').show().text('사용 가능한 아이디입니다.');
                            console.log("가능: " + duplicate);
                            idCheck = true;
                        }
                    },
                    error: function (xhr, status, error) {
                        // 에러 메시지 출력
                        console.error("Error:", error);

                        // 추가로 에러 콘솔에 에러 상세 정보 출력
                        console.error("XHR:", xhr);
                    }
                });
            });


        </script>


    </div>
</div>
</body>
</html>
