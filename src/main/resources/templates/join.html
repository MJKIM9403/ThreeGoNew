<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">


<!-- 코드언어 표시 == 웹 표준지침 준수 -->
<head>
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Bootstrap icons-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css" type="text/css" />
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Noto+Sans+KR:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- jquery-->
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="assets/css/style.css?after" rel="stylesheet" />
    <link href="assets/css/commonstyle.css?after" rel="stylesheet"/>
    <title>회원가입</title>
    <link rel = "icon" href="image/wave.ico">

</head>
<body>

<!--<c:if test="${ joinResult == 0}"></c:if>-->
<!--header-->
<th:block th:replace="~{fragments/header}"></th:block>

<div class="sub-header">
    <div class="container pt-5 pl-5">
        <h3 class="display-6 text-white">마이페이지</h3>
    </div>
</div>
<div id="wrap" class="container position-relative pt-5 pb-5">
    <form th:action="@{/api/users/register}" th:method="post" onsubmit="return false"  name="joinForm"  enctype="application/json">

    <!-- 회원가입 타이틀부분 -->
        <div id="header">
            <h1 class="text-center">
                <!--<span><img alt="프로젝트 메인 제목" src="#"></span>-->
                회원가입 정보 입력
            </h1>
            <p class="text-center">회원가입에 필요한 정보를 기입해주세요.</p>
        </div>

        <div id="container">
            <div class="row_group">
                <div class="userInput mb-5">
                    <h4 class="list">아이디</h4>
                    <div class="input-group">
                        <!-- 아이디 입력 -->
                        <input type="text" name="id" class="form-control form-control-sm" maxlength="20" placeholder="아이디를 입력하세요."/>
                        <!--아이디 중복확인-->
                        <input type="button" value="중복 확인" class="btn btn-primary btn-sm" id="idCheckBtn">

<!--                        중복확인?-->
                        <div id="idAvailable" class="valid-feedback" style="display: none;"></div>
                        <div id="idNotAvailable" class="invalid-feedback" style="display: none;"></div>


                    </div>
                </div>

                <div class="userInput mb-5">
                    <!-- 비밀번호 입력 -->
                    <div class="pw_box">
                        <h4 class="list">비밀번호</h4>
                        <div class="pw_info">※알파벳 대문자, 소문자, 숫자와 특수문자[!@#$%^*+=-]를 모두 포함하는 8~15자리로 작성하여 주십시오.</div>
                    </div>
                    <input type="password" name="pw" id="pw" class="form-control form-control-sm" maxlength="20" placeholder="비밀번호를 입력하세요.">
                </div>

                <!-- 비밀번호 재확인 입력 -->
                <div class="userInput mb-5">
                    <h4 class="list">비밀번호 재확인</h4>
                    <input type="password" name="pwconfirm" id="pwconfirm" class="form-control form-control-sm" maxlength="20" placeholder="입력한 비밀번호를 확인해주세요.">
                </div>

                <!-- 성명 입력 -->
                <div class="userInput mb-5">
                    <h4 class="list">성명</h4>
                    <input type="text" name="name" id="name" class="form-control form-control-sm" maxlength="20" placeholder="이름을 입력해주세요.">
                </div>

                <!-- 이메일 입력 -->
                <div class="userInput mb-5">
                    <h4 class="list">이메일</h4>
                    <div class="input-group">
                        <input type="email" name="email" id="emailCheck" class="form-control form-control-sm" placeholder="이메일을 입력해주세요.">
                        <!--이메일 인증-->
                        <input type="button" value="인증하기" class="btn btn-primary btn-sm" id="emailCheckBtn">

                        <div id="emailAvailable" class="valid-feedback" style="display: none;"></div>
                        <div id="emailNotAvailable" class="invalid-feedback" style="display: none;"></div>

                    </div>
                </div>

                <!-- 가입버튼-->
                <div class="col text-center mb-5">
                    <input type="submit" value="가입" id="joinBtn" class="btn btn-primary btn-md">
                </div>
            </div>
        </div>
    </form>
</div>
<!--footer-->
<th:block th:replace="~{fragments/footer}"></th:block>
<!-- Bootstrap core JS-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let emailCheck = false;
    let idCheck = false;

    document.getElementById('joinBtn').addEventListener('click', function(event) {
        // 간단한 유효성 검사
        let reg_pw = /^(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^*+=-])(?=.*[0-9]).{8,15}$/;
        let id = document.getElementsByName('id')[0].value;
        let pw = document.getElementsByName('pw')[0].value;
        let pwconfirm = document.getElementsByName('pwconfirm')[0].value;
        let name = document.getElementsByName('name')[0].value;
        let email = document.getElementsByName('email')[0].value;

        if (id === "") {
            alert('아이디를 입력해주십시오.');
            event.preventDefault(); // 폼 제출 막기
            document.getElementsByName('id')[0].focus();
            return false;
        } else if (pw === "") {
            alert('비밀번호를 입력해주십시오.');
            event.preventDefault(); // 폼 제출 막기
            document.getElementsByName('pw')[0].focus();
            return false;
        } else if (pwconfirm === "") {
            alert('비밀번호 재확인을 입력해주십시오.');
            event.preventDefault(); // 폼 제출 막기
            document.getElementsByName('pwconfirm')[0].focus();
            return false;
        } else if (name === "") {
            alert('성명을 입력해주십시오.');
            event.preventDefault(); // 폼 제출 막기
            document.getElementsByName('name')[0].focus();
            return false;
        } else if (email === "") {
            alert('이메일을 입력해주십시오.');
            event.preventDefault(); // 폼 제출 막기
            document.getElementsByName('email')[0].focus();
            return false;
        } else if (!idCheck) {
            alert('아이디 중복을 확인하여 주십시오.');
            event.preventDefault(); // 폼 제출 막기
            document.getElementsByName('id')[0].focus();
            return false;
        } else if (!reg_pw.test(pw)) {
            alert('비밀번호 양식을 다시 확인하여 주십시오.');
            event.preventDefault(); // 폼 제출 막기
            console.log(event.target);
            document.getElementsByName('pw')[0].focus();
            return false;
        } else if (pw !== pwconfirm) {
            alert('비밀번호와 비밀번호 재입력 값이 같아야 합니다.');
            event.preventDefault(); // 폼 제출 막기
            document.getElementsByName('pwconfirm')[0].focus();
            return false;
        } else if (!emailCheck) {
            alert('이메일을 인증하여 주십시오.');
            event.preventDefault(); // 폼 제출 막기
            document.getElementsByName('email')[0].focus();
            return false;
        }

        // 데이터를 JSON 형식으로 구성
        let userData = {
            id: id,
            pw: pw,
            name: name,
            email: email
        };

        // 서버로 데이터 전송
        $.ajax({
            url: '/api/users/register',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(userData),
            success: function(response) {
                // Ajax 요청 성공 시 처리
                alert(response); // "가입을 환영합니다: 사용자ID"가 표시됩니다.

                // 페이지 이동
                window.location.href = '/index'; // 원하는 페이지 URL로 수정하세요.
            },
            error: function(error) {
                // Ajax 요청 실패 시 처리
                console.error(error);
            }
        });
    });


    // TODO : 이메일 체크
    //
    // document.getElementById('emailCheckBtn').addEventListener('click', function () {
    //     let regExp = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/i;
    //     let testEmails = document.getElementsByName('email')[0].value;
    //
    //     if (!regExp.test(testEmails)) {
    //         emailCheck = false;
    //         alert('이메일 형식이 올바르지 않습니다.');
    //     } else {
    //         // 서버로 이메일 중복 확인 요청
    //         $.ajax({
    //             url: '/checkDuplicateEmail',
    //             type: 'GET',
    //             data: {
    //                 userEmail: testEmails
    //             },
    //             success: function (result) {
    //                 // 메시지 초기화
    //                 $('#emailAvailable').hide().text('');
    //                 $('#emailNotAvailable').hide().text('');
    //
    //                 if (result === true) {
    //                     // 중복된 이메일이 존재할 경우
    //                     $('#emailNotAvailable').show().text('이미 사용 중인 이메일입니다.');
    //                     emailCheck = false;
    //                     console.log(result);
    //                 } else {
    //                     // 사용 가능한 이메일일 경우
    //                     $('#emailAvailable').show().text('사용 가능한 이메일입니다.');
    //                     emailCheck = true;
    //                     console.log(result);
    //                 }
    //             },
    //             error: function (xhr, status, error) {
    //                 // 에러 메시지 출력
    //                 console.error("Error:", error);
    //             }
    //         });
    //     }
    // });

    //원본
    document.getElementById('emailCheckBtn').addEventListener('click', function () {
        let regExp = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/i;
        let testEmails = document.getElementsByName('email')[0].value;

        if (!regExp.test(testEmails)) {
            emailCheck = false;
            alert('이메일 형식이 올바르지 않습니다.');
        } else {
            emailCheck = true;
            alert('적절한 이메일 주소 입니다.');
        }
    });



    document.getElementById('idCheckBtn').addEventListener('click', function () {
        console.log('Button clicked');
        let enteredId = document.getElementsByName('id')[0].value;

        // 빈 칸인 경우 처리
        if (enteredId === "") {
            alert('아이디를 입력해주세요.');
            return;
        }
        $.ajax({
            url: '/checkDuplicateId',
            type: 'GET',
            data: {
                userId: enteredId
            },
            success: function (result) {
                // 메시지 초기화
                $('#idAvailable').hide().text('');
                $('#idNotAvailable').hide().text('');

                // 아이디 입력 필드를 읽기 전용으로 변경
                $('input[name=id]').prop('readonly', true);

                if (result === true) {
                    // 중복된 아이디가 존재할 경우
                    $('#idNotAvailable').show().text('이미 사용 중인 아이디입니다.');
                    idCheck = false;
                    // console.log(result);
                } else {
                    // 사용 가능한 아이디일 경우
                    $('#idAvailable').show().text('사용 가능한 아이디입니다.');
                    idCheck = true;
                    // console.log(result);
                }
            },
            error: function (xhr, status, error) {
                // 에러 메시지 출력
                console.error("Error:", error);

                // 추가로 에러 콘솔에 에러 상세 정보 출력
                console.error("XHR:", xhr);
            }
        });
    });









</script>



</body>
</html>
