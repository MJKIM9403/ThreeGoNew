<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">


<!-- 코드언어 표시 == 웹 표준지침 준수 -->
<head>
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Bootstrap icons-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
          type="text/css"/>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Noto+Sans+KR:wght@100;200;300;400;500;600;700;800;900&display=swap"
          rel="stylesheet">
    <!-- jquery-->
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="assets/css/style.css?after" rel="stylesheet"/>
    <link href="assets/css/commonstyle.css?after" rel="stylesheet"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>회원가입</title>

</head>

<style>

    .container {
        padding-left: 0;
    }

    .body-form {
        background-image: url('/assets/img/mainimg/gangwon.jpg');
        background-size: cover;
        background-repeat: no-repeat;
        max-height: max-content;
    }

    .body-form::before {
        position: absolute;
        content: "";
        top: 0px;
        left: 0px;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.1);
    }

    .joindiv {
        margin-top: 2em;
        padding-left: 5em;
        padding-right: 5em;
        padding-top: 3em;
        padding-bottom: 3em;
        border-radius: 30px;
        background-color: #ffffff;
        background-color: rgba(255, 255, 255, 0.9);
        width: 50%;
    }

</style>
<body class="body-form">

<div class="d-flex flex-nowrap">
    <!--    <th:block th:replace="~{fragments/sidebar}"></th:block>-->

    <div class="w3-content w3-container w3-margin-top container position-relative pb-5 " style="margin: 0 auto;">

        <div id="wrap" class="container position-relative pb-5 joindiv ">
            <form th:action="@{/api/users/register}" th:method="post" onsubmit="return false" name="joinForm"
                  enctype="application/json">

                <!-- 회원가입 타이틀부분 -->
                <div id="header">
                    <h1 class="text-center">
                        <!--<span><img alt="프로젝트 메인 제목" src="#"></span>-->
                        회원가입 정보 입력
                    </h1>
                    <p class="text-center">회원가입에 필요한 정보를 기입해주세요.</p>
                </div>

                <div id="container">
                    <div class="row_group">
                        <div class="userInput mb-5">
                            <h4 class="list">아이디</h4>
                            <div class="input-group">
                                <!-- 아이디 입력 -->
                                <input type="text" name="id" class="form-control form-control-sm" maxlength="20"
                                       placeholder="아이디를 입력하세요."/>
                                <!--아이디 중복확인-->
                                <input type="button" value="중복 확인" class="btn btn-primary btn-sm" id="idCheckBtn">
                                <!--                        중복확인?-->
                                <div id="idAvailable" class="valid-feedback" style="display: none;"></div>
                                <div id="idNotAvailable" class="invalid-feedback" style="display: none;"></div>
                            </div>
                        </div>

                        <div class="userInput mb-5">
                            <!-- 비밀번호 입력 -->
                            <div class="pw_box">
                                <h4 class="list">비밀번호</h4>
                                <div class="pw_info">※알파벳 대문자, 소문자, 숫자와 특수문자[!@#$%^*+=-]를<br> 모두 포함하는 8~15자리로 작성하여 주십시오.
                                </div>
                            </div>
                            <input type="password" name="pw" id="pw" class="form-control form-control-sm" maxlength="20"
                                   placeholder="비밀번호를 입력하세요.">
                        </div>

                        <!-- 비밀번호 재확인 입력 -->
                        <div class="userInput mb-5">
                            <h4 class="list">비밀번호 재확인</h4>
                            <input type="password" name="pwconfirm" id="pwconfirm" class="form-control form-control-sm"
                                   maxlength="20" placeholder="입력한 비밀번호를 확인해주세요.">
                        </div>

                        <!-- 성명 입력 -->
                        <div class="userInput mb-5">
                            <h4 class="list">성명</h4>
                            <input type="text" name="name" id="name" class="form-control form-control-sm" maxlength="20"
                                   placeholder="이름을 입력해주세요.">
                        </div>

                        <!-- 이메일 입력 -->
                        <div class="userInput mb-5">
                            <h4 class="list">이메일</h4>
                            <div class="input-group">
                                <!--                                새로운 이메일 인증-->
                                <input type="email" name="email" id="email" class="form-control form-control-sm"
                                       placeholder="이메일을 입력해주세요.">
                                <button type="button" id="sendBtn" name="sendBtn" onclick="sendNumber()">인증번호보내기</button>
                            </div>
                            <br>
                            <div id="mail_number" name="mail_number" style="display: none">
                                <input type="text" name="number" id="number" style="width:250px; margin-top: -10px"
                                       placeholder="인증번호 입력">
                                <button type="button" name="confirmBtn" id="confirmBtn" onclick="confirmNumber()">이메일 인증 </button>
                                <div id="emailAvailable" class="valid-feedback" style="display: none;"></div>
                                <div id="emailNotAvailable" class="invalid-feedback" style="display: none;"></div>

                            </div>

                        </div>


                    </div>
                </div>
            </form>
            <!-- 버튼-->
            <div class="col text-center mb-5">
                <button type="button" value="취소" id="cancelBtn" class="btn btn-primary2 btn-md"
                        onClick="location.href='/review'">취소
                </button>

                <input type="submit" value="가입" id="joinBtn" class="btn-join btn btn-primary btn-md">
            </div>
        </div>


        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>

            let emailCheck = false;
            let idCheck = false;

            let emailAuthNum = null;

            document.getElementById('joinBtn').addEventListener('click', function (event) {
                // 간단한 유효성 검사
                let reg_pw = /^(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^*+=-])(?=.*[0-9]).{8,15}$/;
                let id = document.getElementsByName('id')[0].value;
                let pw = document.getElementsByName('pw')[0].value;
                let pwconfirm = document.getElementsByName('pwconfirm')[0].value;
                let name = document.getElementsByName('name')[0].value;
                let email = document.getElementsByName('email')[0].value;

                // 데이터를 JSON 형식으로 구성
                let userData = {
                    id: id,
                    pw: pw,
                    name: name,
                    email: email
                };

                // 서버로 데이터 전송
                $.ajax({
                    url: '/api/users/register',
                    type: 'POST',
                    contentType: 'application/json;charset=utf-8',
                    data: JSON.stringify(userData),
                    success: function (response) {
                        // Ajax 요청 성공 시 처리
                        alert(response); // "가입을 환영합니다: 사용자ID"가 표시됩니다.

                        // 페이지 이동
                        window.location.href = '/review'; // 원하는 페이지 URL로 수정하세요.
                    },
                    error: function (error) {
                        // Ajax 요청 실패 시 처리
                        console.error(error);
                    }
                });
            });

            document.getElementById('idCheckBtn').addEventListener('click', function () {
                console.log('Button clicked');
                let enteredId = document.getElementsByName('id')[0].value;
                // 빈 칸인 경우 처리
                if (enteredId === "") {
                    alert('아이디를 입력해주세요.');
                    return;
                }
                $.ajax({
                    url: '/checkDuplicateId',
                    type: 'GET',
                    dataType: 'text',
                    data: {
                        userId: enteredId
                    },
                    success: function (result) {
                        // 메시지 초기화
                        $('#idAvailable').hide().text('');
                        $('#idNotAvailable').hide().text('');

                        // 아이디 입력 필드를 읽기 전용으로 변경
                        let duplicate = result == "true" ? true : false
                        if (duplicate) {
                            // 중복된 아이디가 존재할 경우
                            $('#idNotAvailable').show().text('이미 사용 중인 아이디입니다.');
                            console.log("중복: " + duplicate);
                            idCheck = false;
                        } else {
                            // 사용 가능한 아이디일 경우
                            $('#idAvailable').show().text('사용 가능한 아이디입니다.');
                            idCheck = true;
                        }
                    },
                    error: function (xhr, status, error) {
                        // 에러 메시지 출력
                        console.error("Error:", error);
                        console.error("XHR:", xhr);
                    }
                });
            });



            //     이메일 인증
            function sendNumber() {
                let email = document.getElementsByName('email')[0].value;
                let regExp = /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/i;
                let testEmails = document.getElementsByName('email')[0].value;

                // 이메일 주소가 비어있을 경우 처리
                if (email.trim() === "") {
                    alert("이메일을 입력해주세요.");
                    return;
                }
                //이메일 유효성 안맞을시 빠꾸
                if (!regExp.test(testEmails)) {
                    emailCheck = false;
                        alert('이메일 형식이 올바르지 않습니다.');
                        return;
                    event.preventDefault(); // 폼 제출 막기
                    } else {
                        emailCheck = true;
                        alert('적절한 이메일 주소 입니다.');
                }


                console.log("번호보내기클릭");
                $("#mail_number").css("display", "block");
                alert("입력한 메일로 인증번호를 발송하였습니다.")

                $.ajax({
                    url: "/api/join/sendEmail",
                    type: "post",
                    dataType: 'text',
                    data: JSON.stringify({
                        email : email
                    }),
                    contentType: "application/json",
                    success: function (authNum) {
                        emailAuthNum = authNum;
                        console.log("성공했을지도?");
                    }, error: function (request, status, error) {
                        alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                        alert("인증 보내기 실패")
                    }
                });
            }

            // 인증 번호 보낸 거랑. 보낸 번호랑 확인해야함.
            function confirmNumber() {
                var inputNum = $("#number").val();

                if (emailAuthNum == inputNum) {
                    alert("인증되었습니다.");
                } else {
                    alert("인증번호가 다릅니다.");
                }
            }

        </script>


    </div>
</div>
</body>
</html>
