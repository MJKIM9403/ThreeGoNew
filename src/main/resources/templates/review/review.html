<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Bootstrap icons-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
          type="text/css"/>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Noto+Sans+KR:wght@100;200;300;400;500;600;700;800;900&display=swap"
          rel="stylesheet">
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="../assets/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="../assets/css/style.css?after" rel="stylesheet"/>
    <link href="../assets/css/commonstyle.css?after" rel="stylesheet"/>

    <!--swiper-->
    <link href="../assets/swiper/swiper-bundle.min.css" rel="stylesheet"/>
    <script src="../assets/swiper/swiper-bundle.min.js"></script>

    <!--  my page 적용 템플릿 스타일 시트  -->
    <link href="../assets/css/mypagestyle.css" rel="stylesheet"/>
    <!--  review 적용 템플릿 스타일 시트  -->
    <link href="../assets/css/reviewviewer.css" rel="stylesheet"/>

    <title>Three Go</title>

    <style>
        .container {
            padding-left: 0px;
            margin-left: 296px;
            width: 100vw;
            display: flex;
            justify-content: center;
        }

        /*card*/
        .card {
            width: 600px;
            margin-bottom: 2em;

        }

        .card .card-header img {
            width: 24px;
            height: 24px;
        }

        .card .card-body img {
            height: 480px;
            /*height: 585px;*/
        }

        .card-header {
            background-color: transparent;
        }

        /*  리뷰작성 관련  */
        #new-review-btn {
            bottom: 5%;
            right: 5%;
        }

        .container-fluid {
            height: 100%;
        }

        .container-fluid .row {
            height: 100%;
        }


        .preview-container {
            position: relative;
            padding: 0 !important;
            height: 100%;
        }

        .delete-img-btn {
            position: absolute;
            top: 5%;
            right: 5%;
        }

        .add-file {
            position: absolute;
            bottom: 5%;
            right: 5%;
            z-index: 100;
        }

        #img-uploader {
            display: none;
        }

        .uploader {
            padding: 10px;
            color: #136DF8;
            cursor: pointer;
        }

        .uploader:hover {
            background-color: #136DF8;
            color: #FFFFFF;
            transition: all 0.2s;
        }

        .select-hint {
            display: none;
        }

        #review-contents {
            height: 380px;
            resize: none;
        }

        #create-book-btn {
            --bs-btn-padding-y: 0.25rem;
            --bs-btn-padding-x: 0.5rem;
            --bs-btn-font-size: 0.875rem;
            --bs-btn-border-radius: 0.25rem;
        }

        /* swiper */
        .swiper {
            width: 100%;
            height: 750px;
            overflow: hidden;
        }

        .swiper-slide {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            font-size: 18px;
            color: #999999;
            background: #333333;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .swiper-slide img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }


    </style>

</head>
<body>

<div class="d-flex">
    <th:block th:replace="~{fragments/sidebar}"></th:block>

    <div class="container d-flex justify-content-center">
        <div class="container justify-content-center">
            <ul class="nav nav-underline mb-3 justify-content-center">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" onclick="changeTab('RECOMMEND')">추천 리뷰</a>
                </li>
                <li sec:authorize="isAuthenticated()" class="nav-item">
                    <a class="nav-link" onclick="changeTab('FOLLOW')">팔로우 리뷰</a>
                </li>
            </ul>
            <div id="content" class="p-4 p-md-5 gallery">
                <div class="card gallery-item">
                    <!--유저 정보-->
                    <div class="d-flex card-header gap-2">
                        <img src=`/api/image/profile/${review.userInfo.profileImg}` alt="mdo"
                             class="rounded-circle">
                        <span text=`${review.userInfo.name}`></span>
                        <span text=`${review.userInfo.id}`></span>
                    </div>
                    <div class="card-body">
                        <!--유저가 업로드한 이미지-->
                        <div class=`swiper simple-view-swiper simple-view-swiper${index}`>
                            <div class="swiper-wrapper">
                                <th:block th:each="photo : ${review.reviewPhotoList}">
                                    <div class="swiper-slide">
                                        <img class="simple-view-img" th:src="|@{/api/image/review/}${photo.filePath}|"/>
                                    </div>
                                </th:block>
                            </div>
                            <div th:class="|swiper-controller swiper-controller${reviewState.index}|">
                                <div th:class="|swiper-button-next swiper-button-next${reviewState.index}|"></div>
                                <div th:class="|swiper-button-prev swiper-button-prev${reviewState.index}|"></div>
                                <div th:class="|swiper-pagination swiper-pagination${reviewState.index}|"></div>
                            </div>
                        </div>
                        <!--좋아요와 댓글 -->
                        <div class="review-icons d-flex gap-3">
                            <i class="bi bi-chat-square-dots" th:onclick="goComment([[${review.reviewId}]])"></i>
                            <i class="like-btn bi" th:classappend="${review.likeState ? 'bi-star-fill' : 'bi-star'}" th:data-review-id="${review.reviewId}"></i>
                        </div>

                        <p class="like-count text-muted card-text" th:data-review-id="${review.reviewId}" th:text="|${review.likeCount} 명이 이 리뷰를 좋아합니다.|"></p>
                        <div class="review-content" th:utext="${review.reviewContent}"></div>
                        <div class="card-text"><small class="text-muted comment-count" th:data-review-id="${review.reviewId}" th:text="|댓글 ${review.commentCount}개|"></small></div>
                        <div class="card-text show-more" th:onclick="openViewer([[${review.reviewId}]])"><small class="text-muted">자세히 보기</small></div>
                    </div>
                </div>

            </div>

            <div id="load-point"></div>
            <div class="loader"></div>
        </div>
    </div>

    <div id="select-book" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
         aria-labelledby="selectBookLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="selectBookLabel">리뷰북 선택</h1>
                </div>
                <div class="modal-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="selectReviewBook" id="selectReviewBook1"
                               value="1">
                        <label class="form-check-label" for="selectReviewBook1">
                            새 리뷰북 생성
                            <button id="create-book-btn" type="button" class="btn btn-outline-primary btn-sm ms-1"
                                    onclick="createSimpleBook()">생성
                            </button>
                            <select id="new-book-item-select" class="book-input form-select form-select-sm mt-2"
                                    aria-label="Default select example" onchange="writeBookTitle()">
                                <option value="hint" class="select-hint" selected>리뷰북에 기록할 여행정보를 선택하세요.</option>
                            </select>
                            <input id="new-book-title" class="book-input form-control form-control-sm mt-2"
                                   type="text" placeholder="제목을 입력해주세요." aria-label=".form-control-sm example">
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="selectReviewBook" id="selectReviewBook2"
                               value="2">
                        <label class="form-check-label" for="selectReviewBook2">
                            기존 리뷰북에 추가
                            <select id="exist-book-select" class="book-input form-select form-select-sm mt-2"
                                    aria-label="Default select example">
                                <option value="hint" class="select-hint" selected>리뷰를 작성할 리뷰북을 선택하세요.</option>
                            </select>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="selectReviewBook" id="selectReviewBook3"
                               value="3">
                        <label class="book-input form-check-label" for="selectReviewBook3">
                            리뷰북을 선택하지 않고 리뷰 작성
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-sm btn-primary" onclick="goEdit()">다음</button>
                </div>
            </div>
        </div>
    </div>
    <div id="editor" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
         aria-labelledby="editorLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="container-fluid">
                    <div class="row">
                        <div class="preview-container col-md-7">
                            <div class="add-file">
                                <label for="img-uploader" class="uploader border border-primary rounded-pill">사진
                                    추가</label>
                                <input type="file" id="img-uploader" accept="image/*" onchange="setPreview()"
                                       multiple/>
                            </div>
                            <div class="swiper editSwiper">
                                <div class="swiper-wrapper">
                                    <div class="swiper-slide">사진을 추가해주세요.</div>
                                </div>
                                <div class="swiper-controller">
                                    <div class="swiper-button-next"></div>
                                    <div class="swiper-button-prev"></div>
                                    <div class="swiper-pagination"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5 d-flex align-items-center">
                            <div class="modal-body">
                                <div class="mb-2">
                                    <label for="selected-review-book" class="form-label">리뷰북</label>
                                    <input type="text" class="form-control form-control-sm"
                                           id="selected-review-book" readonly>
                                </div>
                                <div class="mb-2">
                                    <label for="select-touritem-info" class="form-label">관광지 정보 불러오기</label>
                                    <select class="form-select form-select-sm" id="select-touritem-info"
                                            onchange="selectTouritem()">
                                        <option value="hint" class="select-hint" disabled selected>관광지 정보를 선택해주세요.
                                        </option>
                                        <option value="direct">직접 입력</option>
                                        <option value="contentid1">집가기</option>
                                        <option value="contentid2">밥먹기</option>
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label for="selected-touritem-name" class="form-label">관광지 이름 작성</label>
                                    <input type="text" class="form-control form-control-sm"
                                           id="selected-touritem-name" disabled>
                                </div>
                                <div class="mb-3">
                                    <label for="review-contents" class="form-label">본문</label>
                                    <textarea class="form-control form-control-sm" id="review-contents"></textarea>
                                </div>
                                <div class="editor-btn-group d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal"
                                            data-bs-target="#select-book">이전
                                    </button>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="createPost()">완료
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <button type="button" id="new-review-btn" class="position-fixed rounded-pill btn btn-outline-primary">
        <i class="bi bi-vector-pen"></i>
    </button>
</div>


<!-- Bootstrap core JS-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<!-- 댓글 작성 -->
<script th:inline="javascript">
    $(document).ready(function () {
        selectBook();
        $('.swiper-controller').hide();
        deleteImg();
    });

    let createBookFlag = false;
    let selectedReviewBook;
    let selectedBookId;
    const fileInput = $('#img-uploader')[0];
    const images = [];

    var editSwiper = new Swiper(".editSwiper", {
        observer: true,
        observeParents: true,
        navigation: {
            nextEl: ".swiper-button-next",
            prevEl: ".swiper-button-prev",
        },
        pagination: {
            el: ".swiper-pagination",
        },
        mousewheel: true,
        keyboard: true,
    });


    $('#new-review-btn').click(function () {
        editorReset();
        let login = [[${loginUser.id}]];
        if (login === "anonymousUser") {
            alert("리뷰는 로그인 후 작성할 수 있습니다.")
        } else {
            showSelectList();
            $('#select-book').modal('show');
        }
    })

    function editorReset() {
        //사진 미리보기 초기화
        images.length = 0;
        fileInput.files.length = 0;
        $('.editSwiper .swiper-wrapper').html('<div class="swiper-slide">사진을 추가해주세요.</div>');
        $('.uploader').show()
        // 리뷰북 선택 정보 초기화
        createBookFlag = false;
        $('input:radio[name=selectReviewBook]').prop('checked', false);
        $('#new-book-item-select').html('<option value="hint" class="select-hint" disabled selected>리뷰북에 기록할 여행정보를 선택하세요.</option>');
        $('#new-book-title').val('');
        $('#exist-book-select').html('<option value="hint" class="select-hint" disabled selected>리뷰를 작성할 리뷰북을 선택하세요.</option>');
        // 에디터 내용 초기화
        selectedReviewBook = null;
        selectedBookId = null;
        $('.book-input').attr('disabled', true);
        $('#selected-review-book').val('');
        $('#select-touritem-info').html(
            '<option value="hint" class="select-hint" disabled selected>관광지 정보를 선택해주세요.</option>' +
            '<option value="direct">직접 입력</option>'
        );
        $('#selected-touritem-name').val('');
        $('#selected-touritem-name').prop('disabled', true);
        $('#review-contents').val('');
    }

    function showSelectList() {
        $.ajax({
            url: '/api/review/show_list',
            type: 'GET',
            contentType: 'application/json; charset=UTF-8',
            success: function (result) {
                const plannerList = result.plannerList;
                const reviewBookList = result.reviewBookList;

                if (plannerList.length > 0) {
                    for (let planner of plannerList) {
                        let template = `<option value=${planner.plannerId}>${planner.plannerName}</option>`;
                        $('#new-book-item-select').append(template)
                    }
                } else {
                    let template = '<option value="hint" disabled>등록된 정보가 없습니다.</option>';
                    $('#new-book-item-select').append(template)
                }

                if (reviewBookList.length > 0) {
                    for (let reviewBook of reviewBookList) {
                        let template = `<option value=${reviewBook.bookId}>${reviewBook.bookTitle}</option>`;
                        $('#exist-book-select').append(template)
                    }
                } else {
                    let template = '<option value="hint" disabled>등록된 정보가 없습니다.</option>';
                    $('#exist-book-select').append(template)
                }
            },
            error: function (err) {
                console.log(err);
            }
        })
    }

    function selectBook() {
        $("input:radio[name=selectReviewBook]").click(function () {
            let select = Number($("input[name=selectReviewBook]:checked").val());
            $(".book-input").attr('disabled', true);
            switch (select) {
                case 1:
                    $("#new-book-item-select").attr('disabled', false);
                    if ($("#new-book-item-select option:selected").val() != "hint") {
                        writeBookTitle()
                    }
                    break;
                case 2:
                    $("#exist-book-select").attr('disabled', false);
                    break;
            }
        })
    }

    function writeBookTitle() {
        createBookFlag = false;
        $("#new-book-title").attr('disabled', false);
    }


    function goEdit() {
        let select = $("input[name=selectReviewBook]:checked").val();
        if (select == undefined) {
            alert("리뷰북 설정을 완료해주세요.");
        } else {
            switch (Number(select)) {
                case 1:
                    if ($("#new-book-item-select option:selected").val() == 'hint') {
                        alert("리뷰북에 기록할 여행정보를 선택해주세요.")
                    } else if ($("#new-book-title").val() == '') {
                        alert("생성할 리뷰북의 제목을 입력해주세요.")
                    } else if (!createBookFlag) {
                        alert("생성 버튼을 눌러 리뷰북을 생성해주세요.")
                    } else {
                        selectedReviewBook = $("#new-book-title").val();
                        AddPlanList();
                    }
                    break;
                case 2:
                    if ($("#exist-book-select option:selected").val() == 'hint') {
                        alert("리뷰를 작성할 리뷰북을 선택해주세요.")
                    } else {
                        selectedBookId = $('#exist-book-select option:selected').val();
                        selectedReviewBook = $("#exist-book-select option:checked").text();
                        AddPlanList();
                    }
                    break;
                case 3:
                    selectedReviewBook = "선택하지 않음";
                    $('#selected-review-book').val(selectedReviewBook);
                    $('#select-book, #editor').modal('toggle');
                    break;
            }
        }
    }

    function createSimpleBook() {
        const plannerId = $("#new-book-item-select option:selected").val();
        const bookTitle = $("#new-book-title").val();

        let formData = new FormData();
        formData.append("plannerId", plannerId);
        formData.append("bookTitle", bookTitle);

        $.ajax({
            url: '/api/book/create',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (createdBookId) {
                createBookFlag = true;
                selectedBookId = createdBookId;
                alert(`[${bookTitle}] 리뷰북이 생성되었습니다.`);
            },
            error: function (err) {
                alert("리뷰북 생성에 실패하였습니다.");
                console.log(err);
            }
        })
    }

    function AddPlanList() {
        let promise = new Promise((resolve) => {
            $.ajax({
                url: '/api/review/show_plan',
                type: 'GET',
                data: {
                    bookId: selectedBookId
                },
                contentType: 'application/json; charset=UTF-8',
                success: function (result) {
                    const planList = result.planList;
                    for (let plan of planList) {
                        let template = `<option value=${plan.tourItem.contentid}>[${plan.day}일차] ${plan.tourItem.title}</option>`;
                        $('#select-touritem-info').append(template);
                    }
                    resolve();
                },
                error: function (err) {
                    console.log(err);
                }
            })
        })

        promise.then(() => {
            $('#selected-review-book').val(selectedReviewBook);
            $('#select-book, #editor').modal('toggle');
        })
    }

    function selectTouritem() {
        let item = $('#select-touritem-info option:selected');
        let title = item.text();
        if (title !== '직접 입력') {
            let startTitleIdx = title.indexOf(']') + 2;
            title = title.substring(startTitleIdx);
        }
        let titleInput = $('#selected-touritem-name');
        titleInput.attr('disabled', false);
        titleInput.val(title)
    }

    function createPost() {
        if (images.length < 1) {
            alert("사진을 반드시 한 장 이상 첨부해주세요.")
        } else if ($('#select-touritem-info option:selected').val() === 'hint') {
            alert("관광지 정보를 선택해주세요.")
        } else if ($('#selected-touritem-name').val() === '' || $('#selected-touritem-name').val() === '직접 입력') {
            alert('관광지 이름을 작성해주세요.')
        } else if ($('#review-contents').val() === '') {
            alert('본문 내용을 입력해주세요.')
        } else {
            saveReview();
            $('#editor').modal('hide');
        }
    }

    function saveReview() {
        let formData = new FormData();
        let touritemId = $('#select-touritem-info option:selected').val();

        if (selectedBookId !== null) formData.append("bookId", selectedBookId);
        if (touritemId !== 'direct') formData.append("touritemId", touritemId);
        formData.append("touritemTitle", $('#selected-touritem-name').val());
        formData.append("reviewContent", $('#review-contents').val());

        for (let image of images) {
            formData.append("photoList", image);
        }

        console.log(formData)

        $.ajax({
            url: '/api/review/create',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                alert("리뷰를 등록하였습니다.")
                changeTab('REVIEW');
            },
            error: function (err) {
                alert("리뷰 등록에 실패했습니다.")
            }
        })
    }

    function setPreview() {
        let files = fileInput.files;
        if (files.length + images.length > 4) {
            files.length = 0;
            alert("사진은 4장까지 첨부할 수 있습니다.")
        } else {
            if (files.length > 0 && images.length === 0) {
                $('.swiper-wrapper').html("");
            }
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    let file = files[i];
                    images.push(file);

                    let reader = new FileReader();

                    const tempHtml = `<div class="swiper-slide">` +
                        `<button class="delete-img-btn btn btn-dark rounded-pill opacity-50">` +
                        `<i class="bi bi-x-lg"></i>` +
                        `</button>` +
                        `<img class="preview-img" style="object-fit: contain" onload="goLastSlide()"/>` +
                        `</div>`;
                    editSwiper.appendSlide(tempHtml);
                    editSwiper.update();

                    reader.onload = function (data) {
                        const swiperSlides = $('.editSwiper .swiper-wrapper .swiper-slide');
                        const targetSlide = $(swiperSlides[images.length - files.length + i]);
                        targetSlide.find('.preview-img').attr('src', data.target.result);
                    };

                    reader.readAsDataURL(file);
                }
            }
            if (images.length > 1) {
                $('.editSwiper .swiper-controller').show()
            } else {
                $('.editSwiper .swiper-controller').hide()
            }
            if (images.length >= 4) {
                $('.uploader').hide()
            }
        }
    }

    function goLastSlide() {
        editSwiper.slideTo(images.length - 1, 300, false);
    }

    function deleteImg() {
        $(document).on('click', '.delete-img-btn', function () {
            let idx = $(".delete-img-btn").index(this);
            editSwiper.slideTo(idx - 1, 300, false);
            editSwiper.removeSlide(idx);
            editSwiper.update();
            images.splice(idx, 1);

            if (images.length > 1) {
                $('.editSwiper .swiper-controller').show()
            } else {
                $('.editSwiper .swiper-controller').hide()
            }
            ;

            if (images.length === 0) {
                const tempHtml = `<div class="swiper-slide">` +
                    `사진을 추가해주세요.` +
                    `</div>`;
                editSwiper.appendSlide(tempHtml);
                editSwiper.update();
            }
            if ($('.uploader').css('display') === 'none' && images.length < 4) {
                $('.uploader').show()
            }
        })
    }
</script>

<!-- 간단 댓글 조회 + 무한스크롤 -->
<!-- 마이페이지 무한스크롤 관련 스크립트 -->
<script th:inline="javascript">
    let scrollPage = 0; // 무한스크롤로 불러올 페이지
    let scrollCheck = false; // 페이지 데이터를 불러오는 중인지 여부
    let firstLoad = true; // 첫 로딩인지 체크
    let gallery = $('.gallery');
    let tabType = "RECOMMEND"; // 화면에 보여줄 탭
    let back = false;
    $(document).ready(function (){
        /*무한스크롤 & 페이지 로드 설정*/
        gallery.html("")
        observer.observe(document.getElementById('load-point'));
        $('#load-point').hide(); // 옵저버 관측 타이밍을 컨트롤하기 위해 hide
        loadPage();
        /* 리뷰 상세 조회 관련 설정 */
        $('.swiper-controller').hide();
        /* 새 글 작성 버튼 관련 설정 */
        $('.create-btn').hide();
        if([[${findUser.id == loginUser.id}]]){
            $('#new-review-btn').show()
        }
        /* 리뷰 작성 관련 설정 */
        selectBook();
        deleteImg();
        // /*리뷰 북 작성 관련 설정*/
        // changeBookTitle();
        // checkBookContents();
    })

    const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            // entry가 intersecting 중이 아니라면 함수를 실행하지 않음.
            if (!entry.isIntersecting) return;
            // 현재 페이지가 불러오는 중이면 함수를 실행하지 않음.
            if (scrollCheck) return;
            //옵저버 타겟 설정
            observer.observe(document.getElementById('load-point'));
            // 페이지를 불러오는 함수 호출.
            switch (tabType){
                case "RECOMMEND" :
                    showRecommend();
                    break;
                case "FOLLOW" :
                    showFollowReview();
                    break;
            }
        });
    });

    // 탭을 이동시 마다 변수 및 기존 화면 초기화(탭 이동시 마다 실행 해주세요.)
    function changeTab(type) {
        observer.disconnect()
        tabType = type;
        scrollPage = 0;
        scrollCheck = false;
        firstLoad = true;
        back = false;

        gallery.html("")
        // 옵저버 타겟 관측 시작
        observer.observe(document.getElementById('load-point'));
    }



    function showRecommend() {
        let time = 500;  // 페이지 로딩 시 로더를 일정시간 이상 보여주기 위한 시간 지정
        let loadScroll; // 다음 페이지 로딩 후에도 유지할 스크롤 위치를 저장할 변수
        if(!firstLoad){
            scrollPage += 1;
        }
        if(firstLoad || back) {
            time = 0;
            back = false;
        }
        $.ajax({
            url : '/api/review/recommend',
            type : 'GET',
            data : {
                page : scrollPage
            },
            async: false,
            success : function (result) {
                let reviewList = result.dtoList;

                if(firstLoad && reviewList.length <= 0){
                    firstLoad = false;
                    $(".loader").hide()
                    let messageHtml = '<div class="no-data-msg mt-5">' +
                        '<h4>등록된 리뷰가 없습니다.</h4>' +
                        '</div>';
                    gallery.append(messageHtml);
                }else {
                    firstLoad = false;
                    // 로더를 일정시간 이상 노출하기 위한 setTimeout
                    setTimeout(() => {
                        $(".loader").hide()
                        $.each(reviewList, function (index, review){
                            let tempHtml = `<div class="gallery-item" tabIndex="0" onclick="savePage()">` +
                                `<a href="/info/content/${bookmark.contentid}">` +
                                `<img src="${bookmark.firstimage}"` +
                                `class="gallery-image" alt="">` +
                                `<div class="gallery-item-info d-flex">` +
                                `<div class="bookmark-info-wrap">` +
                                `<div class="bookmark-category">${bookmark.fullCategoryName}</div>` +
                                `<div class="bookmark-title"><strong>${bookmark.title}</strong></div>` +
                                `<div class="bookmark-address">${bookmark.address}</div>` +
                                `</div>` +
                                `</div>` +
                                `</a>` +
                                `</div>`
                            gallery.append(tempHtml).trigger("create")
                        })
                        window.scrollTo({top: loadScroll, behavior: "instant"});
                    }, time)
                    if(result.page <= result.last){
                        // 다음페이지가 없다면 관측을 종료
                        observer.unobserve(document.getElementById('load-point'));
                    }
                }
            },
            error : function (err) {
                console.log(err)
            },
            beforeSend : function () {
                scrollCheck = true;
                $(".loader").show()
                loadScroll = window.scrollY;
            },
            complete : function () {
                scrollCheck = false;
            }
        })
    }


    function savePage() {
        let feedInfo = {};
        feedInfo.tabType = tabType;
        feedInfo.scrollPage = scrollPage;
        feedInfo.scrollPosition = window.scrollY.toString();
        sessionStorage.setItem("feedInfo", JSON.stringify(feeInfo));
    }

    function setScrollByMyPageInfo(){
        let session_feedInfo = JSON.parse(sessionStorage.getItem("feedInfo"));
        let tabType = session_feedInfo.tabType;
        let sessionPage = Number(session_feedInfo.scrollPage);
        let scrollPosition = Number(session_feedInfo.scrollPosition);
        changeTab(tabType)
        console.log(sessionPage);
        console.log(scrollPosition);
        for(let page = 0; page <= sessionPage; page++){
            back = true;
            console.log(`${scrollPage}, ${page}`);
            switch (tabType){
                case "RECOMMEND":
                    showRecommend();
                    break;
                case "FOLLOW":
                    showFollowReview();
                    break;
            }
        }
        setTimeout(() => {
            var scrollBottom = $(document).height() - $(window).height() - $(window).scrollTop();
            if(scrollPosition > scrollBottom){
                window.scrollTo(0, scrollBottom);
            }else {
                window.scrollTo(0, scrollPosition);
            }
        }, 100);

        setTimeout(() => {
            $('#load-point').show();
        }, 550)
    }

    function loadPage() {
        window.addEventListener('pageshow', function (event) {
            if (event.persisted || (window.performance && window.performance.navigation.type == 2)) {
                if(sessionStorage.getItem("feedInfo") != null){
                    // 다른페이지에서 뒤로가기로 돌아왔을 시 세션에 저장된 정보로 기존 위치로 이동
                    setScrollByMyPageInfo();
                }else {
                    $('#load-point').show();
                }
            }else {
                // 그 외의 방법으로 페이지 접근 시 바로 타겟을 노출, 데이터 로딩
                if(sessionStorage.getItem("feedInfo") != null){
                    sessionStorage.removeItem("feedInfo");
                }
                $('#load-point').show();
            }
        });
    }


</script>

</body>
</html>