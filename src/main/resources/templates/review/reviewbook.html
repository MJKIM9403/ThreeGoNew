<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/html">
<head>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!--jquery-->
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <!-- Font Awesome icons (free version)-->
    <!--    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <!-- Bootstrap icons-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
          type="text/css"/>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Noto+Sans+KR:wght@100;200;300;400;500;600;700;800;900&display=swap"
          rel="stylesheet">
    <!-- Core theme CSS (includes Bootstrap)-->

    <link href="../assets/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="../assets/css/style.css?after" rel="stylesheet"/>
    <link href="../assets/css/commonstyle.css?after" rel="stylesheet"/>
    <!--  리뷰 뷰어 스타일시트  -->
    <link href="../assets/css/reviewviewer.css" rel="stylesheet"/>

    <!--swiper-->
    <link href="../assets/swiper/swiper-bundle.min.css" rel="stylesheet" />
    <script src="../assets/swiper/swiper-bundle.min.js"></script>

    <meta charset="UTF-8">
    <title th:text="'Three Go | 리뷰북 :: ' + ${reviewBook.bookTitle}"></title>
</head>
<body data-bs-spy="scroll" data-bs-target="#book-index" data-bs-smooth-scroll="true" data-bs-offset="10" tabindex="1">
<style>
    main {
        margin-left: 280px;
        flex: 1 0 auto;
    }

    .book-cover-wrap {
        position: relative;
        min-width: 800px;
    }
    .book-cover-image-wrap {
        width: 100%;
        aspect-ratio: 3.7;
        overflow: hidden;
    }
    .book-cover-image-wrap img {
        object-fit: cover;
        width: 100%;
        height: 100%;
    }
    .book-title {
        position: absolute;
        top: 8%;
        left: 4%;
        color: #FFFFFF;
        text-shadow:
                -1px 0px rgba(0, 0, 0, 0.8),
                0px 1px rgba(0, 0, 0, 0.8),
                1px 0px rgba(0, 0, 0, 0.8),
                0px -1px rgba(0, 0, 0, 0.8);
        text-align: left;
        font-size: 4.6rem;
        font-weight: 700;
        margin: 0;
    }
    .book-content {
        position: absolute;
        bottom: 8%;
        right: 4%;
        color: #FFFFFF;
        text-shadow:
                -1px 0px rgba(0, 0, 0, 0.8),
                0px 1px rgba(0, 0, 0, 0.8),
                1px 0px rgba(0, 0, 0, 0.8),
                0px -1px rgba(0, 0, 0, 0.8);
        text-align: right;
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
    }

    .fixed-book-cover {
        display: flex;
        justify-content: start;
        align-items: center;
        width: 100%;
        position: fixed;
        top: 0;
        left: 280px;
        height: 80px;
        background: rgba(200, 200, 200, 0.9);
        z-index: 100;
        transition: all ease-in 0.3s;
    }

    .fixed-book-cover .book-cover-image-wrap {
        margin: 0 20px;
        border-radius: 20%;
        width: 60px !important;
        height: 60px !important;
        order: 1;
    }
    .fixed-book-cover .book-title {
        position: static;
        color: #000000;
        text-shadow: none;
        text-align: left;
        font-size: 1.6rem;
        order: 2;
    }
    .fixed-book-cover .book-content {
        display: none;
    }

    .review-container {
        position: relative;
        display: flex;
        justify-content: center;
    }

    .gallery {
        margin-top: 100px;
    }

    .book-index {
        display: none;
        width: 300px;
        height: 100vh;
        overflow-y: scroll;
        background: #F8F9FA;
    }
    .book-index ul li{
        width: 100%;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        word-break: break-all;
    }

    .fixed-book-index {
        width: 0;
        display: block;
        position: fixed;
        z-index: 200;
        top: 80px;
        right: 0;
        transition: all ease-in 0.3s;
    }

    #index-btn {
        opacity: 0;
        visibility: hidden;
        position: fixed;
        top: calc(50vh + 25px);
        right: 30px;
        transition: all ease-in 0.3s;
    }

    .card {
        width: 600px;
        margin-bottom: 2em;

    }

    .card .card-header img {
        width: 24px;
        height: 24px;
    }

    .simple-view-swiper{
        height: 480px !important;
        overflow: hidden;
    }

    /*.simple-view-swiper*/
    /*.swiper-wrapper {*/
    /*    width: 100%;*/
    /*    height: 100%;*/

    /*}*/

    /*.swiper-slide {*/
    /*    width: 100%;*/
    /*    height: 100%;*/
    /*}*/

    .simple-view-img {
        object-fit: cover !important;
        width: 100%;
        height: 100%;
    }
</style>
<div class="d-flex flex-nowrap">
    <th:block th:replace="~{fragments/sidebar}"></th:block>
    <main>
        <div class="book-cover-wrap">
            <h2 class="book-title" th:text="${reviewBook.bookTitle}"></h2>
            <div class="book-cover-image-wrap">
                <img th:if="${reviewBook.coverFilePath == null}" src="../assets/img/review_book_cover.jpg">
                <img th:unless="${reviewBook.coverFilePath == null}" th:src="|@{/api/image/book/}${reviewBook.coverFilePath}|">
            </div>
            <h4 class="book-content" th:utext="${reviewBook.bookContent}"></h4>
        </div>
        <div class="review-container">
            <div class="gallery">
                <th:block th:each="review, reviewState : ${reviewList}">
                    <div th:id="|list-item-${reviewState.count}|" class="card gallery-item">
                        <!--유저 정보-->
                        <div class="d-flex card-header gap-2">
                            <img th:src="|@{/api/image/profile/}${review.userInfo.profileImg}|" alt="mdo"
                                 class="rounded-circle">
                            <span th:text="${review.userInfo.name}"></span>
                            <span th:text="|@${review.userInfo.id}|"></span>
                        </div>
                        <div class="card-body">
                            <!--유저가 업로드한 이미지-->
                            <div th:class="|swiper simple-view-swiper simple-view-swiper${reviewState.index}|">
                                <div class="swiper-wrapper">
                                    <th:block th:each="photo : ${review.reviewPhotoList}">
                                        <div class="swiper-slide">
                                            <img class="simple-view-img" th:src="|@{/api/image/review/}${photo.filePath}|"/>
                                        </div>
                                    </th:block>
                                </div>
                                <div th:class="|swiper-controller swiper-controller${reviewState.index}|">
                                    <div th:class="|swiper-button-next swiper-button-next${reviewState.index}|"></div>
                                    <div th:class="|swiper-button-prev swiper-button-prev${reviewState.index}|"></div>
                                    <div th:class="|swiper-pagination swiper-pagination${reviewState.index}|"></div>
                                </div>
                            </div>
                            <!--좋아요와 댓글 -->
                            <div class="d-flex gap-3">
                                <i class="bi bi-heart"></i>
                                <i class="bi bi-chat"></i>
                            </div>

                            <p class="card-text">좋아요 몇개</p>
                            <p class="card-text" th:onclick="openViewer([[${review.reviewId}]])"><small class="text-muted">댓글 더 보기</small></p>
                        </div>
                    </div>
                </th:block>
            </div>
            <button type="button" id="index-btn" class="rounded-pill btn btn-outline-primary" onclick="openIndex()">
                <i class="fa-solid fa-book-bookmark"></i>
            </button>
            <div id="book-index" class="book-index list-group">
                <th:block th:each="review, reviewState : ${reviewList}">
                    <a class="list-group-item list-group-item-action" th:href="|#list-item-${reviewState.count}|" th:text="${review.tourItemTitle}"></a>
                </th:block>
            </div>
        </div>
    </main>

    <!-- 리뷰 상세 조회 폼 -->
    <div id="viewer" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="true" tabindex="-1" aria-labelledby="viewerLabel" aria-hidden="true">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="preview-container col-md-7">
                            <div id="review-book-info" class="d-flex align-items-center">
                                <div class="rounded-3 icon-img">
                                    <img id="review-book-cover" src="../assets/img/no_image.png" alt="...">
                                </div>
                                <span id="review-book-title" class="ms-2">리뷰 북 타이틀</span>
                            </div>
                            <div id="touritem-wrap" class="d-flex align-items-center gap-2">
                                <div id="touritem-info" class="card">
                                    <img id="touritem-info-img" src="../assets/img/no_img.jpg" class="card-img-top" alt="...">
                                    <div class="card-body">
                                        <p id="touritem-info-title" class="card-text">관광지 이름</p>
                                        <p id="touritem-info-address" class="card-text">관광지 주소</p>
                                        <p id="touritem-info-category" class="card-text">관광지 카테고리</p>
                                    </div>
                                </div>
                                <i class="fa-solid fa-location-dot"></i>
                                <span id="touritem-name">관광지 이름</span>
                            </div>
                            <div class="swiper viewSwiper">
                                <div class="swiper-wrapper">
                                    <div class="swiper-slide">사진을 추가해주세요.</div>
                                </div>
                                <div class="swiper-controller">
                                    <div class="swiper-button-next"></div>
                                    <div class="swiper-button-prev"></div>
                                    <div class="swiper-pagination"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5 d-flex align-items-start">
                            <div class="modal-body">
                                <div id="writer-wrap" class="mb-2 d-flex align-items-center justify-content-between">
                                    <div id="writer-info" class="d-flex align-items-center">
                                        <div class="rounded-circle icon-img">
                                            <img id="writer-profile-img" src="../assets/img/profile.jpg" alt="...">
                                        </div>
                                        <strong id="writer-name" class="ms-2">작성자 이름</strong>
                                        <span id="writer-id" class="ms-2">@writerId</span>
                                    </div>
                                    <div class="btn-group">
                                        <button id="review-more-btn" type="button" class="btn dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-cog" aria-hidden="true"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a id="review-edit" class="dropdown-item" href="#">수정</a></li>
                                            <li><span id="review-delete" class="dropdown-item">삭제</span></li>
                                        </ul>
                                    </div>
                                </div>
                                <div id="contents-wrap" class="mb-3">
                                    <div id="content" class="mb-2">
                                    </div>
                                    <div id="comment-wrap">
                                        <div class="comment-info d-flex justify-content-start mb-1">
                                            <div class="rounded-circle icon-img comment-profile">
                                                <img src="../assets/img/profile.jpg" alt="...">
                                            </div>
                                            <span class="comment-writer ms-2">댓글1</span>
                                            <span class="comment-text ms-4">우와~</span>
                                        </div>
                                        <div class="comment-info  d-flex justify-content-start mb-1">
                                            <div class="rounded-circle icon-img comment-profile">
                                                <img src="../assets/img/profile.jpg" alt="...">
                                            </div>
                                            <span class="comment-writer ms-2">댓글2</span>
                                            <span class="comment-text ms-4">정말 데단해</span>
                                        </div>
                                    </div>
                                </div>
                                <div id="my-comment-wrap" class="d-flex align-items-start">
                                    <div class="rounded-circle icon-img">
                                        <img id="login-user-profile-img" src="../assets/img/profile.jpg" alt="...">
                                    </div>
                                    <div id="comment-area" class="ms-2">
                                        <div id="login-user-name" class="mb-2">작성자 이름</div>
                                        <div class="d-flex gap-1">
                                            <textarea class="form-control"></textarea>
                                            <button id="comment-btn" type="button" class="btn btn-outline-secondary">등록</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script th:inline="javascript">
    let lastScroll = 0;
    let isScrollDown = true;
    let galleyTopThird = $(".gallery").offset().top / 3;

    $(window).on('scroll', function () {
        let scrollTop = $(this).scrollTop();

        // 최상단에서 크게 보이는 기능
        if (scrollTop <= 0) {
            $('.book-cover-wrap').removeClass('fixed-book-cover');
            $('.book-cover-wrap').css('height','');
            $('.book-cover-image-wrap, .book-title').css({
                'opacity': '100%',
                'visibility': 'visible'
            });
            $('.review-container').css('margin-top', '');
            $('.book-index').removeClass('fixed-book-index');
            $('#index-btn').css({
                'opacity': '0%',
                'visibility': 'hidden'
            });
        } else if(scrollTop > galleyTopThird){
            // 스크롤이 galleyTop/3 지점 아래로 내려왔을 때 간략하게 보이도록 처리
            $('.book-cover-wrap').addClass('fixed-book-cover');
            $('.review-container').css('margin-top', '80px');
            $('.book-index').addClass('fixed-book-index');
            $('#index-btn').css({
                'opacity': '100%',
                'visibility': 'visible'
            });
        }

        if(scrollTop > 0){
            // 스크롤 방향에 따른 처리
            if (!isScrollDown && scrollTop < lastScroll) {
                isScrollDown = true;
                // 스크롤을 올릴 때
                $('.book-cover-wrap').css({
                    'height': '80px',
                    'opacity': '100%',
                    'visibility': 'visible'
                });
                $('.book-index').css('top', '80px');
            } else if (isScrollDown && scrollTop > lastScroll) {
                isScrollDown = false;
                // 스크롤을 내릴 때
                $('.book-cover-wrap').css({
                    'height': '0px',
                    'opacity': '0%',
                    'visibility': 'hidden'
                });
                $('.book-index').css('top', '0px');
            }
        }

        lastScroll = scrollTop;
    })

    function openIndex(){
        if($('#index-btn').css('right') === '30px'){
            $('#index-btn').addClass('active')
            $('#index-btn').css('right','330px');
            $('.fixed-book-index').css('width','300px');
        }else {
            $('#index-btn').removeClass('active');
            $('#index-btn').css('right','30px');
            $('.fixed-book-index').css('width','0');
        }
    }

</script>
<!-- 리뷰 간단 뷰 관련 스크립트 -->
<script th:inline="javascript">
    let simpleViewSwiper = [];
    let reviewList = [[${reviewList}]];
    function createSimpleViewSwiper(){
        for(let idx = 0; idx < reviewList.length; idx++){
            var swiper = new Swiper(`.simple-view-swiper${idx}`, {
                observer: true,
                observeParents: true,
                navigation: {
                    nextEl: `.swiper-button-next${idx}`,
                    prevEl: `.swiper-button-prev${idx}`,
                },
                pagination: {
                    el: `.swiper-pagination${idx}`,
                },
                mousewheel: true,
                keyboard: true,
            });
            simpleViewSwiper.push(swiper);
            if(reviewList[idx].reviewPhotoList.length <= 1){
                $(`.swiper-controller${idx}`).hide();
            }
        }
    }
</script>
<!-- 리뷰 뷰어 관련 스크립트 -->
<script th:inline="javascript">
    $(document).ready(function (){
        /* 리뷰 상세 조회 관련 설정 */
        $('.viewSwiper .swiper-controller').hide();
        createSimpleViewSwiper();
    });

    let savedFile = []; // 기존 저장된 이미지 파일의 id를 저장할 배열

    // swiper 설정
    var viewSwiper = new Swiper(".viewSwiper", {
        observer: true,
        observeParents: true,
        navigation: {
            nextEl: ".swiper-button-next",
            prevEl: ".swiper-button-prev",
        },
        pagination: {
            el: ".swiper-pagination",
        },
        mousewheel: true,
        keyboard: false,
    });
    function openViewer(reviewId) {
        let loginUserName = [[${loginUser.id}]] === 'anonymousUser' ? "로그인 후 이용해주세요." : [[${loginUser.id}]];
        let loginUserProfile = [[${loginUser.profileImg}]] === null ? null : [[${loginUser.profileImg}]];
        let promise = new Promise((resolve) => {
            $.ajax({
                url : '/api/review/view_count',
                type : 'PUT',
                data : {
                    reviewId : reviewId
                },
                success : function (viewCount) {
                    console.log(viewCount);
                    resolve();
                },
                error : function (err) {
                    console.log(err)
                }
            })
        });
        promise.then(() => {
            $('#viewer').modal('show');
            $('#login-user-name').text(loginUserName);
            if(loginUserProfile != null){
                $('#login-user-profile-img').attr('src','/api/image/profile/' + loginUserProfile);
            }
            loadDetailReview(reviewId)
        });
    }
    function loadDetailReview(reviewId){
        $.ajax({
            url : '/api/review/detail',
            type : 'GET',
            data : {
                reviewId : reviewId
            },
            contentType : 'application/json; charset=UTF-8',
            success : function (findReview) {
                let writer = findReview.userInfo;
                let photoList = findReview.reviewPhotoList;
                $('#writer-info').click(function (){
                    location.href = `/mypage/${writer.id}`
                })
                $('#writer-name').text(writer.name);
                $('#writer-id').text('@' + writer.id);
                if(writer.id === [[${loginUser.id}]]){
                    $('#writer-wrap .btn-group').addClass('d-flex').show();
                    $('#review-edit').attr('href',`../review/edit/${reviewId}`);
                    $('#review-delete').off('click').on('click', function (){
                        deleteReview(reviewId);
                    })
                }else {
                    $('#writer-wrap .btn-group').removeClass('d-flex').hide();
                }
                if(writer.profileImg != null){
                    $('#writer-profile-img').attr('src','/api/image/profile/' + writer.profileImg);
                }
                $('#content').html(findReview.reviewContent);
                if(findReview.reviewBookId == null){
                    $('#review-book-info').removeClass('d-flex').hide();
                }else {
                    $('#review-book-info').addClass('d-flex').show();
                    $('#review-book-title').text(findReview.reviewBookTitle);
                    if(findReview.reviewBookCoverImg != null){
                        $('#review-book-cover').attr('src','/api/image/book/' + findReview.reviewBookCoverImg);
                    }
                }
                $('#touritem-name').text(findReview.tourItemTitle);
                $('#touritem-name').attr('data-touritem-id', findReview.tourItemId);
                $('.viewSwiper .swiper-wrapper').html("");
                for(let photo of photoList){
                    savedFile.push(photo.fileId);
                    const tempHtml = `<div class="swiper-slide">` +
                        `<img class="preview-img" data-file-id="${photo.fileId}" src="/api/image/review/${photo.filePath}" style="object-fit: contain"/>` +
                        `</div>`;
                    viewSwiper.appendSlide(tempHtml);
                    viewSwiper.update();
                }
                let fileLength = savedFile.length;
                if(fileLength > 1){
                    $('.viewSwiper .swiper-controller').show()
                }else {
                    $('.viewSwiper .swiper-controller').hide()
                };
            },
            error : function (){
                alert("리뷰 정보 조회에 실패했습니다.")
            }
        })
    }

    // 리뷰 뷰어에서 관광지 정보 조회
    let touritemInfoTimer;

    $('#touritem-wrap').mouseenter(function (){
        let tourItemId = $('#touritem-name').attr('data-touritem-id');
        if(tourItemId !== undefined){
            $('#touritem-wrap').css('cursor','pointer');
            $('#touritem-wrap').click(function (){
                location.href = `../info/content/${tourItemId}`;
            })
            touritemInfoTimer = setTimeout(function () {
                showTourItemSimpleInfo(tourItemId)
            },300)
        }
    })
    $('#touritem-wrap').mouseleave(function (){
        $('#touritem-wrap').css('cursor','');
        clearTimeout(touritemInfoTimer);
        $('#touritem-info').hide();
    })

    function showTourItemSimpleInfo(tourItemId){
        $.ajax({
            url : '/api/review/simple-touritem',
            type : 'GET',
            data : {
                tourItemId : tourItemId
            },
            contentType : 'application/json; charset=UTF-8',
            success : function (tourItem){
                $('#touritem-info-img').attr('src',tourItem.firstimage);
                $('#touritem-info-title').text(tourItem.title);
                $('#touritem-info-address').text(tourItem.address);
                $('#touritem-info-category').text(tourItem.fullCategoryName);
                $('#touritem-info').show();
            },
            error : function (err){
                console.log(err);
            }
        })
    }

    function deleteReview(reviewId){
        const deleteConfirm = confirm("리뷰를 삭제하시겠습니까?");
        if(deleteConfirm){
            $.ajax({
                url : '/api/review/delete',
                type : 'DELETE',
                data : {
                    reviewId : reviewId
                },
                success : function (){
                    alert('삭제 되었습니다.')
                    savePage();
                    $('#viewer').modal('toggle');
                    changeTab(tabType);
                    setScrollByMyPageInfo();
                },
                error : function (){
                    alert('삭제에 실패했습니다.')
                }
            })
        }
    }

    $('#new-review-btn').mouseenter(function (){
        let tempHtml = "<span>리뷰 작성</span>";
        $('#new-review-btn').append(tempHtml)
    })

    $('#new-review-btn').mouseleave(function (){
        $('#new-review-btn span').remove()
    })
</script>
</body>
</html>