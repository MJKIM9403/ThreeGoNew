<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!--jquery-->
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <!-- Font Awesome icons (free version)-->
<!--    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <!-- Bootstrap icons-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
          type="text/css"/>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Noto+Sans+KR:wght@100;200;300;400;500;600;700;800;900&display=swap"
          rel="stylesheet">
    <!-- Core theme CSS (includes Bootstrap)-->

    <link href="../assets/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="../assets/css/style.css?after" rel="stylesheet"/>
    <link href="../assets/css/commonstyle.css?after" rel="stylesheet"/>

    <!--  my page 적용 템플릿 스타일 시트  -->
    <link href="../assets/css/mypagestyle.css" rel="stylesheet"/>
    <!--  리뷰 뷰어 스타일시트  -->
    <link href="../assets/css/reviewviewer.css" rel="stylesheet"/>

    <!--swiper-->
    <link href="../assets/swiper/swiper-bundle.min.css" rel="stylesheet" />
    <script src="../assets/swiper/swiper-bundle.min.js"></script>

    <title>둘레둘레</title>
</head>
<body>
<style>
    .container-fluid {
        height: 100%;
        /*overflow: hidden;*/
    }

    .container-fluid .row {
        height: 100%;
    }

    .no-data-msg {
        display: flex;
        justify-content: center;
        width: 100%;
    }

    .preview-container {
        position: relative;
        padding: 0 !important;
        height: 100%;
    }
    .delete-img-btn {
        position: absolute;
        top: 5%;
        right: 5%;
    }
    .add-file {
        position: absolute;
        bottom: 5%;
        right: 5%;
        z-index: 100;
    }
    #img-uploader {
        display: none;
    }

    .icon-img {
        overflow: hidden;
        width: 35px;
        height: 35px;
    }
    .icon-img img {
        height: 100%;
        width: 100%;
        object-fit: cover;
    }
    .uploader {
        padding: 10px;
        color: #136DF8;
        cursor: pointer;
    }
    .uploader:hover {
        background-color: #136DF8;
        color: #FFFFFF;
        transition: all 0.2s;
    }
    .select-hint{
        display: none;
    }

    .comment-profile{
        width: 25px;
        height: 25px;
    }
    #review-contents {
        height: 380px;
        resize: none;
    }
    #create-book-btn{
        --bs-btn-padding-y: 0.25rem;
        --bs-btn-padding-x: 0.5rem;
        --bs-btn-font-size: 0.875rem;
        --bs-btn-border-radius: 0.25rem;
    }

    #new-review-btn,
    #new-book-btn {
        bottom: 5%;
        right: 5%;
        z-index: 200;
    }

    /* 리뷰북 작성 */
    #book-cover-wrap {
        background: #333333 ;
        position: relative;
        height: 8rem;
        overflow: hidden;
    }

    #book-preview-img {
        width: 100%;
        object-fit: cover;
    }

    #book-img-uploader {
        display: none;
    }

    .cursor-default {
        cursor: default !important;
    }
    .cursor-pointer {
        cursor: pointer !important;
    }

    #book-img-uploader-label {
        padding: 2px;
    }

    #book-contents {
        height: 80px;
    }

    #select-book-img {
        margin-bottom: 0;
    }

    #book-img-delete-btn {
        display: none;
    }

    #book-preview-title {
        font-size: 1.5rem;
        font-weight: 700;
        position: absolute;
        z-index: 100;
        margin-bottom: 0;
        bottom: 1rem;
        right: 1rem;
        color: #FFFFFF;
        text-shadow:
                -1px 0px rgba(0, 0, 0, 0.8),
                0px 1px rgba(0, 0, 0, 0.8),
                1px 0px rgba(0, 0, 0, 0.8),
                0px -1px rgba(0, 0, 0, 0.8);
    }
    /* 리뷰북 목록 */
    .review-book-item {
        cursor: pointer;
        box-shadow: 0.1rem 0.1rem 0.2rem rgba(0, 0, 0, 0.1);
        position: relative;
        width: 80%;
        min-width: 720px;
        aspect-ratio: 3.7;
        overflow: hidden;
    }

    .review-book-item:hover {
        width: 81%;
        transition: width 0.1s linear;
    }

    .review-book-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .review-book-item p {
        font-size: 2.5rem;
        font-weight: 700;
        position: absolute;
        z-index: 100;
        margin-bottom: 0;
        bottom: 10%;
        right: 5%;
        color: #FFFFFF;
        transition: all 0.2s linear;
        text-shadow:
                -1px 0px rgba(0, 0, 0, 0.8),
                0px 1px rgba(0, 0, 0, 0.8),
                1px 0px rgba(0, 0, 0, 0.8),
                0px -1px rgba(0, 0, 0, 0.8);
    }

    /*리뷰 뷰어*/

    #review-book-info {
        position: absolute;
        z-index: 100;
        top: 1rem;
        left: 1rem;
        color: #FFFFFF;
        text-shadow:
                -1px 0px rgba(0, 0, 0, 0.8),
                0px 1px rgba(0, 0, 0, 0.8),
                1px 0px rgba(0, 0, 0, 0.8),
                0px -1px rgba(0, 0, 0, 0.8);
    }
    .modal-body {
        width: 100%;
    }

    #contents-wrap {
        width: 100%;
        max-height: 550px;
        overflow-y: scroll;
    }
    #contents-wrap::-webkit-scrollbar {
        width: 5px !important;
    }
    #contents-wrap::-webkit-scrollbar-thumb {
        height: 30%; /* 스크롤바의 길이 */
        background: #ddd; /* 스크롤바의 색상 */
        border-radius: 10px;
    }
    #contents-wrap::-webkit-scrollbar-track {
        background: #fff;  /*스크롤바 뒷 배경 색상*/
    }

    #my-comment-wrap {
        width: 100%;
    }

    #comment-area {
        flex: auto;
    }
    textarea {
        resize: none;
    }
    #comment-btn {
        padding: 5px;
        width: 70px;
    }
    #touritem-wrap {
        padding: 5px;
        position: absolute;
        z-index: 100;
        bottom: 3rem;
        left: 2rem;
    }
    .fa-location-dot{
        color: #000000;
        font-size: 25px;
    }
    #touritem-info {
        width: 15rem;
        position: absolute;
        bottom: -50%;
        right: 110%;
        display: none;
    }
    #touritem-info-title {
        margin-bottom: 0;
        font-size: 1.2rem;
        font-weight: 700;
    }
    #touritem-info-category {
        font-size: 0.8rem;
    }
    #touritem-name {
        font-size: 18px;
        color: #FFFFFF;
        text-shadow:
                -1px 0px rgba(0, 0, 0, 0.8),
                0px 1px rgba(0, 0, 0, 0.8),
                1px 0px rgba(0, 0, 0, 0.8),
                0px -1px rgba(0, 0, 0, 0.8);
    }

    #writer-info{
        cursor: pointer;
    }
    #writer-id {
        color: #999999;
    }

    #review-more-btn{
        display: inline-block;
        font: inherit;
        background: none;
        border: none;
        color: inherit;
        padding: 0;
        cursor: pointer;
    }

    /* swiper */
    .swiper {
        width: 100%;
        height: 750px;
        overflow: hidden;
    }

    .swiper-slide {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        font-size: 18px;
        color: #999999;
        background: #333333;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .swiper-slide img {
        display: block;
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .profile-img{
        object-fit: cover;
        width: 100%; /* 부모 요소에 꽉 차도록 설정 */
        height: 100%; /* 부모 요소에 꽉 차도록 설정 */
    }

    .profile-list-img{
        object-fit: cover;
        width: 50px; /* 부모 요소에 꽉 차도록 설정 */
        height: 50px; /* 부모 요소에 꽉 차도록 설정 */
    }

    .profile-image {
        width: 200px; /* 원하는 크기로 조정 */
        height: 200px; /* 원하는 크기로 조정 */
    }

    /*팔로우*/
    .profile-user-settings .follow-state {
        display: inline-block;
    }
    .modal-body .follow-btn, .modal-body .unfollow-btn {
        width: 100%;
    }
</style>
<div class="d-flex flex-nowrap">
    <th:block th:replace="~{fragments/sidebar}"></th:block>
    <div class="container">
        <div class="profile">
            <div class="profile-image">
                <img th:if="${findUser.profileImg == null}" src="/assets/img/profile.jpg" alt="프로필 이미지" class="profile-img rounded-circle me-2">
                <img th:unless="${findUser.profileImg == null}" th:src="|@{/api/image/profile/}${findUser.profileImg}|" alt="프로필 이미지" class="profile-img rounded-circle me-2">
            </div>

            <div class="profile-user-settings">
                <h1 class="profile-user-name" th:text="${findUser.name}"></h1>
                <th:block th:if="${findUser.id == loginUser.id}">
                    <button class="btn profile-edit-btn" onclick="location.href = '/editprofile'" >Edit Profile</button>
                    <button class="btn profile-settings-btn" aria-label="profile settings"  onclick="location.href = '/changePw'" ><i class="fas fa-cog" aria-hidden="true"></i></button>
                </th:block>

                <div class="follow-state" th:unless="${findUser.id == loginUser.id}">
                    <button class="btn btn-secondary unfollow-btn" th:if="${isFollowing}" th:data-user-id="${findUser.id}">언팔로우</button>
                    <button class="btn btn-primary follow-btn" th:unless="${isFollowing}" th:data-user-id="${findUser.id}">팔로우</button>
                </div>

                <div th:unless="${loginUser.id == 'anonymousUser'}">
                    <span th:if="${isFollowed}">나를 팔로우합니다.</span>
                </div>
            </div>

            <div class="profile-stats">
                <ul>
                    <li><span class="profile-stat-count" th:text="${reviewCount}"></span> posts</li>
                    <li id="followers"><span class="profile-stat-count"></span> followers</li>
                    <li id="following"><span class="profile-stat-count"></span> following</li>
                </ul>
            </div>

            <div class="profile-bio">
                <div class="profile-real-name" th:text="${findUser.id}"></div>
                <div th:text="${findUser.about}"></div>
            </div>
        </div>
        <!-- End of profile section -->
        <ul class="nav nav-underline mb-3 justify-content-center">
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" onclick="changeTab('REVIEW')">내 리뷰</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="changeTab('REVIEWBOOK')">내 리뷰북</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="changeTab('LIKE')">관심 리뷰</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="changeTab('BOOKMARK')">북마크</a>
            </li>
        </ul>

        <div class="gallery">

        </div>
        <!-- End of gallery -->

        <div id="load-point"></div>
        <div class="loader"></div>
    </div>

    <!-- 리뷰 상세 조회 폼 -->
    <div id="viewer" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="true" tabindex="-1" aria-labelledby="viewerLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="container-fluid">
                    <div class="row">
                        <div class="preview-container col-md-7">
                            <div id="review-book-info" class="d-flex align-items-center">
                                <div class="rounded-3 icon-img">
                                    <img id="review-book-cover" src="../assets/img/review_book_cover.jpg" alt="...">
                                </div>
                                <span id="review-book-title" class="ms-2">리뷰 북 타이틀</span>
                            </div>
                            <div id="touritem-wrap" class="d-flex align-items-center gap-2">
                                <div id="touritem-info" class="card">
                                    <img id="touritem-info-img" src="../assets/img/no_img.jpg" class="card-img-top" alt="...">
                                    <div class="card-body">
                                        <p id="touritem-info-title" class="card-text">관광지 이름</p>
                                        <p id="touritem-info-address" class="card-text">관광지 주소</p>
                                        <p id="touritem-info-category" class="card-text">관광지 카테고리</p>
                                    </div>
                                </div>
                                <i class="fa-solid fa-location-dot"></i>
                                <span id="touritem-name">관광지 이름</span>
                            </div>
                            <div class="swiper viewSwiper">
                                <div class="swiper-wrapper">
                                    <div class="swiper-slide">사진을 추가해주세요.</div>
                                </div>
                                <div class="swiper-controller">
                                    <div class="swiper-button-next"></div>
                                    <div class="swiper-button-prev"></div>
                                    <div class="swiper-pagination"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5 d-flex align-items-start">
                            <div class="modal-body">
                                <div id="writer-wrap" class="mb-2 d-flex align-items-center justify-content-between">
                                    <div id="writer-info" class="d-flex align-items-center">
                                        <div class="rounded-circle icon-img">
                                            <img id="writer-profile-img" src="../assets/img/profile.jpg" alt="...">
                                        </div>
                                        <strong id="writer-name" class="ms-2">작성자 이름</strong>
                                        <span id="writer-id" class="ms-2">@writerId</span>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <div id="review-regdate">
                                            yyyy-mm-dd
                                        </div>
                                        <div class="btn-group">
                                            <button id="review-more-btn" type="button" class="btn dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fas fa-cog" aria-hidden="true"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a id="review-edit" class="dropdown-item" href="#">수정</a></li>
                                                <li><span id="review-delete" class="dropdown-item">삭제</span></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div id="contents-wrap" class="mb-2">
                                    <div id="content">
                                    </div>
                                    <hr class="comment-line">
                                    <div id="comment-wrap">
                                        <div class="comment-info d-flex">
                                            <div class="rounded-circle icon-img comment-profile">
                                                <img src="../assets/img/profile.jpg" alt="...">
                                            </div>
                                            <div class="comment-text">
                                                <span class="comment-writer me-3">댓글 아이디</span>
                                                <span class="comment-content">댓글 내용</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="small-review-icons d-flex gap-2">
                                    <i class="bi bi-chat-square-dots"></i><span class="comment-count">0000</span>
                                    <i class="like-btn bi bi-star"></i><span class="like-count">0000</span>
                                    <i class="bi bi-eye"></i><span class="view-count">0000</span>
                                </div>
                                <div id="my-comment-wrap" class="d-flex align-items-start">
                                    <div class="rounded-circle icon-img">
                                        <img id="login-user-profile-img" src="../assets/img/profile.jpg" alt="...">
                                    </div>
                                    <div id="comment-area" class="ms-2">
                                        <div id="login-user-name" class="mb-2">작성자 이름</div>
                                        <span class="invisible-parent-writer"></span>
                                        <div class="d-flex gap-1">
                                            <div contenteditable="true" id="comment-content" class="form-control"></div>
                                            <button id="comment-btn" type="button" class="btn btn-outline-secondary">등록</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 리뷰 작성 폼 : 리뷰북 선택 -->
    <div id="select-book" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="selectBookLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="selectBookLabel">리뷰북 선택</h1>
                </div>
                <div class="modal-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="selectReviewBook" id="selectReviewBook1" value="1">
                        <label class="form-check-label" for="selectReviewBook1">
                            새 리뷰북 생성 <button id="create-book-btn" type="button" class="btn btn-outline-primary btn-sm ms-1" onclick="createSimpleBook()">생성</button>
                            <select id="new-book-item-select" class="book-input form-select form-select-sm mt-2" aria-label="Default select example" onchange="writeBookTitle()">
                                <option value="hint" class="select-hint" selected>리뷰북에 기록할 여행일정을 선택하세요.</option>
                            </select>
                            <input id="new-book-title" class="book-input form-control form-control-sm mt-2" type="text" placeholder="제목을 입력해주세요." aria-label=".form-control-sm example">
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="selectReviewBook" id="selectReviewBook2" value="2">
                        <label class="form-check-label" for="selectReviewBook2">
                            기존 리뷰북에 추가
                            <select id="exist-book-select" class="book-input form-select form-select-sm mt-2" aria-label="Default select example">
                                <option value="hint" class="select-hint" selected>리뷰를 작성할 리뷰북을 선택하세요.</option>
                            </select>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="selectReviewBook" id="selectReviewBook3" value="3">
                        <label class="book-input form-check-label" for="selectReviewBook3">
                            리뷰북을 선택하지 않고 리뷰 작성
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-sm btn-primary" onclick="goEdit()">다음</button>
                </div>
            </div>
        </div>
    </div>

    <!--  리뷰 작성 폼 : 리뷰 작성  -->
    <div id="editor" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="editorLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="container-fluid">
                    <div class="row">
                        <div class="preview-container col-md-7">
                            <div class="add-file">
                                <label for="img-uploader" class="uploader border border-primary rounded-pill">사진 추가</label>
                                <input type="file" id="img-uploader" accept=".gif, .jpg, .png" onchange="setPreview()" multiple/>
                            </div>
                            <div class="swiper editSwiper">
                                <div class="swiper-wrapper">
                                    <div class="swiper-slide">사진을 추가해주세요.</div>
                                </div>
                                <div class="swiper-controller">
                                    <div class="swiper-button-next"></div>
                                    <div class="swiper-button-prev"></div>
                                    <div class="swiper-pagination"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5 d-flex align-items-center">
                            <div class="modal-body">
                                <div class="mb-2">
                                    <label for="selected-review-book" class="form-label">리뷰북</label>
                                    <input type="text" class="form-control form-control-sm" id="selected-review-book" readonly>
                                </div>
                                <div class="mb-2">
                                    <label for="select-touritem-info" class="form-label">관광지 정보 불러오기</label>
                                    <select class="form-select form-select-sm" id="select-touritem-info" onchange="selectTouritem()">
                                        <option value="hint" class="select-hint" disabled selected>관광지 정보를 선택해주세요.</option>
                                        <option value="direct">직접 입력</option>
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label for="selected-touritem-name" class="form-label">관광지 이름 작성</label>
                                    <input type="text" class="form-control form-control-sm" id="selected-touritem-name" disabled>
                                </div>
                                <div class="mb-3">
                                    <label for="review-contents" class="form-label">본문</label>
                                    <textarea class="form-control form-control-sm" id="review-contents"></textarea>
                                </div>
                                <div class="editor-btn-group d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#select-book">이전</button>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="createPost()">완료</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--  리뷰북 작성 폼 -->
    <div id="book-editor" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="bookEditorLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="bookEditorLabel">리뷰북 생성</h1>
                </div>
                <div class="modal-body">
                    <div id="book-cover-wrap" class="d-flex align-items-center justify-content-center mb-3">
                        <img id="book-preview-img" src="../assets/img/review_book_cover.jpg"/>
                        <p id="book-preview-title">리뷰북 제목</p>
                    </div>
                    <div class="mb-2">
                        <label for="book-select-planner" class="form-label">여행일정 선택</label>
                        <select class="form-select form-select-sm" id="book-select-planner" onchange="selectTouritem()">
                            <option value="hint" class="select-hint" selected>리뷰북에 기록할 여행일정을 선택하세요.</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <span for="book-img-uploader" class="form-label cursor-default">커버 이미지 선택</span>
                        <label for="book-img-uploader" id="book-img-uploader-label" class="cursor-pointer ms-1"><i class="bi bi-camera-fill"></i></label>
                        <input type="file" id="book-img-uploader" accept=".gif, .jpg, .png" onchange="setBookCoverPreview()"/>
                        <div class="mt-1 ms-2">
                            <sapn id="select-book-img">선택된 파일이 없습니다.</sapn>
                            <i id="book-img-delete-btn" class="bi bi-x ms-1 p-1 cursor-pointer" onclick="deleteBookCoverImg()"></i>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label for="book-title" class="form-label">제목</label>
                        <input type="text" class="form-control form-control-sm" id="book-title" maxlength="21" placeholder="제목을 입력해주세요.">
                    </div>
                    <div class="mb-3">
                        <label for="book-contents" class="form-label">상세정보</label>
                        <textarea class="form-control form-control-sm" id="book-contents" maxlength="101"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-sm btn-primary" onclick="createFullBook()">생성</button>
                </div>
            </div>
        </div>
    </div>

    <button type="button" id="new-review-btn" class="create-btn position-fixed rounded-pill btn btn-outline-primary">
        <i class="bi bi-vector-pen"></i>
    </button>
    <button type="button" id="new-book-btn" class="create-btn position-fixed rounded-pill btn btn-outline-primary">
        <i class="bi bi-book"></i>
    </button>

    <!-- 팔로워 Modal -->
    <div class="modal fade" id="followersModal" tabindex="-1" role="dialog" aria-labelledby="followersModalLabel" aria-hidden="true">
        <div class="modal-dialog  modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="followersModalLabel">팔로워리스트</h5>
                    <button type="button" class="btn btn-sm close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="follower-list">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 팔로잉 Modal -->
    <div class="modal fade" id="followingModal" tabindex="-1" role="dialog" aria-labelledby="followingModalLabel" aria-hidden="true">
        <div class="modal-dialog  modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="followingModalLabel">팔로잉리스트</h5>
                    <button type="button" class="btn btn-sm close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="following-list">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
    <!-- End of container -->
</div>

<!-- 좋아요 관련 스크립트 -->
<script th:inline="javascript">

    $('.like-btn').click(function (){
        let loginUserId = [[${loginUser.id}]]
        let reviewId = $(this).data('review-id');

        if(loginUserId === 'anonymousUser'){
            alert('관심리뷰는 로그인 후 등록하실 수 있습니다.');
            location.href = '../login'
        }else {
            $.ajax({
                url : `/api/like/${reviewId}`,
                type : 'POST',
                success : function (result){
                    const likeCount = result.likeCount;
                    const likeState = result.likeState;
                    if(likeState){
                        $(`.review-icons > .like-btn[data-review-id="${reviewId}"]`).removeClass("bi-star");
                        $(`.review-icons > .like-btn[data-review-id="${reviewId}"]`).addClass("bi-star-fill");
                        $('.small-review-icons .like-btn').removeClass("bi-star");
                        $('.small-review-icons .like-btn').addClass("bi-star-fill");
                    }else {
                        $(`.review-icons > .like-btn[data-review-id="${reviewId}"]`).removeClass("bi-star-fill");
                        $(`.review-icons > .like-btn[data-review-id="${reviewId}"]`).addClass("bi-star");
                        $('.small-review-icons .like-btn').removeClass("bi-star-fill");
                        $('.small-review-icons .like-btn').addClass("bi-star");
                    }
                    $(`.gallery-item > .card-body > .like-count[data-review-id="${reviewId}"]`).html(`${likeCount} 명이 이 리뷰를 좋아합니다.`);
                    $('.small-review-icons .like-count').html(likeCount)
                },
                error : function (err) {
                    console.log(err)
                }
            })
        }
    })
</script>

<!-- 리뷰 뷰어 관련 스크립트 -->
<script th:inline="javascript">
    $(document).ready(function (){
        /* 리뷰 상세 조회 관련 설정 */
        $('.viewSwiper .swiper-controller').hide();
    });

    let savedFile = []; // 기존 저장된 이미지 파일의 id를 저장할 배열

    // swiper 설정
    var viewSwiper = new Swiper(".viewSwiper", {
        observer: true,
        observeParents: true,
        navigation: {
            nextEl: ".swiper-button-next",
            prevEl: ".swiper-button-prev",
        },
        pagination: {
            el: ".swiper-pagination",
        },
        mousewheel: true,
        keyboard: true,
    });

    let selectedReviewId;

    let loginUserId = [[${loginUser.id}]];
    function openViewer(reviewId) {
        selectedReviewId = reviewId;

        let loginUser = [[${loginUser.id}]] === 'anonymousUser' ? "로그인 후 이용해주세요." : [[${loginUser.id}]];
        let loginUserProfile = [[${loginUser.profileImg}]] === null ? null : [[${loginUser.profileImg}]];
        $('#comment-wrap').html("");
        $('#comment-content').html('');

        let promise = new Promise((resolve) => {
            $.ajax({
                url : `/api/review/${selectedReviewId}/view-count`,
                type : 'PUT',
                success : function (viewCount) {
                    resolve();
                },
                error : function (err) {
                    console.log(err)
                }
            })
        });
        promise.then(() => {
            $('#viewer').modal('show');
            $('#login-user-name').text(loginUser);
            if(loginUserProfile != null){
                $('#login-user-profile-img').attr('src','/api/image/profile/' + loginUserProfile);
            }
            loadDetailReview();
            showComments(0);
            showAllCommentsCount();
            postNewComment();
            parentId = null;
            $('.invisible-parent-writer').html("");
            $('.parent-writer').remove();
        });
    }
    function loadDetailReview(){
        $.ajax({
            url : `/api/review/${selectedReviewId}`,
            type : 'GET',
            contentType : 'application/json; charset=UTF-8',
            success : function (findReview) {
                let writer = findReview.userInfo;
                let photoList = findReview.reviewPhotoList;
                let regDate = (findReview.regDate === findReview.modDate) ? formatRegDate(findReview.regDate) : formatRegDate(findReview.modDate) + ' (수정됨)';

                $('#writer-info').click(function (){
                    savePage
                    location.href = `/mypage/${writer.id}`
                })
                $('#writer-name').text(writer.name);
                $('#writer-id').text('@' + writer.id);
                if(writer.id === [[${loginUser.id}]]){
                    $('#writer-wrap .btn-group').addClass('d-flex').show();
                    $('#review-edit').attr('href',`../review/edit/${selectedReviewId}`);
                    $('#review-delete').off('click').on('click', function (){
                        deleteReview(selectedReviewId);
                    })
                }else {
                    $('#writer-wrap .btn-group').removeClass('d-flex').hide();
                }
                if(writer.profileImg != null){
                    $('#writer-profile-img').attr('src','/api/image/profile/' + writer.profileImg);
                }
                $('#review-regdate').text(regDate);

                $('#content').html((findReview.reviewContent).replace(/\r\n/g,"<br/>"));
                if(findReview.reviewBookId == null){
                    $('#review-book-info').removeClass('d-flex').hide();
                }else {
                    $('#review-book-info').addClass('d-flex').show();
                    $('#review-book-info').addClass('cursor-pointer')
                    $('#review-book-info').off().click(function (){
                        savePage
                        location.href = `../book?bookid=${findReview.reviewBookId}`;
                    })
                    $('#review-book-title').text(findReview.reviewBookTitle);
                    if(findReview.reviewBookCoverImg != null){
                        $('#review-book-cover').attr('src','/api/image/book/' + findReview.reviewBookCoverImg);
                    }
                }
                $('#touritem-name').text(findReview.tourItemTitle);
                $('#touritem-name').attr('data-touritem-id', findReview.tourItemId);
                $('.viewSwiper .swiper-wrapper').html("");
                for(let photo of photoList){
                    savedFile.push(photo.fileId);
                    const tempHtml = `<div class="swiper-slide">` +
                        `<img class="preview-img" data-file-id="${photo.fileId}" src="/api/image/review/${photo.filePath}" style="object-fit: contain"/>` +
                        `</div>`;
                    viewSwiper.appendSlide(tempHtml);
                    viewSwiper.update();
                }
                let fileLength = savedFile.length;
                if(fileLength > 1){
                    $('.viewSwiper .swiper-controller').show()
                }else {
                    $('.viewSwiper .swiper-controller').hide()
                };
                $('.small-review-icons .view-count').html(findReview.viewCount)
            },
            error : function (){
                alert("리뷰 정보 조회에 실패했습니다.")
            }
        })
        $.ajax({
            url : `/api/like/${selectedReviewId}`,
            type : 'GET',
            success : function (result){
                const likeCount = result.likeCount;
                const likeState = result.likeState;
                $('.small-review-icons .like-btn').data('review-id',selectedReviewId);
                $('.small-review-icons .like-count').html(likeCount);
                if(likeState){
                    $('.small-review-icons .like-btn').removeClass("bi-star");
                    $('.small-review-icons .like-btn').addClass("bi-star-fill");
                }else {
                    $('.small-review-icons .like-btn').removeClass("bi-star-fill");
                    $('.small-review-icons .like-btn').addClass("bi-star");
                }

            },
            error : function (err){
                console.log(err)
            }
        })
    }

    // 댓글 시간 포맷
    function formatRegDate(regDateStr) {
        const regDate = new Date(regDateStr);
        const now = new Date();

        // 현재시간과 regDate의 차이 계산 (밀리초 단위)
        const diff = now - regDate;

        // 밀리초를 분, 시, 일, 주 단위로 변환
        const diffMinutes = Math.floor(diff / (60 * 1000));
        const diffHours = Math.floor(diff / (60 * 60 * 1000));
        const diffDays = Math.floor(diff / (24 * 60 * 60 * 1000));

        // 조건에 따라 적절한 문자열 반환
        if (diffMinutes < 60) {
            return `${diffMinutes}분 전`;
        } else if (diffHours < 24) {
            return `${diffHours}시간 전`;
        } else if (diffDays < 7) {
            return `${diffDays}일 전`;
        } else {
            // regDate를 'yyyy-mm-dd' 형식으로 포맷팅
            const year = regDate.getFullYear();
            const month = String(regDate.getMonth() + 1).padStart(2, '0');
            const day = String(regDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    }

    // 댓글 리스트 조회
    function showComments(page) {
        $.ajax({
            url : `/api/review/${selectedReviewId}/comments`,
            type : 'GET',
            data : {
                page: page
            },
            success : function (result){
                $('.next-comment-btn').remove();
                let commentList = result.dtoList;
                if(commentList.length > 0){
                    $.each(commentList, function (index, comment){
                        if(comment.cmtDel){
                            let tempHtml = '<div class="comment-info"><div class="d-flex deleted-comment">삭제된 댓글 입니다.</div></div>'
                            $('#comment-wrap').append(tempHtml);
                        }else {
                            let profileImg;
                            let regDate = (comment.regDate === comment.modDate) ? formatRegDate(comment.regDate) : formatRegDate(comment.modDate) + ' (수정됨)';
                            if(comment.writer.profileImg == null){
                                profileImg = '../assets/img/profile.jpg';
                            }else {
                                profileImg = `/api/image/profile/${comment.writer.profileImg}`;
                            }

                            let tempHtml =
                                '<div class="comment-info">' +
                                '<div class="d-flex">' +
                                '<div class="rounded-circle icon-img comment-profile">' +
                                `<a href="/mypage/${comment.writer.id}">` +
                                `<img src="${profileImg}" alt="...">` +
                                '</a>' +
                                '</div>' +
                                `<div class="comment-text" data-comment-id="${comment.commentId}">` +
                                '<div class="d-flex justify-content-between gap-2">' +
                                `<a href="/mypage/${comment.writer.id}" class="comment-writer me-3">@${comment.writer.id}</a>` +
                                '<div class="d-flex">' +
                                `<span class="comment-regdate">${regDate}</span>`;

                            if(loginUserId === comment.writer.id){
                                tempHtml +=
                                    '<button type="button" class="btn comment-more-btn" data-bs-toggle="dropdown" aria-expanded="false">' +
                                    '<i class="bi bi-three-dots-vertical" aria-hidden="true"></i>' +
                                    '</button>' +
                                    '<ul class="dropdown-menu">' +
                                    '<li><span class="comment-edit dropdown-item">수정</span></li>' +
                                    '<li><span class="comment-delete dropdown-item">삭제</span></li>' +
                                    '</ul>';
                            }

                            tempHtml +=
                                '</div>' +
                                '</div>' +
                                `<span class="comment-content">${comment.content}</span>` +
                                `<span class="reply-btn ms-3" data-parent-writer="${comment.writer.id}" data-parent-id="${comment.commentId}">답글쓰기</span>` +
                                '</div>' +
                                '</div>';
                            if(comment.childrenCount > 0){
                                tempHtml +=
                                    `<div class="more-reply-btn" data-group="${comment.group}" data-page="0">답글 더 보기(${comment.childrenCount}개)</div>` +
                                    `<div class="close-reply-btn" data-group="${comment.group}">답글 접기</div>`;
                            }
                            tempHtml +=
                                `<div class="reply-wrap" data-group="${comment.group}"></div>` +
                                `<div class="next-reply-btn" data-group="${comment.group}">답글 더 보기</div></div>`;

                            $('#comment-wrap').append(tempHtml);
                        }
                    })
                    if(result.page < result.last){
                        let btn = `<div class="next-comment-btn" onclick="showComments(${Number(page)+1})">- 댓글 더 보기 -</div>`
                        $('#comment-wrap').append(btn);
                    }
                }else {
                    let tempHtml =
                        '<div class="no-comment-msg d-flex mb-2">아직 등록된 리뷰가 없습니다.</div>';
                    $('#comment-wrap').append(tempHtml);
                }
            },
            error : function (err) {
                console.log(err);
                alert("댓글 정보 조회에 실패하였습니다.")
            }
        })
    }

    // 댓글 갯수 조회
    function showAllCommentsCount(){
        let test = $(`small.comment-count[data-review-id="${selectedReviewId}"]`).html();
        $.ajax({
            url : `/api/review/${selectedReviewId}/comments/count`,
            type : 'GET',
            success : function (count){
                $('.small-review-icons .comment-count').html(count);
                $(`small.comment-count[data-review-id="${selectedReviewId}"]`).html(`댓글 ${count}개`);
            },
            error : function (err){
                console.log(err);
            }
        })
    }

    let parentId = null;

    // 댓글 작성
    function postNewComment() {
        $('#comment-btn').off('click').on('click', function (){

            if(loginUserId === 'anonymousUser'){
                alert('댓글은 로그인 후 등록하실 수 있습니다.');
                location.href = '../login'
            }else {
                let content = $('#comment-content').html();
                content = content.replace(/<input.*?>/s, "")
                content = content.replace(/<div>/g,'\r\n');
                content = content.replace(/<\/div>/g,'');

                let data = {
                    reviewId : selectedReviewId,
                    content : content
                }

                if(parentId != null){
                    data.parentId = parentId;
                }

                $.ajax({
                    url : `/api/review/${selectedReviewId}/comment`,
                    type : 'POST',
                    data : JSON.stringify(data),
                    contentType : 'application/json; charset=UTF-8',
                    success : function (commentId){
                        $('.no-comment-msg').remove();
                        showRecentComment();
                        $('#comment-content').html("");
                        showAllCommentsCount();
                        $('.invisible-parent-writer').html("");
                        if(parentId != null){
                            addTempReply(commentId);
                        }
                        parentId = null;
                    },
                    error : function (){
                        alert("댓글 등록에 실패하였습니다.");
                    }
                })
            }
        })
    }

    function addTempReply(commentId){
        $.ajax({
            url : `/api/comment/${commentId}/temp-reply`,
            type : 'GET',
            success : function (result){
                let reply = result.reply;
                let replyCount = result.replyCount;
                let profileImg;
                let regDate = (reply.regDate === reply.modDate) ? formatRegDate(reply.regDate) : formatRegDate(reply.modDate) + ' (수정됨)';
                let group = reply.group;
                if(reply.writer.profileImg == null){
                    profileImg = '../assets/img/profile.jpg';
                }else {
                    profileImg = `/api/image/profile/${reply.writer.profileImg}`;
                }

                let tempHtml =
                    `<div class="comment-info temp-reply" data-comment-id="${reply.commentId}">` +
                    '<div class="d-flex">' +
                    '<div class="rounded-circle icon-img comment-profile">' +
                    `<a href="/mypage/${reply.writer.id}">` +
                    `<img src="${profileImg}" alt="...">` +
                    '</a>' +
                    '</div>' +
                    `<div class="comment-text" data-comment-id="${reply.commentId}">` +
                    '<div class="d-flex justify-content-between gap-2">' +
                    `<a href="/mypage/${reply.writer.id}" class="comment-writer me-3">@${reply.writer.id}</a>` +
                    '<div class="d-flex">' +
                    `<span class="comment-regdate">${regDate}</span>`;

                if(loginUserId === reply.writer.id){
                    tempHtml +=
                        '<button type="button" class="btn comment-more-btn" data-bs-toggle="dropdown" aria-expanded="false">' +
                        '<i class="bi bi-three-dots-vertical" aria-hidden="true"></i>' +
                        '</button>' +
                        '<ul class="dropdown-menu">' +
                        '<li><span class="comment-edit dropdown-item">수정</span></li>' +
                        '<li><span class="comment-delete dropdown-item">삭제</span></li>' +
                        '</ul>';
                }

                tempHtml +=
                    '</div>' +
                    '</div>' +
                    `<span class="comment-content"><span class="reply-parent-writer">@${reply.parentWriterId}</span>${reply.content}</span>` +
                    `<span class="reply-btn ms-3" data-parent-writer="${reply.writer.id}" data-parent-id="${reply.commentId}">답글쓰기</span>` +
                    '</div>' +
                    '</div>';

                $(`.reply-wrap[data-group="${group}"]`).append(tempHtml);
                $(`.more-reply-btn[data-group="${group}"]`).text(`답글 더 보기(${replyCount}개)`)
            },
            error : function (err){
                console.log(err)
            }
        })
    }

    // 답글 작성
    $(document).on('click', '.reply-btn', function() {
        // this를 사용하여 클릭된 버튼에 접근
        parentId = $(this).data('parent-id');
        let parentWriter = $(this).data('parent-writer');
        $('.parent-writer').remove();
        $('.invisible-parent-writer').html(`@${parentWriter} `);
        $('#comment-content').prepend(`<input type="text" class="parent-writer" value="@${parentWriter}" disabled>`);
        let parentWriterWidth = $('.invisible-parent-writer').css('width')
        $('.parent-writer').css("width",parentWriterWidth);
        $('#comment-content').focus();
    });

    // 댓글 작성란 키보드 이벤트
    // 방향키 커서 이동 시 스와이퍼 슬라이드 이동 방지
    // 답글 상대 id input 삭제 시 parentId 초기화
    $('#comment-content').on('keydown', function(e) {
        if(e.key === 'Backspace' || e.keyCode === 8){
            setTimeout(function (){
                let parentWriterCount = $('.parent-writer').length;
                if(parentWriterCount < 1){
                    parentId = null;
                    $('.invisible-parent-writer').html("");
                }
            },10)
        }
        e.stopPropagation();
    })

    // 답글 삭제
    $(document).on('click','.comment-delete', function (){
        let commentId = $(this).closest('.comment-text').attr('data-comment-id');
        let comment = $(this).closest('.comment-info').children('.d-flex').first();

        $.ajax({
            url : `/api/comment/${commentId}`,
            type : 'DELETE',
            success : function (){
                $(comment).addClass('deleted-comment');
                $(comment).html('삭제된 댓글 입니다.');
            },
            error : function (err){
                alert("댓글 삭제에 실패했습니다.");
                console.log(err)
            }
        })
    })

    // 답글 수정 - 입력폼 변경
    $(document).on('click','.comment-edit', function (){
        let commentInfo = $(this).closest('.comment-info');
        let targetComment = $(commentInfo).children('.d-flex').first();

        let commentText = $(this).closest('.comment-text');
        let commentClone = $(commentText).children('.comment-content').clone();
        commentClone.find('.reply-parent-writer').remove();
        let originContent = commentClone.html();

        let editCommentContent =
            '<div class="d-flex comment-editor gap-1">' +
            `<i class="bi bi-arrow-return-right"></i>` +
            `<div contenteditable="true" class="edit-comment-content form-control">${originContent}</div>` +
            '<button type="button" class="edit-comment-btn btn btn-outline-secondary">수정</button>' +
            '</div>'

        $(targetComment).after(editCommentContent);
        setTimeout(function (){
            commentInfo.find('.edit-comment-content').focus();
        },50)
    })

    // 댓글 수정
    $(document).on('click','.edit-comment-btn', function (){
        let commentText = $(this).closest('.comment-info').find('.comment-text').first();
        let commentId = $(commentText).attr('data-comment-id');
        let content = $(this).prev('.edit-comment-content').html();
        content = content.replace(/<div>/g,'\r\n');
        content = content.replace(/<\/div>/g,'');

        let commentEditor = $(this).closest('.comment-editor');
        $.ajax({
            url : `/api/comment/${commentId}`,
            type : 'PUT',
            data : JSON.stringify({
                commentId : commentId,
                content : content
            }),
            contentType : 'application/json; charset=UTF-8',
            success : function (result){
                const type = result.type;
                let updatedComment = result.updatedComment;
                let modDate = formatRegDate(updatedComment.modDate) + ' (수정됨)';
                if(type === 'comment'){
                    commentText.find('.comment-regdate').text(modDate);
                    commentText.find('.comment-content').html(updatedComment.content);
                }else if(type === 'reply'){
                    commentText.find('.comment-regdate').text(modDate);
                    let content = `<span class="reply-parent-writer">@${updatedComment.parentWriterId}</span>` + updatedComment.content;
                    commentText.find('.comment-content').html(content);
                }
                commentEditor.remove();
            },
            error : function (err){
                alert('댓글 수정에 실패했습니다.');
                console.log(err);
            }
        })
    })

    // 답글 리스트 조회
    $(document).on('click','.more-reply-btn, .next-reply-btn', function (){
        let group = $(this).attr('data-group');
        let page = $(this).attr('data-page');

        $.ajax({
            url : `/api/review/${selectedReviewId}/comment/${group}/replies`,
            type : 'GET',
            data : {
                page : page
            },
            success : function (result){
                let replyList = result.dtoList;
                $.each(replyList, function (index, reply){
                    // 답글 작성 시 임시로 추가된 답글이 더보기로 정상 출력되면 삭제.
                    $(`.reply-wrap[data-group="${group}"]`).find(`.temp-reply[data-comment-id="${reply.commentId}"]`).remove();
                    if(reply.cmtDel){
                        let tempHtml = '<div class="comment-info"><div class="d-flex deleted-comment">삭제된 댓글 입니다.</div></div>'
                        $(`.reply-wrap[data-group="${group}"]`).append(tempHtml);
                    }else {
                        let profileImg;
                        let regDate = (reply.regDate === reply.modDate) ? formatRegDate(reply.regDate) : formatRegDate(reply.modDate) + ' (수정됨)';
                        if(reply.writer.profileImg == null){
                            profileImg = '../assets/img/profile.jpg';
                        }else {
                            profileImg = `/api/image/profile/${reply.writer.profileImg}`;
                        }

                        let tempHtml =
                            '<div class="comment-info">' +
                            '<div class="d-flex">' +
                            '<div class="rounded-circle icon-img comment-profile">' +
                            `<a href="/mypage/${reply.writer.id}">` +
                            `<img src="${profileImg}" alt="...">` +
                            '</a>' +
                            '</div>' +
                            `<div class="comment-text" data-comment-id="${reply.commentId}">` +
                            '<div class="d-flex justify-content-between gap-2">' +
                            `<a href="/mypage/${reply.writer.id}" class="comment-writer me-3">@${reply.writer.id}</a>` +
                            '<div class="d-flex">' +
                            `<span class="comment-regdate">${regDate}</span>`;

                        if(loginUserId === reply.writer.id){
                            tempHtml +=
                                '<button type="button" class="btn comment-more-btn" data-bs-toggle="dropdown" aria-expanded="false">' +
                                '<i class="bi bi-three-dots-vertical" aria-hidden="true"></i>' +
                                '</button>' +
                                '<ul class="dropdown-menu">' +
                                '<li><span class="comment-edit dropdown-item">수정</span></li>' +
                                '<li><span class="comment-delete dropdown-item">삭제</span></li>' +
                                '</ul>';
                        }

                        tempHtml +=
                            '</div>' +
                            '</div>' +
                            `<span class="comment-content"><span class="reply-parent-writer">@${reply.parentWriterId}</span>${reply.content}</span>` +
                            `<span class="reply-btn ms-3" data-parent-writer="${reply.writer.id}" data-parent-id="${reply.commentId}">답글쓰기</span>` +
                            '</div>' +
                            '</div>';

                        $(`.reply-wrap[data-group="${group}"]`).append(tempHtml);
                    }
                })
                $(`.more-reply-btn[data-group="${group}"]`).hide();
                $(`.close-reply-btn[data-group="${group}"]`).show().css('display','flex');
                $(`.next-reply-btn[data-group="${group}"]`).attr('data-page',Number(page) +1);
                if(result.page < result.last){
                    $(`.next-reply-btn[data-group="${group}"]`).show().css('display','flex');
                }else {
                    $(`.next-reply-btn[data-group="${group}"]`).attr('data-page','last');
                    $(`.next-reply-btn[data-group="${group}"]`).hide();
                }
                $(`.more-reply-btn[data-group="${group}"]`).text(`답글 더 보기(${result.total}개)`);
            },
            error : function (err){
                console.log(err)
            }
        })
    })

    // 조회한 답글 접었다 펴기
    $(document).on('click','.close-reply-btn', function (){
        const info = $(this).closest('.comment-info');
        const page = $(info).children('.next-reply-btn').attr('data-page');

        if($(info).children('.reply-wrap').hasClass('hide')){
            $(info).children('.reply-wrap').removeClass('hide');
            $(this).text('답글 접기');
            $(info).children('.reply-wrap').children().show();
            if(page !== 'last'){
                $(info).children('.next-reply-btn').show();
            }
        }else {
            $(info).children('.reply-wrap').addClass('hide')
            const text = $(info).children('.more-reply-btn').text();
            $(this).text(text);
            $(info).children('.reply-wrap').children().hide();
            $(info).children('.next-reply-btn').hide();
        }
    })


    // 댓글 작성 시 최신 댓글 리스트까지 갱신
    function showRecentComment() {
        let lastCommentId = $('#comment-wrap .comment-info:first .comment-text').data('comment-id');
        console.log(lastCommentId);
        if(lastCommentId === undefined){
            $('#comment-wrap').html("");
            showComments(0);
        }else {
            $.ajax({
                url : `/api/review/${selectedReviewId}/comments/recent`,
                type : 'GET',
                data : {
                    last : lastCommentId
                },
                success : function (result){
                    let commentList = result;
                    if(commentList.length > 0) {
                        $.each(commentList, function (index, comment) {
                            if(comment.cmtDel){
                                let tempHtml = '<div class="comment-info deleted-comment">삭제된 댓글 입니다.</div>'
                                $('#comment-wrap').prepend(tempHtml);
                            }else {
                                let profileImg;
                                let regDate = (comment.regDate === comment.modDate) ? formatRegDate(comment.regDate) : formatRegDate(comment.modDate) + ' (수정됨)';
                                if(comment.writer.profileImg == null){
                                    profileImg = '../assets/img/profile.jpg';
                                }else {
                                    profileImg = `/api/image/profile/${comment.writer.profileImg}`;
                                }
                                let tempHtml =
                                    '<div class="comment-info">' +
                                    '<div class="d-flex">' +
                                    '<div class="rounded-circle icon-img comment-profile">' +
                                    `<img src="${profileImg}" alt="...">` +
                                    '</div>' +
                                    `<div class="comment-text" data-comment-id="${comment.commentId}">` +
                                    '<div class="d-flex justify-content-between gap-2">' +
                                    `<span class="comment-writer me-3">@${comment.writer.id}</span>` +
                                    '<div class="d-flex">' +
                                    `<span class="comment-regdate">${regDate}</span>`;

                                if(loginUserId === comment.writer.id){
                                    tempHtml +=
                                        '<button type="button" class="btn comment-more-btn" data-bs-toggle="dropdown" aria-expanded="false">' +
                                        '<i class="bi bi-three-dots-vertical" aria-hidden="true"></i>' +
                                        '</button>' +
                                        '<ul class="dropdown-menu">' +
                                        '<li><span class="comment-edit dropdown-item">수정</span></li>' +
                                        '<li><span class="comment-delete dropdown-item">삭제</span></li>' +
                                        '</ul>';
                                }

                                tempHtml +=
                                    '</div>' +
                                    '</div>' +
                                    `<span class="comment-content">${comment.content}</span>` +
                                    `<span class="reply-btn ms-3" data-parent-writer="${comment.writer.id}" data-parent-id="${comment.commentId}">답글쓰기</span>` +
                                    '</div>' +
                                    '</div>';
                                if(comment.childrenCount > 0){
                                    tempHtml += `<div class="more-reply-btn" data-group="${comment.group}" data-page="0">답글 더 보기(${comment.childrenCount}개)</div>` +
                                        `<div class="close-reply-btn" data-group="${comment.group}">답글 접기</div>`;
                                }
                                tempHtml += `<div class="reply-wrap" data-group="${comment.group}"></div>` +
                                    `<div class="next-reply-btn" data-group="${comment.group}">답글 더 보기</div></div>`;

                                $('#comment-wrap').prepend(tempHtml);
                            }
                        })
                    }
                },
                error : function (){
                    alert("댓글 등록에 실패하였습니다.")
                }
            })
        }
    }

    // 리뷰 뷰어에서 관광지 정보 조회
    let touritemInfoTimer;

    $('#touritem-wrap').mouseenter(function (){
        let tourItemId = $('#touritem-name').attr('data-touritem-id');
        if(tourItemId !== undefined){
            $('#touritem-wrap').css('cursor','pointer');
            $('#touritem-wrap').click(function (){
                savePage
                location.href = `../info/content/${tourItemId}`;
            })
            touritemInfoTimer = setTimeout(function () {
                showTourItemSimpleInfo(tourItemId)
            },200)
        }
    })
    $('#touritem-wrap').mouseleave(function (){
        $('#touritem-wrap').css('cursor','');
        clearTimeout(touritemInfoTimer);
        $('#touritem-info').hide();
    })

    function showTourItemSimpleInfo(tourItemId){
        $.ajax({
            url : `/api/review/simple-touritem/${tourItemId}`,
            type : 'GET',
            contentType : 'application/json; charset=UTF-8',
            success : function (tourItem){
                $('#touritem-info-img').attr('src',tourItem.firstimage);
                $('#touritem-info-title').text(tourItem.title);
                $('#touritem-info-address').text(tourItem.address);
                $('#touritem-info-category').text(tourItem.fullCategoryName);
                $('#touritem-info').show();
            },
            error : function (err){
                console.log(err);
            }
        })
    }

    function deleteReview(){
        const deleteConfirm = confirm("리뷰를 삭제하시겠습니까?");
        if(deleteConfirm){
            $.ajax({
                url : `/api/review/${selectedReviewId}`,
                type : 'DELETE',
                success : function (){
                    alert('삭제 되었습니다.')
                    savePage();
                    $('#viewer').modal('toggle');
                    changeTab(tabType);
                    setScrollByFeedInfo();
                },
                error : function (){
                    alert('삭제에 실패했습니다.')
                }
            })
        }
    }

    $('#new-review-btn').mouseenter(function (){
        let tempHtml = "<span>리뷰 작성</span>";
        $('#new-review-btn').append(tempHtml)
    })

    $('#new-review-btn').mouseleave(function (){
        $('#new-review-btn span').remove()
    })

    $('#comment-content').on('focus',function (){
        $('#comment-content').css('height','90px');
        $('#contents-wrap').css('max-height','500px')
        var inputExists = $(this).find('input').length > 0;
        if (inputExists) {
            placeCaretAtEnd(this);
        }
    })

    function placeCaretAtEnd(el) {
        el.focus();
        if (typeof window.getSelection != "undefined" && typeof document.createRange != "undefined") {
            var range = document.createRange();
            range.selectNodeContents(el);
            range.collapse(false);
            var sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }
    }

    $('#comment-content').on('blur',function (){
        $('#comment-content').css('height','50px');
        $('#contents-wrap').css('max-height','540px')
    })
</script>

<!-- 리뷰북 작성 관련 스크립트 -->
<script th:inline="javascript">
    $('#new-book-btn').click(function () {
        resetBookEditor();
        showPlannerList();
        $('#book-editor').modal('show');
    })
    $('#new-book-btn').mouseenter(function (){
        let tempHtml = "<span>리뷰북 생성</span>";
        $('#new-book-btn').append(tempHtml)
    })

    $('#new-book-btn').mouseleave(function (){
        $('#new-book-btn span').remove()
    })

    const bookFileInput = $('#book-img-uploader')[0];
    let bookCoverImg = null;

    function setBookCoverPreview(){
        let files = bookFileInput.files;

        if(files.length > 0){
            let file = files[0];
            bookCoverImg = file;

            let reader = new FileReader();

            reader.onload = function(data) {
                $('#book-preview-img').attr('src',data.target.result);
            };

            reader.readAsDataURL(file);
            $('#select-book-img').html(file.name);
            $('#book-img-delete-btn').show();

            setTimeout(function (){
                $('#book-img-uploader').val('');
            },500)
        }else {
            return
        }
    }

    function deleteBookCoverImg(){
        $('#book-preview-img').attr('src','../assets/img/review_book_cover.jpg');
        $('#select-book-img').html('선택된 파일이 없습니다.');
        $('#book-img-delete-btn').hide();
        let files = bookFileInput.files;
        files.length = 0;
        bookCoverImg = null;
    }

    function resetBookEditor() {
        bookCoverImg = null;
        deleteBookCoverImg()
        $('#book-select-planner').html('<option value="hint" class="select-hint" selected>리뷰북에 기록할 여행일정을 선택하세요.</option>');
        $('#book-title').val('');
        $('#book-contents').val('');
        $('#book-preview-title').html();
    }

    function showPlannerList() {
        $.ajax({
            url : '/api/book/me/show-planner',
            type : 'GET',
            success : function (plannerList) {
                if(plannerList.length > 0){
                    for(let planner of plannerList){
                        let template = `<option value=${planner.plannerId}>${planner.plannerName}</option>`;
                        $('#book-select-planner').append(template)
                    }
                }else {
                    let template = '<option value="hint" disabled>등록된 정보가 없습니다.</option>';
                    $('#book-select-planner').append(template)
                }
            },
            error : function (err) {
                console.log(err);
            }
        })
    }

    function changeBookTitle() {
        $("#book-title").on("propertychange change paste input", function() {
            let title = $(this).val();
            if(title.length > 20) {
                title = title.substring(0, 20);
                $("#book-title").val(title);
                alert("제목은 20자까지 입력할 수 있습니다.");
            }
            $('#book-preview-title').html(title);
        });
    }

    function checkBookContents() {
        $("#book-contents").on("propertychange change paste input", function() {
            let contents = $(this).val();
            if(contents.length > 100) {
                contents = contents.substring(0, 100);
                $("#book-contents").val(contents);
                alert("상세정보는 100자까지 입력할 수 있습니다.");
            }
        });
    }

    function createFullBook() {
        const plannerId = $("#book-select-planner option:selected").val();
        const bookTitle = $("#book-title").val();
        const bookContent = $("#book-contents").val();
        const coverFile = bookCoverImg;

        if(plannerId === 'hint') {
            alert("여행일정을 선택해주세요.");
            return;
        }else if(bookTitle === ''){
            alert('리뷰북의 제목을 입력해주세요.')
            return;
        }

        let formData = new FormData();
        formData.append("plannerId", plannerId);
        formData.append("bookTitle", bookTitle);
        if(bookContent != null){
            formData.append("bookContent", bookContent);
        }
        if(coverFile != null){
            formData.append("coverFile", coverFile);
        }

        $.ajax({
            url : '/api/book',
            type : 'POST',
            data : formData,
            processData : false,
            contentType : false,
            success : function () {
                alert(`[${bookTitle}] 리뷰북이 생성되었습니다.`);
                changeTab(tabType);
            },
            error : function (err) {
                alert("리뷰북 생성에 실패하였습니다.");
                console.log(err);
            }
        })

        $('#book-editor').modal('hide');
    }

</script>

<!--리뷰 작성 관련 스크립트-->
<script th:inline="javascript">
    let createBookFlag = false;
    let selectedReviewBook;
    let selectedBookId;
    const fileInput = $('#img-uploader')[0];
    const images = [];

    var editSwiper = new Swiper(".editSwiper", {
        observer: true,
        observeParents: true,
        navigation: {
            nextEl: ".swiper-button-next",
            prevEl: ".swiper-button-prev",
        },
        pagination: {
            el: ".swiper-pagination",
        },
        mousewheel: true,
        keyboard: true,
    });



    $('#new-review-btn').click(function () {
        editorReset();
        let login = [[${loginUser.id}]];
        if(login === "anonymousUser"){
            alert("리뷰는 로그인 후 작성할 수 있습니다.")
        }else {
            showSelectList();
            $('#select-book').modal('show');
        }
    })

    function editorReset() {
        //사진 미리보기 초기화
        images.length = 0;
        $('#img-uploader').val('');
        fileInput.files.length = 0;
        $('.editSwiper .swiper-wrapper').html('<div class="swiper-slide">사진을 추가해주세요.</div>');
        $('.uploader').show()
        // 리뷰북 선택 정보 초기화
        createBookFlag = false;
        $('input:radio[name=selectReviewBook]').prop('checked', false);
        $('#new-book-item-select').html('<option value="hint" class="select-hint" disabled selected>리뷰북에 기록할 여행정보를 선택하세요.</option>');
        $('#new-book-title').val('');
        $('#exist-book-select').html('<option value="hint" class="select-hint" disabled selected>리뷰를 작성할 리뷰북을 선택하세요.</option>');
        // 에디터 내용 초기화
        selectedReviewBook = null;
        selectedBookId = null;
        $('.book-input').attr('disabled', true);
        $('#selected-review-book').val('');
        $('#select-touritem-info').html(
            '<option value="hint" class="select-hint" disabled selected>관광지 정보를 선택해주세요.</option>' +
            '<option value="direct">직접 입력</option>'
        );
        $('#selected-touritem-name').val('');
        $('#selected-touritem-name').prop('disabled',true);
        $('#review-contents').val('');
    }

    function showSelectList(){
        $.ajax({
            url : '/api/review/me/show-list',
            type : 'GET',
            contentType : 'application/json; charset=UTF-8',
            success : function (result) {
                const plannerList = result.plannerList;
                const reviewBookList = result.reviewBookList;

                if(plannerList.length > 0){
                    for(let planner of plannerList){
                        let template = `<option value=${planner.plannerId}>${planner.plannerName}</option>`;
                        $('#new-book-item-select').append(template)
                    }
                }else {
                    let template = '<option value="hint" disabled>등록된 정보가 없습니다.</option>';
                    $('#new-book-item-select').append(template)
                }

                if(reviewBookList.length > 0){
                    for(let reviewBook of reviewBookList){
                        let template = `<option value=${reviewBook.bookId}>${reviewBook.bookTitle}</option>`;
                        $('#exist-book-select').append(template)
                    }
                }else {
                    let template = '<option value="hint" disabled>등록된 정보가 없습니다.</option>';
                    $('#exist-book-select').append(template)
                }
            },
            error : function (err) {
                console.log(err);
            }
        })
    }

    function selectBook() {
        $("input:radio[name=selectReviewBook]").click(function (){
            let select = Number($("input[name=selectReviewBook]:checked").val());
            $(".book-input").attr('disabled', true);
            switch (select){
                case 1:
                    $("#new-book-item-select").attr('disabled',false);
                    if($("#new-book-item-select option:selected").val() != "hint"){
                        writeBookTitle()
                    }
                    break;
                case 2:
                    $("#exist-book-select").attr('disabled',false);
                    break;
            }
        })
    }

    function writeBookTitle() {
        createBookFlag = false;
        $("#new-book-title").attr('disabled',false);
    }


    function goEdit(){
        let select = $("input[name=selectReviewBook]:checked").val();
        if(select == undefined){
            alert("리뷰북 설정을 완료해주세요.");
        }else {
            switch (Number(select)){
                case 1:
                    if($("#new-book-item-select option:selected").val() == 'hint'){
                        alert("리뷰북에 기록할 여행정보를 선택해주세요.")
                    }else if($("#new-book-title").val() == ''){
                        alert("생성할 리뷰북의 제목을 입력해주세요.")
                    }else if(!createBookFlag){
                        alert("생성 버튼을 눌러 리뷰북을 생성해주세요.")
                    }else {
                        selectedReviewBook = $("#new-book-title").val();
                        AddPlanList();
                    }
                    break;
                case 2:
                    if($("#exist-book-select option:selected").val() == 'hint'){
                        alert("리뷰를 작성할 리뷰북을 선택해주세요.")
                    }else {
                        selectedBookId = $('#exist-book-select option:selected').val();
                        selectedReviewBook = $("#exist-book-select option:checked").text();
                        AddPlanList();
                    }
                    break;
                case 3:
                    selectedReviewBook = "선택하지 않음";
                    $('#selected-review-book').val(selectedReviewBook);
                    $('#select-book, #editor').modal('toggle');
                    break;
            }
        }
    }

    function createSimpleBook(){
        const plannerId = $("#new-book-item-select option:selected").val();
        const bookTitle = $("#new-book-title").val();

        let formData = new FormData();
        formData.append("plannerId", plannerId);
        formData.append("bookTitle", bookTitle);

        $.ajax({
            url : '/api/book',
            type : 'POST',
            data : formData,
            processData : false,
            contentType : false,
            success : function (createdBookId) {
                createBookFlag = true;
                selectedBookId = createdBookId;
                alert(`[${bookTitle}] 리뷰북이 생성되었습니다.`);
            },
            error : function (err) {
                alert("리뷰북 생성에 실패하였습니다.");
                console.log(err);
            }
        })
    }

    function AddPlanList(){
        let promise = new Promise((resolve) => {
            $.ajax({
                url : '/api/review/me/show-plan',
                type : 'GET',
                data : {
                    bookid : selectedBookId
                },
                contentType : 'application/json; charset=UTF-8',
                success : function (result) {
                    const planList = result.planList;
                    for(let plan of planList){
                        let template = `<option value=${plan.tourItem.contentid}>[${plan.day}일차] ${plan.tourItem.title}</option>`;
                        $('#select-touritem-info').append(template);
                    }
                    resolve();
                },
                error : function (err) {
                    console.log(err);
                }
            })
        })

        promise.then(() => {
            $('#selected-review-book').val(selectedReviewBook);
            $('#select-book, #editor').modal('toggle');
        })
    }

    function selectTouritem(){
        let item = $('#select-touritem-info option:selected');
        let title = item.text();
        if(title !== '직접 입력'){
            let startTitleIdx = title.indexOf(']') +2;
            title = title.substring(startTitleIdx);
        }
        let titleInput = $('#selected-touritem-name');
        titleInput.attr('disabled',false);
        titleInput.val(title)
    }

    function createPost(){
        if(images.length < 1){
            alert("사진을 반드시 한 장 이상 첨부해주세요.")
        }else if($('#select-touritem-info option:selected').val() === 'hint'){
            alert("관광지 정보를 선택해주세요.")
        }else if($('#selected-touritem-name').val() === '' || $('#selected-touritem-name').val() === '직접 입력'){
            alert('관광지 이름을 작성해주세요.')
        }else if($('#review-contents').val() === ''){
            alert('본문 내용을 입력해주세요.')
        }else {
            saveReview();
            $('#editor').modal('hide');
        }
    }

    function saveReview(){
        let formData = new FormData();
        let touritemId = $('#select-touritem-info option:selected').val();

        if(selectedBookId !== null) formData.append("bookId", selectedBookId);
        if(touritemId !== 'direct') formData.append("touritemId", touritemId);
        formData.append("touritemTitle", $('#selected-touritem-name').val());
        formData.append("reviewContent", $('#review-contents').val());

        for(let image of images){
            formData.append("photoList", image);
        }

        console.log(formData)

        $.ajax({
            url : '/api/review',
            type : 'POST',
            data : formData,
            processData : false,
            contentType : false,
            success : function (response) {
                alert("리뷰를 등록하였습니다.")
                location.reload();
            },
            error : function (err) {
                alert("리뷰 등록에 실패했습니다.")
            }
        })
    }

    function setPreview(){
        let files = fileInput.files;
        if(files.length + images.length > 4){
            files.length = 0;
            alert("사진은 4장까지 첨부할 수 있습니다.")
        }else {
            if(files.length > 0 && images.length === 0) {
                $('.swiper-wrapper').html("");
            }
            if(files.length > 0){
                for (let i = 0; i < files.length; i++) {
                    let file = files[i];
                    images.push(file);

                    let reader = new FileReader();

                    const tempHtml = `<div class="swiper-slide">` +
                        `<button class="delete-img-btn btn btn-dark rounded-pill opacity-50">` +
                        `<i class="bi bi-x-lg"></i>` +
                        `</button>` +
                        `<img class="preview-img" style="object-fit: contain" onload="goLastSlide()"/>` +
                        `</div>`;
                    editSwiper.appendSlide(tempHtml);
                    editSwiper.update();

                    reader.onload = function(data) {
                        const swiperSlides = $('.editSwiper .swiper-wrapper .swiper-slide');
                        const targetSlide = $(swiperSlides[images.length - files.length + i]);
                        targetSlide.find('.preview-img').attr('src', data.target.result);
                    };

                    reader.readAsDataURL(file);
                }
            }
            if(images.length > 1){
                $('.editSwiper .swiper-controller').show()
            }else {
                $('.editSwiper .swiper-controller').hide()
            }
            if(images.length >= 4){
                $('.uploader').hide()
            }
        }
        setTimeout(function (){
            $('#img-uploader').val('');
        },500)
    }

    function goLastSlide() {
        editSwiper.slideTo(images.length-1,300,false);
    }

    function deleteImg() {
        $(document).on('click','.delete-img-btn',function () {
            let idx = $(".delete-img-btn").index(this);
            editSwiper.slideTo(idx-1,300,false);
            editSwiper.removeSlide(idx);
            editSwiper.update();
            images.splice(idx,1);

            if(images.length > 1){
                $('.editSwiper .swiper-controller').show()
            }else {
                $('.editSwiper .swiper-controller').hide()
            };

            if(images.length === 0){
                const tempHtml = `<div class="swiper-slide">` +
                    `사진을 추가해주세요.` +
                    `</div>`;
                editSwiper.appendSlide(tempHtml);
                editSwiper.update();
            }
            if($('.uploader').css('display') === 'none' && images.length < 4){
                $('.uploader').show()
            }
        })
    }
</script>

<!-- 마이페이지 무한스크롤 관련 스크립트 -->
<script th:inline="javascript">
    let scrollPage = 0; // 무한스크롤로 불러올 페이지
    let scrollCheck = false; // 페이지 데이터를 불러오는 중인지 여부
    let firstLoad = true; // 첫 로딩인지 체크
    let gallery = $('.gallery');
    let tabType = "REVIEW"; // 화면에 보여줄 탭
    let back = false;
    $(document).ready(function (){
        /*무한스크롤 & 페이지 로드 설정*/
        gallery.html("")
        observer.observe(document.getElementById('load-point'));
        $('#load-point').hide(); // 옵저버 관측 타이밍을 컨트롤하기 위해 hide
        loadPage();
        /* 리뷰 상세 조회 관련 설정 */
        $('.swiper-controller').hide();
        /* 새 글 작성 버튼 관련 설정 */
        $('.create-btn').hide();
        if([[${findUser.id == loginUser.id}]]){
            $('#new-review-btn').show()
        }
        /* 리뷰 작성 관련 설정 */
        selectBook();
        deleteImg();
        checkInputLength();
        /*리뷰 북 작성 관련 설정*/
        changeBookTitle();
        checkBookContents();

    })

    const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            // entry가 intersecting 중이 아니라면 함수를 실행하지 않음.
            if (!entry.isIntersecting) return;
            // 현재 페이지가 불러오는 중이면 함수를 실행하지 않음.
            if (scrollCheck) return;
            //옵저버 타겟 설정
            observer.observe(document.getElementById('load-point'));
            // 페이지를 불러오는 함수 호출.
            switch (tabType){
                case "REVIEW" :
                    showReview();
                    break;
                case "REVIEWBOOK" :
                    showReviewBook();
                    break;
                case "BOOKMARK" :
                    showBookmark();
                    break;
                case "LIKE" :
                    showLike();
                    break;
            }
        });
    });

    // 탭을 이동시 마다 변수 및 기존 화면 초기화(탭 이동시 마다 실행 해주세요.)
    function changeTab(type) {
        observer.disconnect()
        tabType = type;
        scrollPage = 0;
        scrollCheck = false;
        firstLoad = true;
        back = false;
        if(tabType === 'REVIEWBOOK'){
            gallery.css('justify-content','center');
        }else {
            gallery.css('justify-content','flex-start');
        }
        if([[${findUser.id == loginUser.id}]]){
            $('.create-btn').hide();
            switch (tabType){
                case 'REVIEW':
                    $('#new-review-btn').show();
                    break;
                case 'REVIEWBOOK':
                    $('#new-book-btn').show();
                    break;
            }
        }
        gallery.html("")
        // 옵저버 타겟 관측 시작
        observer.observe(document.getElementById('load-point'));
    }



    function showBookmark() {
        let time = 300;  // 페이지 로딩 시 로더를 일정시간 이상 보여주기 위한 시간 지정
        let loadScroll; // 다음 페이지 로딩 후에도 유지할 스크롤 위치를 저장할 변수
        if(!firstLoad){
            scrollPage += 1;
        }
        if(firstLoad || back) {
            time = 0;
            back = false;
        }
        $.ajax({
            url : '/api/mypage/bookmarks',
            type : 'GET',
            data : {
                userId : [[${findUser.id}]],
                page : scrollPage
            },
            async: false,
            success : function (response) {
                let bookmarkList = response.pageResponse.dtoList;

                if(firstLoad && bookmarkList.length <= 0){
                    firstLoad = false;
                    $(".loader").hide()
                    let messageHtml = '<div class="no-data-msg mt-5">' +
                                    '<h4>등록된 북마크가 없습니다.</h4>' +
                                    '</div>';
                    gallery.append(messageHtml);
                }else {
                    firstLoad = false;
                    // 로더를 일정시간 이상 노출하기 위한 setTimeout
                    setTimeout(() => {
                        $(".loader").hide()
                        $.each(bookmarkList, function (index, bookmark){
                            let tempHtml = `<div class="gallery-item" tabIndex="0" onclick="savePage()">` +
                                `<a href="/info/content/${bookmark.contentid}">` +
                                `<img src="${bookmark.firstimage}"` +
                                `class="gallery-image" alt="">` +
                                `<div class="gallery-item-info d-flex">` +
                                `<div class="bookmark-info-wrap">` +
                                `<div class="bookmark-category">${bookmark.fullCategoryName}</div>` +
                                `<div class="bookmark-title"><strong>${bookmark.title}</strong></div>` +
                                `<div class="bookmark-address">${bookmark.address}</div>` +
                                `</div>` +
                                `</div>` +
                                `</a>` +
                                `</div>`
                            gallery.append(tempHtml).trigger("create")
                        })
                        window.scrollTo({top: loadScroll, behavior: "instant"});
                    }, time)
                    if(bookmarkList.length < 12){
                        // 다음페이지가 없다면 관측을 종료
                        observer.unobserve(document.getElementById('load-point'));
                    }
                }
            },
            error : function (err) {
                console.log(err)
            },
            beforeSend : function () {
                scrollCheck = true;
                $(".loader").show()
                loadScroll = window.scrollY;
            },
            complete : function () {
                scrollCheck = false;
            }
        })
    }

    function checkInputLength(){
        $("#new-book-title").on("propertychange change paste input", function() {
            let title = $(this).val();
            if(title.length > 20) {
                title = title.substring(0, 20);
                $("#new-book-title").val(title);
                alert("제목은 20자까지 입력할 수 있습니다.");
            }
        });

        $("#selected-touritem-name").on("propertychange change paste input", function() {
            let name = $(this).val();
            if(name.length > 30) {
                name = name.substring(0, 30);
                $("#selected-touritem-name").val(name);
                alert("관광지 이름은 30자까지 입력할 수 있습니다.");
            }
        });

        $("#review-contents").on("propertychange change paste input", function() {
            let text = $(this).val();
            if(text.length > 2000) {
                text = text.substring(0, 2000);
                $("#review-contents").val(text);
                alert("리뷰 본문은 2000자까지 입력할 수 있습니다.");
            }
        });

        $("#comment-content").on("propertychange change paste input", function() {
            let comment = $(this).text();
            // comment = comment.replace(/<div>/g,'');
            // comment = comment.replace(/<\/div>/g,'');
            if(comment.length > 2000) {
                comment = comment.substring(0, 2000);
                $("#comment-content").val(comment);
                alert("댓글은 2000자까지 입력할 수 있습니다.");
            }
        });

        $("#edit-comment-content").on("propertychange change paste input", function() {
            let comment = $(this).text();
            // comment = comment.replace(/<div>/g,'');
            // comment = comment.replace(/<\/div>/g,'');
            if(comment.length > 2000) {
                comment = comment.substring(0, 2000);
                $("#edit-comment-content").val(comment);
                alert("댓글은 2000자까지 입력할 수 있습니다.");
            }
        });
    }

    function showReview() {
        let time = 300;  // 페이지 로딩 시 로더를 일정시간 이상 보여주기 위한 시간 지정
        let loadScroll; // 다음 페이지 로딩 후에도 유지할 스크롤 위치를 저장할 변수
        if(!firstLoad){
            scrollPage += 1;
        }
        if(firstLoad || back) {
            time = 0;
            back = false;
        }
        $.ajax({
            url : '/api/mypage/reviews',
            type : 'GET',
            data : {
                userId : [[${findUser.id}]],
                page : scrollPage
            },
            async: false,
            success : function (response) {
                let reviewList = response.pageResponse.dtoList;
                // 로더를 일정시간 이상 노출하기 위한 setTimeout

                if(firstLoad && reviewList.length <= 0){
                    firstLoad = false;
                    $(".loader").hide()
                    let messageHtml = '<div class="no-data-msg mt-5">' +
                        '<h4>등록된 리뷰가 없습니다.</h4>' +
                        '</div>';
                    gallery.append(messageHtml);
                }else {
                    firstLoad = false;
                    setTimeout(() => {
                        $(".loader").hide()
                        $.each(reviewList, function (index, review){
                            let tempHtml = `<div class="gallery-item" tabIndex="0" onclick="openViewer(${review.reviewId})">`
                            if(review.photoCount > 1){
                                tempHtml += '<div class="gallery-item-type">' +
                                    '<i class="fas fa-clone" aria-hidden="true"></i>' +
                                    '</div>'
                            }
                            tempHtml +=
                                `<img src="/api/image/review/${review.firstPhoto.filePath}" class="gallery-image" alt="">` +
                                `<div class="gallery-item-info">` +
                                `<ul>` +
                                `<li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> ${review.likeCount}</li>` +
                                `<li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> ${review.commentCount}</li>` +
                                `</ul>` +
                                `</div>` +
                                `</div>` +
                                `</div>`;
                            gallery.append(tempHtml).trigger("create")
                        })
                        window.scrollTo({top: loadScroll, behavior: "instant"});
                    }, time)
                    if(reviewList.length < 12){
                        // 다음페이지가 없다면 관측을 종료
                        observer.unobserve(document.getElementById('load-point'));
                    }
                }
            },
            error : function (err) {
                console.log(err)
            },
            beforeSend : function () {
                scrollCheck = true;
                $(".loader").show()
                loadScroll = window.scrollY;
            },
            complete : function () {
                scrollCheck = false;
            }
        })
    }

    function showReviewBook(){
        let time = 300;  // 페이지 로딩 시 로더를 일정시간 이상 보여주기 위한 시간 지정
        let loadScroll; // 다음 페이지 로딩 후에도 유지할 스크롤 위치를 저장할 변수
        if(!firstLoad){
            scrollPage += 1;
        }
        if(firstLoad || back) {
            time = 0;
            back = false;
        }
        $.ajax({
            url : '/api/mypage/reviewbooks',
            type : 'GET',
            data : {
                userId : [[${findUser.id}]],
                page : scrollPage
            },
            async: false,
            success : function (response) {
                let reviewBookList = response.pageResponse.dtoList;
                // 로더를 일정시간 이상 노출하기 위한 setTimeout

                if(firstLoad && reviewBookList.length <= 0){
                    firstLoad = false;
                    $(".loader").hide()
                    let messageHtml = '<div class="no-data-msg mt-5">' +
                        '<h4>등록된 리뷰북이 없습니다.</h4>' +
                        '</div>';
                    gallery.append(messageHtml);
                }else {
                    firstLoad = false;
                    setTimeout(() => {
                        $(".loader").hide()
                        $.each(reviewBookList, function (index, reviewBook){
                            let coverPath = reviewBook.coverFilePath == null ? '../assets/img/review_book_cover.jpg' : `/api/image/book/${reviewBook.coverFilePath}`;
                            let tempHtml = `<div class="review-book-item" tabIndex="0">` +
                                        `<a href="/book?bookid=${reviewBook.bookId}">` +
                                        `<img src="${coverPath}"/>` +
                                        `<p>${reviewBook.bookTitle}</p>` +
                                        `</a>`
                                        '</div>';
                            gallery.append(tempHtml).trigger("create")
                        })
                        window.scrollTo({top: loadScroll, behavior: "instant"});
                    }, time)
                    if(reviewBookList.length < 12){
                        // 다음페이지가 없다면 관측을 종료
                        observer.unobserve(document.getElementById('load-point'));
                    }
                }
            },
            error : function (err) {
                console.log(err)
            },
            beforeSend : function () {
                scrollCheck = true;
                $(".loader").show()
                loadScroll = window.scrollY;
            },
            complete : function () {
                scrollCheck = false;
            }
        })
    }

    function showLike(){
        let time = 300;  // 페이지 로딩 시 로더를 일정시간 이상 보여주기 위한 시간 지정
        let loadScroll; // 다음 페이지 로딩 후에도 유지할 스크롤 위치를 저장할 변수
        if(!firstLoad){
            scrollPage += 1;
        }
        if(firstLoad || back) {
            time = 0;
            back = false;
        }
        $.ajax({
            url : '/api/mypage/likes',
            type : 'GET',
            data : {
                userId : [[${findUser.id}]],
                page : scrollPage
            },
            async: false,
            success : function (response) {
                let likeReviewList = response.pageResponse.dtoList;
                // 로더를 일정시간 이상 노출하기 위한 setTimeout

                if(firstLoad && likeReviewList.length <= 0){
                    firstLoad = false;
                    $(".loader").hide()
                    let messageHtml = '<div class="no-data-msg mt-5">' +
                        '<h4>등록된 관심 리뷰가 없습니다.</h4>' +
                        '</div>';
                    gallery.append(messageHtml);
                }else {
                    firstLoad = false;
                    setTimeout(() => {
                        $(".loader").hide()
                        $.each(likeReviewList, function (index, review){
                            let tempHtml = `<div class="gallery-item" tabIndex="0" onclick="openViewer(${review.reviewId})">`
                            if(review.photoCount > 1){
                                tempHtml += '<div class="gallery-item-type">' +
                                    '<i class="fas fa-clone" aria-hidden="true"></i>' +
                                    '</div>'
                            }
                            tempHtml +=
                                `<img src="/api/image/review/${review.firstPhoto.filePath}" class="gallery-image" alt="">` +
                                `<div class="gallery-item-info">` +
                                `<ul>` +
                                `<li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> ${review.likeCount}</li>` +
                                `<li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> ${review.commentCount}</li>` +
                                `</ul>` +
                                `</div>` +
                                `</div>` +
                                `</div>`;
                            gallery.append(tempHtml).trigger("create")
                        })
                        window.scrollTo({top: loadScroll, behavior: "instant"});
                    }, time)
                    if(reviewBookList.length < 12){
                        // 다음페이지가 없다면 관측을 종료
                        observer.unobserve(document.getElementById('load-point'));
                    }
                }
            },
            error : function (err) {
                console.log(err)
            },
            beforeSend : function () {
                scrollCheck = true;
                $(".loader").show()
                loadScroll = window.scrollY;
            },
            complete : function () {
                scrollCheck = false;
            }
        })
    }

    function savePage() {
        let myPageInfo = {};
        myPageInfo.tabType = tabType;
        myPageInfo.scrollPage = scrollPage;
        myPageInfo.scrollPosition = window.scrollY.toString();
        sessionStorage.setItem("myPageInfo", JSON.stringify(myPageInfo));
    }

    function setScrollByMyPageInfo(){
        let session_myPageInfo = JSON.parse(sessionStorage.getItem("myPageInfo"));
        let tabType = session_myPageInfo.tabType;
        let sessionPage = Number(session_myPageInfo.scrollPage);
        let scrollPosition = Number(session_myPageInfo.scrollPosition);
        changeTab(tabType)
        console.log(sessionPage);
        console.log(scrollPosition);
        for(let page = 0; page <= sessionPage; page++){
            back = true;

            switch (tabType){
                case "BOOKMARK":
                    showBookmark();
                    break;
                case "REVIEW":
                    showReview();
                    break;
                case "REVIEWBOOK":
                    showReviewBook();
                    break;
                case "LIKE":
                    showLike();
                    break;
                // 탭 메뉴의 타입을 추가하여 사용
            }
        }
        setTimeout(() => {
            var scrollBottom = $(document).height() - $(window).height() - $(window).scrollTop();
            if(scrollPosition > scrollBottom){
                window.scrollTo(0, scrollBottom);
            }else {
                window.scrollTo(0, scrollPosition);
            }
        }, 100);
        // sessionStorage.removeItem("myPageInfo");
        setTimeout(() => {
            $('#load-point').show();
        }, 550)
    }

    function loadPage() {
        window.addEventListener('pageshow', function (event) {
            if (event.persisted || (window.performance && window.performance.navigation.type == 2)) {
                if(sessionStorage.getItem("myPageInfo") != null){
                    // 다른페이지에서 뒤로가기로 돌아왔을 시 세션에 저장된 정보로 기존 위치로 이동
                    console.log("back")
                    setScrollByMyPageInfo();
                }else {
                    $('#load-point').show();
                }
            }else {
                // 그 외의 방법으로 페이지 접근 시 바로 타겟을 노출, 데이터 로딩
                if(sessionStorage.getItem("myPageInfo") != null){
                    sessionStorage.removeItem("myPageInfo");
                }
                $('#load-point').show();
            }
        });
    }


</script>


<script th:inline="javascript">
    // 팔로워 팔로잉 수 동적으로 업데이트 하기
    function updateFollowCounts() {
        let userId = [[${findUser.id}]];

        $.ajax({
            url: '/api/userFollowCounts/' + userId,
            type: 'GET',
            contentType: 'application/json; charset=UTF-8',
            success: function(response) {
                $('#followers .profile-stat-count').text(response.followerCount); // 팔로워 수 업데이트
                $('#following .profile-stat-count').text(response.followingCount); // 팔로잉 수 업데이트
            },
            error: function(xhr, status, error) {
                console.error('Failed to fetch follow counts:', error);
            }
        });
    }
    $(document).ready(function() {
        updateFollowCounts(); // 페이지 로드 시 업데이트
    });

    // 팔로워리스트 모달창 열기
    $('#followers').click(function() {
        let userId = [[${findUser.id}]];
        let loginId = [[${loginUser.id}]];

        if(loginId === "anonymousUser") {
            alert('로그인 후에 이용하실 수 있습니다.');
            return;
        }

        $.ajax({
            url: '/api/show/followerList/' + userId,
            type: 'GET',
            contentType: 'application/json; charset=UTF-8',
            success: function(response) {
                const modalBody = $('#followersModal .modal-body #follower-list');
                modalBody.empty();
                response.forEach(function(data) {
                    // 팔로우 상태에 따라 버튼 속성 설정
                    var buttonClass = data.followingState == 1 ? 'btn-secondary unfollow-btn' : 'btn-primary follow-btn';
                    var buttonText = data.followingState == 1 ? '언팔로우' : '팔로우';
                    var buttonDataId = data.toUser;

                    // 나를 팔로우하고있는지에 따라 띄울 메세지
                    var isFollowedText = data.followedState == 1 ? '나를 팔로우 중입니다' : '';

                    // 로그인한 유저와 같은 경우 버튼을 추가하지 않음
                    if (data.sameUserState === 0) {
                        var buttonHTML = `<button class="btn ${buttonClass}" data-user-id="${buttonDataId}">${buttonText}</button>`;
                    } else {
                        var buttonHTML = ''; // 로그인한 유저와 같은 경우 버튼을 생성하지 않음
                    }


                    var template = `
                                    <div class="list-group">
                                        <div class="list-group-item d-flex flex-wrap">
                                            <div class="col d-flex">
                                                <a href="/mypage/${data.toUser}">
                                                    <img src="${data.listSfile}" class="profile-list-img rounded-circle me-2 align-self-center" alt="프로필 이미지">
                                                </a>
                                                <a href="/mypage/${data.toUser}">
                                                    <div class="d-flex flex-column flex-start gap-2">
                                                        <strong>${data.toUser}</strong>
                                                        <span>${data.listName}</span>
                                                    </div>
                                                </a>
                                            </div>
                                            <div class="col-md-auto pe-3 align-self-center">
                                                ${isFollowedText}
                                            </div>
                                            <div class="follow-state d-flex col col-lg-2">
                                                ${buttonHTML}
                                            </div>
                                        </div>
                                    </div>
                                    `;

                    modalBody.append(template);
                });
                $('#followersModal').modal('show');
            }
        });
    });

    // 팔로잉 리스트 모달창 열기
    $('#following').click(function() {
        let userId = [[${findUser.id}]];
        let loginId = [[${loginUser.id}]];

        if(loginId === "anonymousUser") {
            alert('로그인 후에 이용하실 수 있습니다.');
            return;
        }

        $.ajax({
            url: '/api/show/followingList/' + userId,
            type: 'GET',
            contentType: 'application/json; charset=UTF-8',
            success: function(response) {
                const modalBody = $('#followingModal .modal-body #following-list');
                modalBody.empty();
                response.forEach(function(data) {
                    // 팔로우 상태에 따라 버튼 속성 설정
                    var buttonClass = data.followingState == 1 ? 'btn-secondary unfollow-btn' : 'btn-primary follow-btn';
                    var buttonText = data.followingState == 1 ? '언팔로우' : '팔로우';
                    var buttonDataId = data.fromUser;

                    // 나를 팔로우하고있는지에 따라 띄울 메세지
                    var isFollowedText = data.followedState == 1 ? '나를 팔로우 중입니다' : '';

                    // 로그인한 유저와 같은 경우 버튼을 추가하지 않음
                    if (data.sameUserState === 0) {
                        var buttonHTML = `<button class="btn ${buttonClass}" data-user-id="${buttonDataId}">${buttonText}</button>`;
                    } else {
                        var buttonHTML = ''; // 로그인한 유저와 같은 경우 버튼을 생성하지 않음
                    }

                    var template = `
                        <div class="list-group">
                            <div class="list-group-item d-flex flex-wrap">
                                <div class="col d-flex">
                                    <a href="/mypage/${data.toUser}">
                                        <img src="${data.listSfile}" class="profile-list-img rounded-circle me-2 align-self-center">
                                    </a>
                                    <a href="/mypage/${data.fromUser}">
                                        <div class="d-flex flex-column flex-start gap-2">
                                            <strong>${data.fromUser}</strong>
                                            <span>${data.listName}</span>
                                        </div>
                                    </a>
                                </div>
                                <div class="col-md-auto pe-3 align-self-center">
                                    ${isFollowedText}
                                </div>
                                <div class="follow-state d-flex col col-lg-2">
                                    ${buttonHTML}
                                </div>
                            </div>
                        </div>
                `;
                    modalBody.append(template);
                });
                $('#followingModal').modal('show');
            }
        });
    });

    // 팔로우 기능
    $(document).on('click', '.follow-btn', function (){
        const userId = this.getAttribute('data-user-id');
        let loginId = [[${loginUser.id}]];

        if(loginId === "anonymousUser") {
            alert('로그인 후에 이용하실 수 있습니다.');
            return;
        }
        var $button = $(this);
        $.ajax({
            url: '/api/follow/' + userId,
            type: 'POST',
            contentType : 'application/json; charset=UTF-8',
            success: function(response) {
                alert(userId + '님을 팔로우했습니다.');
                $button.removeClass('btn-primary')
                    .addClass('btn-secondary')
                    .addClass('unfollow-btn')
                    .html('언팔로우')
                    .removeClass('follow-btn');
                updateFollowCounts();
            },
            error: function (xhr, status, error) {
                alert('팔로우에 실패했습니다.');
            }
        })
    });


    // 언팔로우 기능
    $(document).on('click', '.unfollow-btn', function () {
        const userId = this.getAttribute('data-user-id');
        var $button = $(this);
        $.ajax({
            url: '/api/unfollow/' + userId,
            type: 'DELETE',
            contentType : 'application/json; charset=UTF-8',
            success: function(response) {
                alert(userId + '님을 언팔로우했습니다.');
                $button.removeClass('btn-secondary')
                    .addClass('btn-primary')
                    .addClass('follow-btn')
                    .html('팔로우')
                    .removeClass('unfollow-btn');
                updateFollowCounts();
            },
            error: function (xhr, status, error) {
                alert('언팔로우에 실패했습니다.');
            }
        })
    });

</script>

</body>
</html>