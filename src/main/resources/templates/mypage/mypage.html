<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!--jquery-->
    <script	src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Bootstrap icons-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
          type="text/css"/>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Noto+Sans+KR:wght@100;200;300;400;500;600;700;800;900&display=swap"
          rel="stylesheet">
    <!-- Core theme CSS (includes Bootstrap)-->

    <link href="../assets/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="../assets/css/style.css?after" rel="stylesheet"/>
    <link href="../assets/css/commonstyle.css?after" rel="stylesheet"/>
    <!--  my page 적용 템플릿 스타일 시트  -->
    <link href="../assets/css/mypagestyle.css" rel="stylesheet"/>

    <title>Three Go</title>
</head>
<body>
<style>
</style>
<div class="d-flex flex-nowrap">
    <th:block th:replace="~{fragments/sidebar}"></th:block>
    <div class="container">
        <div class="profile">
            <div class="profile-image">
                <img src="https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces" alt="">
            </div>

            <div class="profile-user-settings">
                <h1 class="profile-user-name" th:text="${findUser.name}"></h1>
                <th:block th:if="${findUser.id == loginUserId}">
                    <button class="btn profile-edit-btn" onclick="location.href = '/editprofile'" >Edit Profile</button>
                    <button class="btn profile-settings-btn" aria-label="profile settings"><i class="fas fa-cog" aria-hidden="true"></i></button>
                </th:block>
            </div>

            <div class="profile-stats">
                <ul>
                    <li><span class="profile-stat-count">164</span> posts</li>
                    <li><span class="profile-stat-count">188</span> followers</li>
                    <li><span class="profile-stat-count">206</span> following</li>
                </ul>
            </div>

            <div class="profile-bio">
                <div class="profile-real-name" th:text="${findUser.id}"></div>
                <div th:text="${findUser.about}"></div>
            </div>
        </div>
        <!-- End of profile section -->
        <ul class="nav nav-underline mb-3 justify-content-center">
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" onclick="changeTab('review')">내 리뷰</a>
            </li>
            <li class="nav-item">
                <a class="nav-link">내 리뷰북</a>
            </li>
            <li class="nav-item">
                <a class="nav-link">관심 리뷰</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="changeTab('bookmark')">북마크</a>
            </li>
        </ul>

        <div class="gallery">
            <div class="gallery-item" tabindex="0">
                <img src="https://images.unsplash.com/photo-1511765224389-37f0e77cf0eb?w=500&h=500&fit=crop" class="gallery-image" alt="">
                <div class="gallery-item-info">
                    <div class="bookmark-info-wrap">
                        <div class="bookmark-category">북마크 관광지 카테고리</div>
                        <div class="bookmark-title">북마크 관광지 제목</div>
                        <div class="bookmark-address">북마크 관광지 주소</div>
                    </div>
                </div>
            </div>
            <div class="gallery-item" tabindex="0">
                <img src="https://images.unsplash.com/photo-1511765224389-37f0e77cf0eb?w=500&h=500&fit=crop" class="gallery-image" alt="">
                <div class="gallery-item-info">
                    <ul>
                        <li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> 56</li>
                        <li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> 2</li>
                    </ul>
                </div>
            </div>
            <div class="gallery-item" tabindex="0">
                <img src="https://images.unsplash.com/photo-1511765224389-37f0e77cf0eb?w=500&h=500&fit=crop" class="gallery-image" alt="">
                <div class="gallery-item-info">
                    <ul>
                        <li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> 56</li>
                        <li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> 2</li>
                    </ul>
                </div>
            </div>
            <div class="gallery-item" tabindex="0">
                <img src="https://images.unsplash.com/photo-1511765224389-37f0e77cf0eb?w=500&h=500&fit=crop" class="gallery-image" alt="">
                <div class="gallery-item-info">
                    <ul>
                        <li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> 56</li>
                        <li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> 2</li>
                    </ul>
                </div>
            </div>

<!--            <div class="gallery-item" tabindex="0">-->
<!--                <img src="https://images.unsplash.com/photo-1511765224389-37f0e77cf0eb?w=500&h=500&fit=crop" class="gallery-image" alt="">-->
<!--                <div class="gallery-item-info">-->
<!--                    <ul>-->
<!--                        <li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> 56</li>-->
<!--                        <li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> 2</li>-->
<!--                    </ul>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="gallery-item" tabindex="0">-->
<!--                <img src="https://images.unsplash.com/photo-1497445462247-4330a224fdb1?w=500&h=500&fit=crop" class="gallery-image" alt="">-->
<!--                <div class="gallery-item-info">-->
<!--                    <ul>-->
<!--                        <li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> 89</li>-->
<!--                        <li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> 5</li>-->
<!--                    </ul>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="gallery-item" tabindex="0">-->
<!--                <img src="https://images.unsplash.com/photo-1426604966848-d7adac402bff?w=500&h=500&fit=crop" class="gallery-image" alt="">-->
<!--                <div class="gallery-item-type">-->
<!--                    <span class="visually-hidden">Gallery</span><i class="fas fa-clone" aria-hidden="true"></i>-->
<!--                </div>-->

<!--                <div class="gallery-item-info">-->
<!--                    <ul>-->
<!--                        <li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> 42</li>-->
<!--                        <li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> 1</li>-->
<!--                    </ul>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="gallery-item" tabindex="0">-->
<!--                <img src="https://images.unsplash.com/photo-1502630859934-b3b41d18206c?w=500&h=500&fit=crop" class="gallery-image" alt="">-->
<!--                <div class="gallery-item-type">-->
<!--                    <span class="visually-hidden">Video</span><i class="fas fa-video" aria-hidden="true"></i>-->
<!--                </div>-->

<!--                <div class="gallery-item-info">-->
<!--                    <ul>-->
<!--                        <li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> 38</li>-->
<!--                        <li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> 0</li>-->
<!--                    </ul>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="gallery-item" tabindex="0">-->
<!--                <img src="https://images.unsplash.com/photo-1498471731312-b6d2b8280c61?w=500&h=500&fit=crop" class="gallery-image" alt="">-->

<!--                <div class="gallery-item-type">-->
<!--                    <span class="visually-hidden">Gallery</span><i class="fas fa-clone" aria-hidden="true"></i>-->
<!--                </div>-->

<!--                <div class="gallery-item-info">-->
<!--                    <ul>-->
<!--                        <li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> 47</li>-->
<!--                        <li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> 1</li>-->
<!--                    </ul>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="gallery-item" tabindex="0">-->
<!--                <img src="https://images.unsplash.com/photo-1515023115689-589c33041d3c?w=500&h=500&fit=crop" class="gallery-image" alt="">-->

<!--                <div class="gallery-item-info">-->
<!--                    <ul>-->
<!--                        <li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> 94</li>-->
<!--                        <li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> 3</li>-->
<!--                    </ul>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="gallery-item" tabindex="0">-->
<!--                <img src="https://images.unsplash.com/photo-1504214208698-ea1916a2195a?w=500&h=500&fit=crop" class="gallery-image" alt="">-->

<!--                <div class="gallery-item-type">-->
<!--                    <span class="visually-hidden">Gallery</span><i class="fas fa-clone" aria-hidden="true"></i>-->
<!--                </div>-->

<!--                <div class="gallery-item-info">-->
<!--                    <ul>-->
<!--                        <li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> 52</li>-->
<!--                        <li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> 4</li>-->
<!--                    </ul>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="gallery-item" tabindex="0">-->
<!--                <img src="https://images.unsplash.com/photo-1515814472071-4d632dbc5d4a?w=500&h=500&fit=crop" class="gallery-image" alt="">-->

<!--                <div class="gallery-item-info">-->
<!--                    <ul>-->
<!--                        <li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> 66</li>-->
<!--                        <li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> 2</li>-->
<!--                    </ul>-->
<!--                </div>-->

<!--            </div>-->

<!--            <div class="gallery-item" tabindex="0">-->
<!--                <img src="https://images.unsplash.com/photo-1511407397940-d57f68e81203?w=500&h=500&fit=crop" class="gallery-image" alt="">-->

<!--                <div class="gallery-item-type">-->
<!--                    <span class="visually-hidden">Gallery</span><i class="fas fa-clone" aria-hidden="true"></i>-->
<!--                </div>-->

<!--                <div class="gallery-item-info">-->
<!--                    <ul>-->
<!--                        <li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> 45</li>-->
<!--                        <li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> 0</li>-->
<!--                    </ul>-->
<!--                </div>-->

<!--            </div>-->

<!--            <div class="gallery-item" tabindex="0">-->
<!--                <img src="https://images.unsplash.com/photo-1518481612222-68bbe828ecd1?w=500&h=500&fit=crop" class="gallery-image" alt="">-->

<!--                <div class="gallery-item-info">-->
<!--                    <ul>-->
<!--                        <li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> 34</li>-->
<!--                        <li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> 1</li>-->
<!--                    </ul>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="gallery-item" tabindex="0">-->
<!--                <img src="https://images.unsplash.com/photo-1505058707965-09a4469a87e4?w=500&h=500&fit=crop" class="gallery-image" alt="">-->

<!--                <div class="gallery-item-info">-->
<!--                    <ul>-->
<!--                        <li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> 41</li>-->
<!--                        <li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> 0</li>-->
<!--                    </ul>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="gallery-item" tabindex="0">-->
<!--                <img src="https://images.unsplash.com/photo-1423012373122-fff0a5d28cc9?w=500&h=500&fit=crop" class="gallery-image" alt="">-->

<!--                <div class="gallery-item-type">-->
<!--                    <span class="visually-hidden">Video</span><i class="fas fa-video" aria-hidden="true"></i>-->
<!--                </div>-->

<!--                <div class="gallery-item-info">-->
<!--                    <ul>-->
<!--                        <li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> 30</li>-->
<!--                        <li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> 2</li>-->
<!--                    </ul>-->
<!--                </div>-->
<!--            </div>-->

        </div>
        <!-- End of gallery -->

        <div id="load-point"></div>
        <div class="loader"></div>
    </div>
    <!-- End of container -->
</div>

<script th:inline="javascript">
    let scrollPage = 0; // 무한스크롤로 불러올 페이지
    let scrollCheck = false; // 페이지 데이터를 불러오는 중인지 여부
    let firstLoad = true; // 첫 로딩인지 체크
    let gallery = $('.gallery');
    let tabType = "bookmark"; // 화면에 보여줄 탭
    let back = false;
    $(document).ready(function (){
        gallery.html("")
        observer.observe(document.getElementById('load-point'));
        $('#load-point').hide(); // 옵저버 관측 타이밍을 컨트롤하기 위해 hide
        loadPage();
    })

    const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            // entry가 intersecting 중이 아니라면 함수를 실행하지 않음.
            if (!entry.isIntersecting) return;
            // 현재 페이지가 불러오는 중이면 함수를 실행하지 않음.
            if (scrollCheck) return;
            //옵저버 타겟 설정
            observer.observe(document.getElementById('load-point'));
            // 페이지를 불러오는 함수 호출.
            switch (tabType){
                case "bookmark" :
                    showBookmark();
                    break;
                case "review" :
                    showReview();
                    break
            }
        });
    });

    // 탭을 이동시 마다 변수 및 기존 화면 초기화(탭 이동시 마다 실행 해주세요.)
    function changeTab(type) {
        observer.disconnect()
        tabType = type;
        scrollPage = 0;
        scrollCheck = false;
        firstLoad = true;
        back = false;
        gallery.html("")
        // 옵저버 타겟 관측 시작
        observer.observe(document.getElementById('load-point'));
    }



    function showBookmark() {
        let time = 500;  // 페이지 로딩 시 로더를 일정시간 이상 보여주기 위한 시간 지정
        let loadScroll; // 다음 페이지 로딩 후에도 유지할 스크롤 위치를 저장할 변수
        if(firstLoad){
            firstLoad = false;
        }else {
            scrollPage += 1;
        }
        if(firstLoad || back) {
            time = 0;
            back = false;
        }
        $.ajax({
            url : '/api/bookmark',
            type : 'POST',
            contentType : 'application/json; charset=UTF-8',
            data : JSON.stringify({
                userId : [[${findUser.id}]],
                page : scrollPage
            }),
            async: false,
            success : function (response) {
                let bookmarkList = response.pageResponse.dtoList;
                console.log(scrollPage)
                // 로더를 일정시간 이상 노출하기 위한 setTimeout
                setTimeout(() => {
                    $(".loader").hide()
                    $.each(bookmarkList, function (index, bookmark){
                        let tempHtml = `<div class="gallery-item" tabIndex="0" onclick="savePage()">` +
                            `<a href="/info/content/${bookmark.contentid}">` +
                            `<img src="${bookmark.firstimage}"` +
                            `class="gallery-image" alt="">` +
                            `<div class="gallery-item-info">` +
                            `<div class="bookmark-info-wrap">` +
                            `<div class="bookmark-category">${bookmark.fullCategoryName}</div>` +
                            `<div class="bookmark-title">${bookmark.title}</div>` +
                            `<div class="bookmark-address">${bookmark.address}</div>` +
                            `</div>` +
                            `</div>` +
                            `</a>` +
                            `</div>`
                        gallery.append(tempHtml).trigger("create")
                    })
                    window.scrollTo({top: loadScroll, behavior: "instant"});
                }, time)
                if(bookmarkList.length < 12){
                    // 다음페이지가 없다면 관측을 종료
                    observer.unobserve(document.getElementById('load-point'));
                }
            },
            error : function (err) {
                console.log(err)
            },
            beforeSend : function () {
                scrollCheck = true;
                $(".loader").show()
                loadScroll = window.scrollY;
            },
            complete : function () {
                scrollCheck = false;
            }
        })
    }

    function showReview() {
        let time = 500;  // 페이지 로딩 시 로더를 일정시간 이상 보여주기 위한 시간 지정
        let loadScroll; // 다음 페이지 로딩 후에도 유지할 스크롤 위치를 저장할 변수
        if(firstLoad){
            firstLoad = false;
        }else {
            scrollPage += 1;
        }
        if(firstLoad || back) {
            time = 0;
            back = false;
        }
        $.ajax({
            url : '/api/review',
            type : 'POST',
            contentType : 'application/json; charset=UTF-8',
            data : JSON.stringify({
                userId : [[${findUser.id}]],
                page : scrollPage
            }),
            async: false,
            success : function (response) {
                let reviewList = response.pageResponse.dtoList;
                console.log(scrollPage)
                // 로더를 일정시간 이상 노출하기 위한 setTimeout
                setTimeout(() => {
                    $(".loader").hide()
                    $.each(reviewList, function (index, review){
                        console.log(review)
                        let tempHtml = `<div class="gallery-item" tabIndex="0" onclick="savePage()">` +
                            `<a href="#">` +
                            `<img src="${review.reviewPhotoList[0].filePath}"` +
                            `class="gallery-image" alt="">` +
                            `<div class="gallery-item-info">` +
                            // `<div class="bookmark-info-wrap">` +
                            // `<div class="bookmark-category">${review.fullCategoryName}</div>` +
                            // `<div class="bookmark-title">${review.title}</div>` +
                            // `<div class="bookmark-address">${review.address}</div>` +
                            `</div>` +
                            `</div>` +
                            `</a>` +
                            `</div>`
                        gallery.append(tempHtml).trigger("create")
                    })
                    window.scrollTo({top: loadScroll, behavior: "instant"});
                }, time)
                if(reviewList.length < 12){
                    // 다음페이지가 없다면 관측을 종료
                    observer.unobserve(document.getElementById('load-point'));
                }
            },
            error : function (err) {
                console.log(err)
            },
            beforeSend : function () {
                scrollCheck = true;
                $(".loader").show()
                loadScroll = window.scrollY;
            },
            complete : function () {
                scrollCheck = false;
            }
        })
    }

    function savePage() {
        let myPageInfo = {};
        myPageInfo.tabType = tabType;
        myPageInfo.scrollPage = scrollPage;
        myPageInfo.scrollPosition = window.scrollY.toString();
        sessionStorage.setItem("myPageInfo", JSON.stringify(myPageInfo));
        observer.disconnect();
    }

    function loadPage() {
        window.addEventListener('pageshow', function (event) {
            if (event.persisted || (window.performance && window.performance.navigation.type == 2)) {
                if(sessionStorage.getItem("myPageInfo") != null){
                    // 다른페이지에서 뒤로가기로 돌아왔을 시 세션에 저장된 정보로 기존 위치로 이동
                    console.log("back")
                    let session_myPageInfo = JSON.parse(sessionStorage.getItem("myPageInfo"));
                    let tabType = session_myPageInfo.tabType;
                    let sessionPage = Number(session_myPageInfo.scrollPage);
                    let scrollPosition = Number(session_myPageInfo.scrollPosition);
                    changeTab(tabType)
                    console.log(sessionPage);
                    console.log(scrollPosition);
                    for(let page = 0; page <= sessionPage; page++){
                        back = true;
                        console.log(`${scrollPage}, ${page}`);
                        switch (tabType){
                            case "bookmark":
                                showBookmark();
                                break;
                            case "review":
                                showReview();
                                break;
                            // 탭 메뉴의 타입을 추가하여 사용
                        }
                    }
                    setTimeout(() => {
                        window.scrollTo(0, scrollPosition);
                    }, 10);
                    // sessionStorage.removeItem("myPageInfo");
                    setTimeout(() => {
                        $('#load-point').show();
                    }, 550)
                }else {
                    $('#load-point').show();
                }
            }else {
                // 그 외의 방법으로 페이지 접근 시 바로 타겟을 노출, 데이터 로딩
                if(sessionStorage.getItem("myPageInfo") != null){
                    sessionStorage.removeItem("myPageInfo");
                }
                $('#load-point').show();
            }
        });
    }

</script>

</body>
</html>