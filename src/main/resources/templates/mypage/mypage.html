<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!--jquery-->
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <!-- Font Awesome icons (free version)-->
<!--    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <!-- Bootstrap icons-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
          type="text/css"/>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Noto+Sans+KR:wght@100;200;300;400;500;600;700;800;900&display=swap"
          rel="stylesheet">
    <!-- Core theme CSS (includes Bootstrap)-->

    <link href="../assets/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="../assets/css/style.css?after" rel="stylesheet"/>
    <link href="../assets/css/commonstyle.css?after" rel="stylesheet"/>
    <!--  my page 적용 템플릿 스타일 시트  -->
    <link href="../assets/css/mypagestyle.css" rel="stylesheet"/>

    <!--swiper-->
    <link href="../assets/swiper/swiper-bundle.min.css" rel="stylesheet" />
    <script src="../assets/swiper/swiper-bundle.min.js"></script>

    <title>Three Go</title>
</head>
<body>
<style>
    .container-fluid {
        height: 100%;
        /*overflow: hidden;*/
    }

    .container-fluid .row {
        height: 100%;
    }

    .btn-close {
        position: absolute;
        top: 5%;
        right: 5%;
    }

    .preview-container {
        position: relative;
        padding: 0 !important;
        height: 100%;
    }

    .icon-img {
        width: 35px;
        height: 35px;
    }

    .comment-profile{
        width: 25px;
        height: 25px;
    }

    #new-post-btn {
        bottom: 5%;
        right: 5%;
    }

    #review-book-info {
        position: absolute;
        z-index: 100;
        top: 1rem;
        left: 1rem;
        color: #FFFFFF;
        text-shadow:
                -2px 0px rgba(0, 0, 0, 0.5),
                0px 2px rgba(0, 0, 0, 0.5),
                2px 0px rgba(0, 0, 0, 0.5),
                0px -2px rgba(0, 0, 0, 0.5);
    }
    .modal-body {
        width: 100%;
    }

    #contents-wrap {
        width: 100%;
        max-height: 550px;
        overflow-y: scroll;
    }
    #contents-wrap::-webkit-scrollbar {
        width: 5px !important;
    }
    #contents-wrap::-webkit-scrollbar-thumb {
        height: 30%; /* 스크롤바의 길이 */
        background: #ddd; /* 스크롤바의 색상 */
        border-radius: 10px;
    }
    #contents-wrap::-webkit-scrollbar-track {
        background: #fff;  /*스크롤바 뒷 배경 색상*/
    }

    #my-comment-wrap {
        width: 100%;
    }

    #comment-area {
        flex: auto;
    }
    textarea {
        resize: none;
    }
    #comment-btn {
        padding: 5px;
        width: 70px;
    }
    #touritem-wrap {
        padding: 5px;
        position: absolute;
        z-index: 100;
        bottom: 3rem;
        left: 2rem;
    }
    .fa-location-dot{
        color: #000000;
        font-size: 25px;
    }
    #touritem-info {
        width: 15rem;
        position: absolute;
        bottom: -50%;
        right: 110%;
        display: none;
    }
    #touritem-info-title {
        margin-bottom: 0;
        font-size: 1.2rem;
        font-weight: 700;
    }
    #touritem-info-category {
        font-size: 0.8rem;
    }
    #touritem-name {
        font-size: 18px;
        color: #FFFFFF;
        text-shadow:
                -2px 0px rgba(0, 0, 0, 0.5),
                0px 2px rgba(0, 0, 0, 0.5),
                2px 0px rgba(0, 0, 0, 0.5),
                0px -2px rgba(0, 0, 0, 0.5);
    }

    #writer-info{
        cursor: pointer;
    }
    #writer-id {
        color: #999999;
    }

    #review-more-btn{
        display: inline-block;
        font: inherit;
        background: none;
        border: none;
        color: inherit;
        padding: 0;
        cursor: pointer;
    }

    /* swiper */
    .swiper {
        width: 100%;
        height: 750px;
        overflow: hidden;
    }

    .swiper-slide {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        font-size: 18px;
        color: #999999;
        background: #333333;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .swiper-slide img {
        display: block;
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
</style>
<div class="d-flex flex-nowrap">
    <th:block th:replace="~{fragments/sidebar}"></th:block>
    <div class="container">
        <div class="profile">
            <div class="profile-image">
                <img src="https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces" alt="">
            </div>

            <div class="profile-user-settings">
                <h1 class="profile-user-name" th:text="${findUser.name}"></h1>
                <th:block th:if="${findUser.id == loginUser.id}">
                    <button class="btn profile-edit-btn" onclick="location.href = '/editprofile'" >Edit Profile</button>
                    <button class="btn profile-settings-btn" aria-label="profile settings"><i class="fas fa-cog" aria-hidden="true"></i></button>
                </th:block>
            </div>

            <div class="profile-stats">
                <ul>
                    <li><span class="profile-stat-count">164</span> posts</li>
                    <li><span class="profile-stat-count">188</span> followers</li>
                    <li><span class="profile-stat-count">206</span> following</li>
                </ul>
            </div>

            <div class="profile-bio">
                <div class="profile-real-name" th:text="${findUser.id}"></div>
                <div th:text="${findUser.about}"></div>
            </div>
        </div>
        <!-- End of profile section -->
        <ul class="nav nav-underline mb-3 justify-content-center">
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" onclick="changeTab('review')">내 리뷰</a>
            </li>
            <li class="nav-item">
                <a class="nav-link">내 리뷰북</a>
            </li>
            <li class="nav-item">
                <a class="nav-link">관심 리뷰</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="changeTab('bookmark')">북마크</a>
            </li>
        </ul>

        <div class="gallery">
        </div>
        <!-- End of gallery -->

        <div id="load-point"></div>
        <div class="loader"></div>
    </div>
    <div id="viewer" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="true" tabindex="-1" aria-labelledby="viewerLabel" aria-hidden="true">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="preview-container col-md-7">
                            <div id="review-book-info" class="d-flex align-items-center">
                                <img id="review-book-cover" src="../assets/img/no_image.png" class="rounded-3 icon-img" alt="...">
                                <span id="review-book-title" class="ms-2">리뷰 북 타이틀</span>
                            </div>
                            <div id="touritem-wrap" class="d-flex align-items-center gap-2">
                                <div id="touritem-info" class="card">
                                    <img id="touritem-info-img" src="../assets/img/no_img.jpg" class="card-img-top" alt="...">
                                    <div class="card-body">
                                        <p id="touritem-info-title" class="card-text">관광지 이름</p>
                                        <p id="touritem-info-address" class="card-text">관광지 주소</p>
                                        <p id="touritem-info-category" class="card-text">관광지 카테고리</p>
                                    </div>
                                </div>
                                <i class="fa-solid fa-location-dot"></i>
                                <span id="touritem-name">관광지 이름</span>
                            </div>
                            <div class="swiper mySwiper">
                                <div class="swiper-wrapper">
                                    <div class="swiper-slide">사진을 추가해주세요.</div>
                                </div>
                                <div class="swiper-controller">
                                    <div class="swiper-button-next"></div>
                                    <div class="swiper-button-prev"></div>
                                    <div class="swiper-pagination"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5 d-flex align-items-start">
                            <div class="modal-body">
                                <div id="writer-wrap" class="mb-2 d-flex align-items-center justify-content-between">
                                    <div id="writer-info" class="d-flex align-items-center">
                                        <img id="writer-profile-img" src="../assets/img/profile.jpg" class="rounded-circle icon-img" alt="...">
                                        <strong id="writer-name" class="ms-2">작성자 이름</strong>
                                        <span id="writer-id" class="ms-2">@writerId</span>
                                    </div>
                                    <div class="btn-group">
                                        <button id="review-more-btn" type="button" class="btn dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-cog" aria-hidden="true"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a id="review-edit" class="dropdown-item" href="#">수정</a></li>
                                            <li><span id="review-delete" class="dropdown-item">삭제</span></li>
                                        </ul>
                                    </div>
                                </div>
                                <div id="contents-wrap" class="mb-3">
                                    <div id="content" class="mb-2">
                                    </div>
                                    <div id="comment-wrap">
                                        <div class="comment-info d-flex justify-content-start mb-1">
                                            <img src="../assets/img/profile.jpg" class="comment-profile rounded-circle icon-img" alt="...">
                                            <span class="comment-writer ms-2">댓글1</span>
                                            <span class="comment-text ms-4">우와~</span>
                                        </div>
                                        <div class="comment-info  d-flex justify-content-start mb-1">
                                            <img src="../assets/img/profile.jpg" class="comment-profile rounded-circle icon-img" alt="...">
                                            <span class="comment-writer ms-2">댓글2</span>
                                            <span class="comment-text ms-4">정말 데단해</span>
                                        </div>
                                    </div>
                                </div>
                                <div id="my-comment-wrap" class="d-flex align-items-start">
                                    <img id="login-user-profile-img" src="../assets/img/profile.jpg" class="rounded-circle icon-img" alt="...">
                                    <div id="comment-area" class="ms-2">
                                        <div id="login-user-name" class="mb-2">작성자 이름</div>
                                        <div class="d-flex gap-1">
                                            <textarea class="form-control"></textarea>
                                            <button id="comment-btn" type="button" class="btn btn-outline-secondary">등록</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <button type="button" id="new-post-btn" class="position-fixed rounded-pill btn btn-outline-primary">
        <i class="bi bi-plus-lg"></i>
    </button>

    <!-- End of container -->
</div>
<script th:inline="javascript">
    let savedFile = []; // 기존 저장된 이미지 파일의 id를 저장할 배열

    // swiper 설정
    var swiper = new Swiper(".mySwiper", {
        observer: true,
        observeParents: true,
        navigation: {
            nextEl: ".swiper-button-next",
            prevEl: ".swiper-button-prev",
        },
        pagination: {
            el: ".swiper-pagination",
        },
        mousewheel: true,
        keyboard: true,
    });
    function openViewer(reviewId) {
        let loginUserName = [[${loginUser.id}]] === 'anonymousUser' ? "로그인 후 이용해주세요." : [[${loginUser.id}]]
        let loginUserProfile = [[${loginUser.profileImg}]]
        $('#viewer').modal('show');
        $('#login-user-name').text(loginUserName);
        if(loginUserProfile != null){
            $('#login-user-profile-img').attr('src','/api/review-photo/' + loginUserProfile);
        }
        loadDetailReview(reviewId);
    }
    function loadDetailReview(reviewId){
        $.ajax({
            url : '/api/review/detail',
            type : 'GET',
            data : {
                reviewId : reviewId
            },
            contentType : 'application/json; charset=UTF-8',
            success : function (findReview) {
                let writer = findReview.userInfo;
                let photoList = findReview.reviewPhotoList;
                $('#writer-info').click(function (){
                    location.href = `/mypage/${writer.id}`
                })
                $('#writer-name').text(writer.name);
                $('#writer-id').text('@' + writer.id);
                if(writer.id === [[${loginUser.id}]]){
                    $('#writer-wrap .btn-group').addClass('d-flex').show();
                    $('#review-edit').attr('href',`../review/edit/${reviewId}`);
                    $('#review-delete').off('click').on('click', function (){
                        deleteReview(reviewId);
                    })
                }else {
                    $('#writer-wrap .btn-group').removeClass('d-flex').hide();
                }
                if(writer.profileImg != null){
                    $('#writer-profile-img').attr('src','/api/review-photo/' + writer.profileImg);
                }
                $('#content').html(findReview.reviewContent);
                if(findReview.reviewBookId == null){
                    $('#review-book-info').removeClass('d-flex').hide();
                }else {
                    $('#review-book-info').addClass('d-flex').show();
                    $('#review-book-title').text(findReview.reviewBookTitle);
                    if(findReview.reviewBookCoverImg != null){
                        $('#review-book-cover').attr('src','/api/review-photo/' + findReview.reviewBookCoverImg);
                    }
                }
                $('#touritem-name').text(findReview.tourItemTitle);
                $('#touritem-name').attr('data-touritem-id', findReview.tourItemId);
                $('.swiper-wrapper').html("");
                for(let photo of photoList){
                    savedFile.push(photo.fileId);
                    const tempHtml = `<div class="swiper-slide">` +
                        `<img class="preview-img" data-file-id="${photo.fileId}" src="/api/review-photo/${photo.filePath}" style="object-fit: contain"/>` +
                        `</div>`;
                    swiper.appendSlide(tempHtml);
                    swiper.update();
                }
                let fileLength = savedFile.length;
                if(fileLength > 1){
                    $('.swiper-controller').show()
                }else {
                    $('.swiper-controller').hide()
                };
            },
            error : function (){
                alert("리뷰 정보 조회에 실패했습니다.")
            }
        })
    }

    // 리뷰 뷰어에서 관광지 정보 조회
    let touritemInfoTimer;

    $('#touritem-wrap').mouseenter(function (){
        let tourItemId = $('#touritem-name').attr('data-touritem-id');
        if(tourItemId !== undefined){
            $('#touritem-wrap').css('cursor','pointer');
            $('#touritem-wrap').click(function (){
                location.href = `../info/content/${tourItemId}`;
            })
            touritemInfoTimer = setTimeout(function () {
                showTourItemSimpleInfo(tourItemId)
            },300)
        }
    })
    $('#touritem-wrap').mouseleave(function (){
        $('#touritem-wrap').css('cursor','');
        clearTimeout(touritemInfoTimer);
        $('#touritem-info').hide();
    })

    function showTourItemSimpleInfo(tourItemId){
        $.ajax({
            url : '/api/review/simple-touritem',
            type : 'GET',
            data : {
                tourItemId : tourItemId
            },
            contentType : 'application/json; charset=UTF-8',
            success : function (tourItem){
                $('#touritem-info-img').attr('src',tourItem.firstimage);
                $('#touritem-info-title').text(tourItem.title);
                $('#touritem-info-address').text(tourItem.address);
                $('#touritem-info-category').text(tourItem.fullCategoryName);
                $('#touritem-info').show();
            },
            error : function (err){
                console.log(err);
            }
        })
    }

    function deleteReview(reviewId){
        const deleteConfirm = confirm("리뷰를 삭제하시겠습니까?");
        if(deleteConfirm){
            $.ajax({
                url : '/api/review/delete',
                type : 'DELETE',
                data : {
                    reviewId : reviewId
                },
                success : function (){
                    alert('삭제 되었습니다.')
                    savePage();
                    $('#viewer').modal('toggle');
                    changeTab(tabType);
                    setScrollByMyPageInfo();
                },
                error : function (){
                    alert('삭제에 실패했습니다.')
                }
            })
        }
    }
</script>

<script th:inline="javascript">
    let scrollPage = 0; // 무한스크롤로 불러올 페이지
    let scrollCheck = false; // 페이지 데이터를 불러오는 중인지 여부
    let firstLoad = true; // 첫 로딩인지 체크
    let gallery = $('.gallery');
    let tabType = "review"; // 화면에 보여줄 탭
    let back = false;
    $(document).ready(function (){
        gallery.html("")
        observer.observe(document.getElementById('load-point'));
        $('#load-point').hide(); // 옵저버 관측 타이밍을 컨트롤하기 위해 hide
        loadPage();
        $('.swiper-controller').hide();
    })

    const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            // entry가 intersecting 중이 아니라면 함수를 실행하지 않음.
            if (!entry.isIntersecting) return;
            // 현재 페이지가 불러오는 중이면 함수를 실행하지 않음.
            if (scrollCheck) return;
            //옵저버 타겟 설정
            observer.observe(document.getElementById('load-point'));
            // 페이지를 불러오는 함수 호출.
            switch (tabType){
                case "bookmark" :
                    showBookmark();
                    break;
                case "review" :
                    showReview();
                    break
            }
        });
    });

    // 탭을 이동시 마다 변수 및 기존 화면 초기화(탭 이동시 마다 실행 해주세요.)
    function changeTab(type) {
        observer.disconnect()
        tabType = type;
        scrollPage = 0;
        scrollCheck = false;
        firstLoad = true;
        back = false;
        gallery.html("")
        // 옵저버 타겟 관측 시작
        observer.observe(document.getElementById('load-point'));
    }



    function showBookmark() {
        let time = 500;  // 페이지 로딩 시 로더를 일정시간 이상 보여주기 위한 시간 지정
        let loadScroll; // 다음 페이지 로딩 후에도 유지할 스크롤 위치를 저장할 변수
        if(firstLoad){
            firstLoad = false;
        }else {
            scrollPage += 1;
        }
        if(firstLoad || back) {
            time = 0;
            back = false;
        }
        $.ajax({
            url : '/api/bookmark',
            type : 'POST',
            contentType : 'application/json; charset=UTF-8',
            data : JSON.stringify({
                userId : [[${findUser.id}]],
                page : scrollPage
            }),
            async: false,
            success : function (response) {
                let bookmarkList = response.pageResponse.dtoList;
                // 로더를 일정시간 이상 노출하기 위한 setTimeout
                setTimeout(() => {
                    $(".loader").hide()
                    $.each(bookmarkList, function (index, bookmark){
                        let tempHtml = `<div class="gallery-item" tabIndex="0" onclick="savePage()">` +
                            `<a href="/info/content/${bookmark.contentid}">` +
                            `<img src="${bookmark.firstimage}"` +
                            `class="gallery-image" alt="">` +
                            `<div class="gallery-item-info d-flex">` +
                            `<div class="bookmark-info-wrap">` +
                            `<div class="bookmark-category">${bookmark.fullCategoryName}</div>` +
                            `<div class="bookmark-title"><strong>${bookmark.title}</strong></div>` +
                            `<div class="bookmark-address">${bookmark.address}</div>` +
                            `</div>` +
                            `</div>` +
                            `</a>` +
                            `</div>`
                        gallery.append(tempHtml).trigger("create")
                    })
                    window.scrollTo({top: loadScroll, behavior: "instant"});
                }, time)
                if(bookmarkList.length < 12){
                    // 다음페이지가 없다면 관측을 종료
                    observer.unobserve(document.getElementById('load-point'));
                }
            },
            error : function (err) {
                console.log(err)
            },
            beforeSend : function () {
                scrollCheck = true;
                $(".loader").show()
                loadScroll = window.scrollY;
            },
            complete : function () {
                scrollCheck = false;
            }
        })
    }

    function showReview() {
        let time = 500;  // 페이지 로딩 시 로더를 일정시간 이상 보여주기 위한 시간 지정
        let loadScroll; // 다음 페이지 로딩 후에도 유지할 스크롤 위치를 저장할 변수
        if(firstLoad){
            firstLoad = false;
        }else {
            scrollPage += 1;
        }
        if(firstLoad || back) {
            time = 0;
            back = false;
        }
        $.ajax({
            url : '/api/review/my-review',
            type : 'POST',
            contentType : 'application/json; charset=UTF-8',
            data : JSON.stringify({
                userId : [[${findUser.id}]],
                page : scrollPage
            }),
            async: false,
            success : function (response) {
                let reviewList = response.pageResponse.dtoList;
                // 로더를 일정시간 이상 노출하기 위한 setTimeout
                setTimeout(() => {
                    $(".loader").hide()
                    $.each(reviewList, function (index, review){
                        let tempHtml = `<div class="gallery-item" tabIndex="0" onclick="openViewer(${review.reviewId})">`
                        if(review.photoCount > 1){
                            tempHtml += '<div class="gallery-item-type">' +
                                '<i class="fas fa-clone" aria-hidden="true"></i>' +
                                '</div>'
                        }
                        tempHtml +=
                            `<img src="/api/review-photo/${review.firstPhoto.filePath}" class="gallery-image" alt="">` +
                            `<div class="gallery-item-info">` +
                            `<ul>` +
                            `<li class="gallery-item-likes"><span class="visually-hidden">Likes:</span><i class="fas fa-heart" aria-hidden="true"></i> ${review.likeCount}</li>` +
                            `<li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> ${review.commentCount}</li>` +
                            `</ul>` +
                            `</div>` +
                            `</div>` +
                            `</div>`;
                        gallery.append(tempHtml).trigger("create")
                    })
                    window.scrollTo({top: loadScroll, behavior: "instant"});
                }, time)
                if(reviewList.length < 12){
                    // 다음페이지가 없다면 관측을 종료
                    observer.unobserve(document.getElementById('load-point'));
                }
            },
            error : function (err) {
                console.log(err)
            },
            beforeSend : function () {
                scrollCheck = true;
                $(".loader").show()
                loadScroll = window.scrollY;
            },
            complete : function () {
                scrollCheck = false;
            }
        })
    }

    function savePage() {
        let myPageInfo = {};
        myPageInfo.tabType = tabType;
        myPageInfo.scrollPage = scrollPage;
        myPageInfo.scrollPosition = window.scrollY.toString();
        sessionStorage.setItem("myPageInfo", JSON.stringify(myPageInfo));
    }

    function setScrollByMyPageInfo(){
        let session_myPageInfo = JSON.parse(sessionStorage.getItem("myPageInfo"));
        let tabType = session_myPageInfo.tabType;
        let sessionPage = Number(session_myPageInfo.scrollPage);
        let scrollPosition = Number(session_myPageInfo.scrollPosition);
        changeTab(tabType)
        console.log(sessionPage);
        console.log(scrollPosition);
        for(let page = 0; page <= sessionPage; page++){
            back = true;
            console.log(`${scrollPage}, ${page}`);
            switch (tabType){
                case "bookmark":
                    showBookmark();
                    break;
                case "review":
                    showReview();
                    break;
                // 탭 메뉴의 타입을 추가하여 사용
            }
        }
        setTimeout(() => {
            var scrollBottom = $(document).height() - $(window).height() - $(window).scrollTop();
            if(scrollPosition > scrollBottom){
                window.scrollTo(0, scrollBottom);
            }else {
                window.scrollTo(0, scrollPosition);
            }
        }, 100);
        // sessionStorage.removeItem("myPageInfo");
        setTimeout(() => {
            $('#load-point').show();
        }, 550)
    }

    function loadPage() {
        window.addEventListener('pageshow', function (event) {
            if (event.persisted || (window.performance && window.performance.navigation.type == 2)) {
                if(sessionStorage.getItem("myPageInfo") != null){
                    // 다른페이지에서 뒤로가기로 돌아왔을 시 세션에 저장된 정보로 기존 위치로 이동
                    console.log("back")
                    setScrollByMyPageInfo();
                }else {
                    $('#load-point').show();
                }
            }else {
                // 그 외의 방법으로 페이지 접근 시 바로 타겟을 노출, 데이터 로딩
                if(sessionStorage.getItem("myPageInfo") != null){
                    sessionStorage.removeItem("myPageInfo");
                }
                $('#load-point').show();
            }
        });
    }

</script>

</body>
</html>